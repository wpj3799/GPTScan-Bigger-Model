

  .oooooo.    ooooooooo.   ooooooooooooo  .oooooo..o                                 
 d8P'  `Y8b   `888   `Y88. 8'   888   `8 d8P'    `Y8                                 
888            888   .d88'      888      Y88bo.       .ooooo.   .oooo.   ooo. .oo.   
888            888ooo88P'       888       `"Y8888o.  d88' `"Y8 `P  )88b  `888P"Y88b  
888     ooooo  888              888           `"Y88b 888        .oP"888   888   888  
`88.    .88'   888              888      oo     .d8P 888   .o8 d8(  888   888   888  
 `Y8bood8P'   o888o            o888o     8""88888P'  `Y8bod8P' `Y888""8o o888o o888o                                                        


                                                                   

[16:35:50] Loaded 10 rules                                                                                                                                                                                                                   tasks.py:119
[12/08/24 16:35:50] INFO     CryticCompile: 'npx hardhat clean' running (wd: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main)                                                                           subprocess.py:41
[12/08/24 16:35:51] INFO     CryticCompile: 'npx hardhat clean --global' running (wd: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main)                                                                  subprocess.py:41
[12/08/24 16:35:54] INFO     CryticCompile: 'npx hardhat compile --force' running (wd: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main)                                                                 subprocess.py:41
[12/08/24 16:35:55] ERROR    CryticCompile: 'npx' returned non-zero exit code 1                                                                                                                                                          subprocess.py:60
                    ERROR    CryticCompile: Error HH411: The library @openzeppelin/contracts, imported from contracts/external/Views.sol, is not installed. Try installing it using npm.                                                 subprocess.py:68
                             stderr: For more info go to https://hardhat.org/HH411 or run Hardhat with --show-stack-traces                                                                                                                               
[16:35:55] Traceback (most recent call last):                                                                                                                                                                                                tasks.py:126
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/falcon/falcon.py", line 90, in __init__                                                                                                           
               crytic_compile = CryticCompile(target, **kwargs)                                                                                                                                                                                          
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/crytic_compile.py", line 131, in __init__                                                                                          
               self._compile(**kwargs)                                                                                                                                                                                                                   
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/crytic_compile.py", line 553, in _compile                                                                                          
               self._platform.compile(self, **kwargs)                                                                                                                                                                                                    
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/platform/hardhat.py", line 183, in compile                                                                                         
               hardhat_like_parsing(crytic_compile, self._target, build_directory, hardhat_working_dir)                                                                                                                                                  
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/platform/hardhat.py", line 52, in hardhat_like_parsing                                                                             
               raise InvalidCompilation(txt)                                                                                                                                                                                                             
           crytic_compile.platform.exceptions.InvalidCompilation: Compilation failed. Can you run build command?                                                                                                                                         
           /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/artifacts/build-info is not a directory.                                                                                                                     
                                                                                                                                                                                                                                                         
           During handling of the above exception, another exception occurred:                                                                                                                                                                           
                                                                                                                                                                                                                                                         
           Traceback (most recent call last):                                                                                                                                                                                                            
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 124, in simple_cli                                                                                                                                               
               falcon_instance = compile_project(source_dir)                                                                                                                                                                                             
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 103, in compile_project                                                                                                                                          
               return falcon.Falcon(abs_path)                                                                                                                                                                                                            
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/falcon/falcon.py", line 94, in __init__                                                                                                           
               raise FalconError(f"Invalid compilation: \n{str(e)}")                                                                                                                                                                                     
           falcon.exceptions.FalconError: Invalid compilation:                                                                                                                                                                                           
           Compilation failed. Can you run build command?                                                                                                                                                                                                
           /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/artifacts/build-info is not a directory.                                                                                                                     
                                                                                                                                                                                                                                                         
           Compile failed.                                                                                                                                                                                                                   tasks.py:127
           Since the compilation is failed, some static analysis tool may not be enabled, which may cause lower precision and recall.                                                                                                        tasks.py:128
[12/08/24 16:35:58] INFO     antlr4helper.callgraph: In whitelist: Proxy._delegate(address) returns()                                                                                                                                     callgraph.py:21
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function getStoredNTokenSupplyFactors(address tokenAddress)                                                                                                                                                                                       │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         bytes32 slot = keccak256(abi.encode(tokenAddress, Constants.NTOKEN_TOTAL_SUPPLY_OFFSET));                                                                                                                                                     │
│         bytes32 data;                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                       │
│         assembly {                                                                                                                                                                                                                                    │
│             data := sload(slot)                                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         totalSupply = uint256(uint96(uint256(data)));                                                                                                                                                                                                 │
│         // NOTE: DO NOT USE THIS RETURNED VALUE FOR CALCULATING INCENTIVES. The integral total supply                                                                                                                                                 │
│         // must be updated given the block time. Use `calculateIntegralTotalSupply` instead                                                                                                                                                           │
│         integralTotalSupply = uint256(uint128(uint256(data >> 96)));                                                                                                                                                                                  │
│         lastSupplyChangeTime = uint256(data >> 224);                                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function loadNTokenPortfolioNoCashGroup(uint256 currencyId, nTokenPortfolio memory nToken)                                                                                                                                                        │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│     {                                                                                                                                                                                                                                                 │
│         nToken.tokenAddress = nTokenAddress(currencyId);                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             /* currencyId */,                                                                                                                                                                                                                         │
│             /* incentiveRate */,                                                                                                                                                                                                                      │
│             uint256 lastInitializedTime,                                                                                                                                                                                                              │
│             bytes6 parameters                                                                                                                                                                                                                         │
│         ) = getNTokenContext(nToken.tokenAddress);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                       │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             /* integralTotalSupply */,                                                                                                                                                                                                                │
│             /* lastSupplyChangeTime */                                                                                                                                                                                                                │
│         ) = getStoredNTokenSupplyFactors(nToken.tokenAddress);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│         nToken.lastInitializedTime = lastInitializedTime;                                                                                                                                                                                             │
│         nToken.totalSupply = int256(totalSupply);                                                                                                                                                                                                     │
│         nToken.parameters = parameters;                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                       │
│         nToken.portfolioState = PortfolioHandler.buildPortfolioState(                                                                                                                                                                                 │
│             nToken.tokenAddress,                                                                                                                                                                                                                      │
│             uint8(parameters[Constants.ASSET_ARRAY_LENGTH]),                                                                                                                                                                                          │
│             0                                                                                                                                                                                                                                         │
│         );                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                       │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             nToken.cashBalance,                                                                                                                                                                                                                       │
│             /* nTokenBalance */,                                                                                                                                                                                                                      │
│             /* lastClaimTime */,                                                                                                                                                                                                                      │
│             /* lastClaimIntegralSupply */                                                                                                                                                                                                             │
│         ) = BalanceHandler.getBalanceStorage(nToken.tokenAddress, currencyId);                                                                                                                                                                        │
│     }                                                                                                                                                                                                                                                 │
│     function getStoredNTokenSupplyFactors(address tokenAddress)                                                                                                                                                                                       │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         bytes32 slot = keccak256(abi.encode(tokenAddress, Constants.NTOKEN_TOTAL_SUPPLY_OFFSET));                                                                                                                                                     │
│         bytes32 data;                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                       │
│         assembly {                                                                                                                                                                                                                                    │
│             data := sload(slot)                                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         totalSupply = uint256(uint96(uint256(data)));                                                                                                                                                                                                 │
│         // NOTE: DO NOT USE THIS RETURNED VALUE FOR CALCULATING INCENTIVES. The integral total supply                                                                                                                                                 │
│         // must be updated given the block time. Use `calculateIntegralTotalSupply` instead                                                                                                                                                           │
│         integralTotalSupply = uint256(uint128(uint256(data >> 96)));                                                                                                                                                                                  │
│         lastSupplyChangeTime = uint256(data >> 224);                                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function calculateIntegralTotalSupply(address tokenAddress, uint256 blockTime)                                                                                                                                                                    │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         (                                                                                                                                                                                                                                             │
│             totalSupply,                                                                                                                                                                                                                              │
│             integralTotalSupply,                                                                                                                                                                                                                      │
│             lastSupplyChangeTime                                                                                                                                                                                                                      │
│         ) = getStoredNTokenSupplyFactors(tokenAddress);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                       │
│         // Initialize last supply change time if it has not been set.                                                                                                                                                                                 │
│         if (lastSupplyChangeTime == 0) lastSupplyChangeTime = blockTime;                                                                                                                                                                              │
│                                                                                                                                                                                                                                                       │
│         require(blockTime >= lastSupplyChangeTime); // dev: invalid block time                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│         // Add to the integral total supply the total supply of tokens multiplied by the time that the total supply                                                                                                                                   │
│         // has been the value. This will part of the numerator for the average total supply calculation during                                                                                                                                        │
│         // minting incentives.                                                                                                                                                                                                                        │
│         integralTotalSupply = uint256(int256(integralTotalSupply).add(                                                                                                                                                                                │
│             int256(totalSupply).mul(int256(blockTime - lastSupplyChangeTime))                                                                                                                                                                         │
│         ));                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                       │
│         require(integralTotalSupply >= 0 && integralTotalSupply < type(uint128).max); // dev: integral total supply overflow                                                                                                                          │
│         require(blockTime < type(uint32).max); // dev: last supply change supply overflow                                                                                                                                                             │
│     }                                                                                                                                                                                                                                                 │
│     function getStoredNTokenSupplyFactors(address tokenAddress)                                                                                                                                                                                       │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         bytes32 slot = keccak256(abi.encode(tokenAddress, Constants.NTOKEN_TOTAL_SUPPLY_OFFSET));                                                                                                                                                     │
│         bytes32 data;                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                       │
│         assembly {                                                                                                                                                                                                                                    │
│             data := sload(slot)                                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         totalSupply = uint256(uint96(uint256(data)));                                                                                                                                                                                                 │
│         // NOTE: DO NOT USE THIS RETURNED VALUE FOR CALCULATING INCENTIVES. The integral total supply                                                                                                                                                 │
│         // must be updated given the block time. Use `calculateIntegralTotalSupply` instead                                                                                                                                                           │
│         integralTotalSupply = uint256(uint128(uint256(data >> 96)));                                                                                                                                                                                  │
│         lastSupplyChangeTime = uint256(data >> 224);                                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                                │
│ Code:                                                                                                                                                                                                                                                 │
│     function calculateIntegralTotalSupply(address tokenAddress, uint256 blockTime)                                                                                                                                                                    │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         (                                                                                                                                                                                                                                             │
│             totalSupply,                                                                                                                                                                                                                              │
│             integralTotalSupply,                                                                                                                                                                                                                      │
│             lastSupplyChangeTime                                                                                                                                                                                                                      │
│         ) = getStoredNTokenSupplyFactors(tokenAddress);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                       │
│         // Initialize last supply change time if it has not been set.                                                                                                                                                                                 │
│         if (lastSupplyChangeTime == 0) lastSupplyChangeTime = blockTime;                                                                                                                                                                              │
│                                                                                                                                                                                                                                                       │
│         require(blockTime >= lastSupplyChangeTime); // dev: invalid block time                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│         // Add to the integral total supply the total supply of tokens multiplied by the time that the total supply                                                                                                                                   │
│         // has been the value. This will part of the numerator for the average total supply calculation during                                                                                                                                        │
│         // minting incentives.                                                                                                                                                                                                                        │
│         integralTotalSupply = uint256(int256(integralTotalSupply).add(                                                                                                                                                                                │
│             int256(totalSupply).mul(int256(blockTime - lastSupplyChangeTime))                                                                                                                                                                         │
│         ));                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                       │
│         require(integralTotalSupply >= 0 && integralTotalSupply < type(uint128).max); // dev: integral total supply overflow                                                                                                                          │
│         require(blockTime < type(uint32).max); // dev: last supply change supply overflow                                                                                                                                                             │
│     }                                                                                                                                                                                                                                                 │
│     function getStoredNTokenSupplyFactors(address tokenAddress)                                                                                                                                                                                       │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         bytes32 slot = keccak256(abi.encode(tokenAddress, Constants.NTOKEN_TOTAL_SUPPLY_OFFSET));                                                                                                                                                     │
│         bytes32 data;                                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                       │
│         assembly {                                                                                                                                                                                                                                    │
│             data := sload(slot)                                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         totalSupply = uint256(uint96(uint256(data)));                                                                                                                                                                                                 │
│         // NOTE: DO NOT USE THIS RETURNED VALUE FOR CALCULATING INCENTIVES. The integral total supply                                                                                                                                                 │
│         // must be updated given the block time. Use `calculateIntegralTotalSupply` instead                                                                                                                                                           │
│         integralTotalSupply = uint256(uint128(uint256(data >> 96)));                                                                                                                                                                                  │
│         lastSupplyChangeTime = uint256(data >> 224);                                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                                    │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function calculateIntegralTotalSupply(address tokenAddress, uint256 blockTime)                                                                                                                                                                    │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         (                                                                                                                                                                                                                                             │
│             totalSupply,                                                                                                                                                                                                                              │
│             integralTotalSupply,                                                                                                                                                                                                                      │
│             lastSupplyChangeTime                                                                                                                                                                                                                      │
│         ) = getStoredNTokenSupplyFactors(tokenAddress);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                       │
│         // Initialize last supply change time if it has not been set.                                                                                                                                                                                 │
│         if (lastSupplyChangeTime == 0) lastSupplyChangeTime = blockTime;                                                                                                                                                                              │
│                                                                                                                                                                                                                                                       │
│         require(blockTime >= lastSupplyChangeTime); // dev: invalid block time                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│         // Add to the integral total supply the total supply of tokens multiplied by the time that the total supply                                                                                                                                   │
│         // has been the value. This will part of the numerator for the average total supply calculation during                                                                                                                                        │
│         // minting incentives.                                                                                                                                                                                                                        │
│         integralTotalSupply = uint256(int256(integralTotalSupply).add(                                                                                                                                                                                │
│             int256(totalSupply).mul(int256(blockTime - lastSupplyChangeTime))                                                                                                                                                                         │
│         ));                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                       │
│         require(integralTotalSupply >= 0 && integralTotalSupply < type(uint128).max); // dev: integral total supply overflow                                                                                                                          │
│         require(blockTime < type(uint32).max); // dev: last supply change supply overflow                                                                                                                                                             │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function changeNTokenSupply(                                                                                                                                                                                                                      │
│         address tokenAddress,                                                                                                                                                                                                                         │
│         int256 netChange,                                                                                                                                                                                                                             │
│         uint256 blockTime                                                                                                                                                                                                                             │
│     ) internal returns (uint256) {                                                                                                                                                                                                                    │
│         (                                                                                                                                                                                                                                             │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             /* uint256 lastSupplyChangeTime */                                                                                                                                                                                                        │
│         ) = calculateIntegralTotalSupply(tokenAddress, blockTime);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                       │
│         if (netChange != 0) {                                                                                                                                                                                                                         │
│             bytes32 slot = keccak256(abi.encode(tokenAddress, Constants.NTOKEN_TOTAL_SUPPLY_OFFSET));                                                                                                                                                 │
│             // If the totalSupply will change then we store the new total supply, the integral total supply and the                                                                                                                                   │
│             // current block time. We know that this int256 conversion will not overflow because totalSupply is stored                                                                                                                                │
│             // as a uint96 and checked in the next line.                                                                                                                                                                                              │
│             int256 newTotalSupply = int256(totalSupply).add(netChange);                                                                                                                                                                               │
│             require(newTotalSupply >= 0 && uint256(newTotalSupply) < type(uint96).max); // dev: nToken supply overflow                                                                                                                                │
│                                                                                                                                                                                                                                                       │
│             bytes32 newData = (                                                                                                                                                                                                                       │
│                 (bytes32(uint256(newTotalSupply))) |                                                                                                                                                                                                  │
│                 (bytes32(integralTotalSupply << 96)) |                                                                                                                                                                                                │
│                 (bytes32(blockTime << 224))                                                                                                                                                                                                           │
│             );                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│             assembly {                                                                                                                                                                                                                                │
│                 sstore(slot, newData)                                                                                                                                                                                                                 │
│             }                                                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         return integralTotalSupply;                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                                 │
│     function calculateIntegralTotalSupply(address tokenAddress, uint256 blockTime)                                                                                                                                                                    │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (                                                                                                                                                                                                                                     │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             uint256 lastSupplyChangeTime                                                                                                                                                                                                              │
│         )                                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                                 │
│         (                                                                                                                                                                                                                                             │
│             totalSupply,                                                                                                                                                                                                                              │
│             integralTotalSupply,                                                                                                                                                                                                                      │
│             lastSupplyChangeTime                                                                                                                                                                                                                      │
│         ) = getStoredNTokenSupplyFactors(tokenAddress);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                       │
│         // Initialize last supply change time if it has not been set.                                                                                                                                                                                 │
│         if (lastSupplyChangeTime == 0) lastSupplyChangeTime = blockTime;                                                                                                                                                                              │
│                                                                                                                                                                                                                                                       │
│         require(blockTime >= lastSupplyChangeTime); // dev: invalid block time                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│         // Add to the integral total supply the total supply of tokens multiplied by the time that the total supply                                                                                                                                   │
│         // has been the value. This will part of the numerator for the average total supply calculation during                                                                                                                                        │
│         // minting incentives.                                                                                                                                                                                                                        │
│         integralTotalSupply = uint256(int256(integralTotalSupply).add(                                                                                                                                                                                │
│             int256(totalSupply).mul(int256(blockTime - lastSupplyChangeTime))                                                                                                                                                                         │
│         ));                                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                                       │
│         require(integralTotalSupply >= 0 && integralTotalSupply < type(uint128).max); // dev: integral total supply overflow                                                                                                                          │
│         require(blockTime < type(uint32).max); // dev: last supply change supply overflow                                                                                                                                                             │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function changeNTokenSupply(                                                                                                                                                                                                                      │
│         address tokenAddress,                                                                                                                                                                                                                         │
│         int256 netChange,                                                                                                                                                                                                                             │
│         uint256 blockTime                                                                                                                                                                                                                             │
│     ) internal returns (uint256) {                                                                                                                                                                                                                    │
│         (                                                                                                                                                                                                                                             │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             uint256 integralTotalSupply,                                                                                                                                                                                                              │
│             /* uint256 lastSupplyChangeTime */                                                                                                                                                                                                        │
│         ) = calculateIntegralTotalSupply(tokenAddress, blockTime);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                       │
│         if (netChange != 0) {                                                                                                                                                                                                                         │
│             bytes32 slot = keccak256(abi.encode(tokenAddress, Constants.NTOKEN_TOTAL_SUPPLY_OFFSET));                                                                                                                                                 │
│             // If the totalSupply will change then we store the new total supply, the integral total supply and the                                                                                                                                   │
│             // current block time. We know that this int256 conversion will not overflow because totalSupply is stored                                                                                                                                │
│             // as a uint96 and checked in the next line.                                                                                                                                                                                              │
│             int256 newTotalSupply = int256(totalSupply).add(netChange);                                                                                                                                                                               │
│             require(newTotalSupply >= 0 && uint256(newTotalSupply) < type(uint96).max); // dev: nToken supply overflow                                                                                                                                │
│                                                                                                                                                                                                                                                       │
│             bytes32 newData = (                                                                                                                                                                                                                       │
│                 (bytes32(uint256(newTotalSupply))) |                                                                                                                                                                                                  │
│                 (bytes32(integralTotalSupply << 96)) |                                                                                                                                                                                                │
│                 (bytes32(blockTime << 224))                                                                                                                                                                                                           │
│             );                                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│             assembly {                                                                                                                                                                                                                                │
│                 sstore(slot, newData)                                                                                                                                                                                                                 │
│             }                                                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         return integralTotalSupply;                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function loadNTokenPortfolioNoCashGroup(uint256 currencyId, nTokenPortfolio memory nToken)                                                                                                                                                        │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│     {                                                                                                                                                                                                                                                 │
│         nToken.tokenAddress = nTokenAddress(currencyId);                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             /* currencyId */,                                                                                                                                                                                                                         │
│             /* incentiveRate */,                                                                                                                                                                                                                      │
│             uint256 lastInitializedTime,                                                                                                                                                                                                              │
│             bytes6 parameters                                                                                                                                                                                                                         │
│         ) = getNTokenContext(nToken.tokenAddress);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                                       │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             uint256 totalSupply,                                                                                                                                                                                                                      │
│             /* integralTotalSupply */,                                                                                                                                                                                                                │
│             /* lastSupplyChangeTime */                                                                                                                                                                                                                │
│         ) = getStoredNTokenSupplyFactors(nToken.tokenAddress);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                                       │
│         nToken.lastInitializedTime = lastInitializedTime;                                                                                                                                                                                             │
│         nToken.totalSupply = int256(totalSupply);                                                                                                                                                                                                     │
│         nToken.parameters = parameters;                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                                       │
│         nToken.portfolioState = PortfolioHandler.buildPortfolioState(                                                                                                                                                                                 │
│             nToken.tokenAddress,                                                                                                                                                                                                                      │
│             uint8(parameters[Constants.ASSET_ARRAY_LENGTH]),                                                                                                                                                                                          │
│             0                                                                                                                                                                                                                                         │
│         );                                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                                       │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             nToken.cashBalance,                                                                                                                                                                                                                       │
│             /* nTokenBalance */,                                                                                                                                                                                                                      │
│             /* lastClaimTime */,                                                                                                                                                                                                                      │
│             /* lastClaimIntegralSupply */                                                                                                                                                                                                             │
│         ) = BalanceHandler.getBalanceStorage(nToken.tokenAddress, currencyId);                                                                                                                                                                        │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                          │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                                      │
│ Code:                                                                                                                                                                                                                                                 │
│     function getNTokenAssetPV(nTokenPortfolio memory nToken, uint256 blockTime)                                                                                                                                                                       │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (int256, bytes32)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                                 │
│         int256 totalAssetPV;                                                                                                                                                                                                                          │
│         int256 totalUnderlyingPV;                                                                                                                                                                                                                     │
│         bytes32 ifCashBitmap =                                                                                                                                                                                                                        │
│             BitmapAssetsHandler.getAssetsBitmap(nToken.tokenAddress, nToken.cashGroup.currencyId);                                                                                                                                                    │
│                                                                                                                                                                                                                                                       │
│         {                                                                                                                                                                                                                                             │
│             uint256 nextSettleTime = getNextSettleTime(nToken);                                                                                                                                                                                       │
│             // If the first asset maturity has passed (the 3 month), this means that all the LTs must                                                                                                                                                 │
│             // be settled except the 6 month (which is now the 3 month). We don't settle LTs except in                                                                                                                                                │
│             // initialize markets so we calculate the cash value of the portfolio here.                                                                                                                                                               │
│             if (nextSettleTime <= blockTime) {                                                                                                                                                                                                        │
│                 // NOTE: this condition should only be present for a very short amount of time, which is the window between                                                                                                                           │
│                 // when the markets are no longer tradable at quarter end and when the new markets have been initialized.                                                                                                                             │
│                 // We time travel back to one second before maturity to value the liquidity tokens. Although this value is                                                                                                                            │
│                 // not strictly correct the different should be quite slight. We do this to ensure that free collateral checks                                                                                                                        │
│                 // for withdraws and liquidations can still be processed. If this condition persists for a long period of time then                                                                                                                   │
│                 // the entire protocol will have serious problems as markets will not be tradable.                                                                                                                                                    │
│                 blockTime = nextSettleTime - 1;                                                                                                                                                                                                       │
│             }                                                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         // Since we are not doing a risk adjusted valuation here we do not need to net off residual fCash                                                                                                                                             │
│         // balances in the future before discounting to present. If we did, then the ifCash assets would                                                                                                                                              │
│         // have to be in the portfolio array first. PV here is denominated in asset cash terms, not in                                                                                                                                                │
│         // underlying terms.                                                                                                                                                                                                                          │
│         {                                                                                                                                                                                                                                             │
│             MarketParameters memory market;                                                                                                                                                                                                           │
│             for (uint256 i; i < nToken.portfolioState.storedAssets.length; i++) {                                                                                                                                                                     │
│                 // NOTE: getLiquidityTokenValue can rewrite fCash values in memory, however, that does not                                                                                                                                            │
│                 // happen in this call because there are no fCash values in the nToken portfolio.                                                                                                                                                     │
│                 (int256 assetCashClaim, int256 pv) =                                                                                                                                                                                                  │
│                     AssetHandler.getLiquidityTokenValue(                                                                                                                                                                                              │
│                         i,                                                                                                                                                                                                                            │
│                         nToken.cashGroup,                                                                                                                                                                                                             │
│                         market,                                                                                                                                                                                                                       │
│                         nToken.portfolioState.storedAssets,                                                                                                                                                                                           │
│                         blockTime,                                                                                                                                                                                                                    │
│                         false                                                                                                                                                                                                                         │
│                     );                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                       │
│                 totalAssetPV = totalAssetPV.add(assetCashClaim);                                                                                                                                                                                      │
│                 totalUnderlyingPV = totalUnderlyingPV.add(pv);                                                                                                                                                                                        │
│             }                                                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         // Then iterate over bitmapped assets and get present value                                                                                                                                                                                   │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             int256 bitmapPv,                                                                                                                                                                                                                          │
│             /* */                                                                                                                                                                                                                                     │
│         ) = BitmapAssetsHandler.getifCashNetPresentValue(                                                                                                                                                                                             │
│             nToken.tokenAddress,                                                                                                                                                                                                                      │
│             nToken.cashGroup.currencyId,                                                                                                                                                                                                              │
│             nToken.lastInitializedTime,                                                                                                                                                                                                               │
│             blockTime,                                                                                                                                                                                                                                │
│             ifCashBitmap,                                                                                                                                                                                                                             │
│             nToken.cashGroup,                                                                                                                                                                                                                         │
│             false                                                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                                                            │
│         totalUnderlyingPV = totalUnderlyingPV.add(bitmapPv);                                                                                                                                                                                          │
│                                                                                                                                                                                                                                                       │
│         // Return the total present value denominated in asset terms                                                                                                                                                                                  │
│         totalAssetPV = totalAssetPV                                                                                                                                                                                                                   │
│             .add(nToken.cashGroup.assetRate.convertFromUnderlying(totalUnderlyingPV))                                                                                                                                                                 │
│             .add(nToken.cashBalance);                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                       │
│         return (totalAssetPV, ifCashBitmap);                                                                                                                                                                                                          │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                               │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                                │
│ Code:                                                                                                                                                                                                                                                 │
│     function getNTokenAssetPV(nTokenPortfolio memory nToken, uint256 blockTime)                                                                                                                                                                       │
│         internal                                                                                                                                                                                                                                      │
│         view                                                                                                                                                                                                                                          │
│         returns (int256, bytes32)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                                 │
│         int256 totalAssetPV;                                                                                                                                                                                                                          │
│         int256 totalUnderlyingPV;                                                                                                                                                                                                                     │
│         bytes32 ifCashBitmap =                                                                                                                                                                                                                        │
│             BitmapAssetsHandler.getAssetsBitmap(nToken.tokenAddress, nToken.cashGroup.currencyId);                                                                                                                                                    │
│                                                                                                                                                                                                                                                       │
│         {                                                                                                                                                                                                                                             │
│             uint256 nextSettleTime = getNextSettleTime(nToken);                                                                                                                                                                                       │
│             // If the first asset maturity has passed (the 3 month), this means that all the LTs must                                                                                                                                                 │
│             // be settled except the 6 month (which is now the 3 month). We don't settle LTs except in                                                                                                                                                │
│             // initialize markets so we calculate the cash value of the portfolio here.                                                                                                                                                               │
│             if (nextSettleTime <= blockTime) {                                                                                                                                                                                                        │
│                 // NOTE: this condition should only be present for a very short amount of time, which is the window between                                                                                                                           │
│                 // when the markets are no longer tradable at quarter end and when the new markets have been initialized.                                                                                                                             │
│                 // We time travel back to one second before maturity to value the liquidity tokens. Although this value is                                                                                                                            │
│                 // not strictly correct the different should be quite slight. We do this to ensure that free collateral checks                                                                                                                        │
│                 // for withdraws and liquidations can still be processed. If this condition persists for a long period of time then                                                                                                                   │
│                 // the entire protocol will have serious problems as markets will not be tradable.                                                                                                                                                    │
│                 blockTime = nextSettleTime - 1;                                                                                                                                                                                                       │
│             }                                                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         // Since we are not doing a risk adjusted valuation here we do not need to net off residual fCash                                                                                                                                             │
│         // balances in the future before discounting to present. If we did, then the ifCash assets would                                                                                                                                              │
│         // have to be in the portfolio array first. PV here is denominated in asset cash terms, not in                                                                                                                                                │
│         // underlying terms.                                                                                                                                                                                                                          │
│         {                                                                                                                                                                                                                                             │
│             MarketParameters memory market;                                                                                                                                                                                                           │
│             for (uint256 i; i < nToken.portfolioState.storedAssets.length; i++) {                                                                                                                                                                     │
│                 // NOTE: getLiquidityTokenValue can rewrite fCash values in memory, however, that does not                                                                                                                                            │
│                 // happen in this call because there are no fCash values in the nToken portfolio.                                                                                                                                                     │
│                 (int256 assetCashClaim, int256 pv) =                                                                                                                                                                                                  │
│                     AssetHandler.getLiquidityTokenValue(                                                                                                                                                                                              │
│                         i,                                                                                                                                                                                                                            │
│                         nToken.cashGroup,                                                                                                                                                                                                             │
│                         market,                                                                                                                                                                                                                       │
│                         nToken.portfolioState.storedAssets,                                                                                                                                                                                           │
│                         blockTime,                                                                                                                                                                                                                    │
│                         false                                                                                                                                                                                                                         │
│                     );                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                                       │
│                 totalAssetPV = totalAssetPV.add(assetCashClaim);                                                                                                                                                                                      │
│                 totalUnderlyingPV = totalUnderlyingPV.add(pv);                                                                                                                                                                                        │
│             }                                                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                             │
│                                                                                                                                                                                                                                                       │
│         // Then iterate over bitmapped assets and get present value                                                                                                                                                                                   │
│         // prettier-ignore                                                                                                                                                                                                                            │
│         (                                                                                                                                                                                                                                             │
│             int256 bitmapPv,                                                                                                                                                                                                                          │
│             /* */                                                                                                                                                                                                                                     │
│         ) = BitmapAssetsHandler.getifCashNetPresentValue(                                                                                                                                                                                             │
│             nToken.tokenAddress,                                                                                                                                                                                                                      │
│             nToken.cashGroup.currencyId,                                                                                                                                                                                                              │
│             nToken.lastInitializedTime,                                                                                                                                                                                                               │
│             blockTime,                                                                                                                                                                                                                                │
│             ifCashBitmap,                                                                                                                                                                                                                             │
│             nToken.cashGroup,                                                                                                                                                                                                                         │
│             false                                                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                                                            │
│         totalUnderlyingPV = totalUnderlyingPV.add(bitmapPv);                                                                                                                                                                                          │
│                                                                                                                                                                                                                                                       │
│         // Return the total present value denominated in asset terms                                                                                                                                                                                  │
│         totalAssetPV = totalAssetPV                                                                                                                                                                                                                   │
│             .add(nToken.cashGroup.assetRate.convertFromUnderlying(totalUnderlyingPV))                                                                                                                                                                 │
│             .add(nToken.cashBalance);                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                                       │
│         return (totalAssetPV, ifCashBitmap);                                                                                                                                                                                                          │
│     }                                                                                                                                                                                                                                                 │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function loadMarket(                                                                                                                                                                                                                     │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view {                                                                                                                                                                                                                        │
│         require(marketIndex > 0 && marketIndex <= cashGroup.maxMarketIndex, "Invalid market");                                                                                                                                               │
│         uint256 maturity =                                                                                                                                                                                                                   │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         market.loadMarket(                                                                                                                                                                                                                   │
│             cashGroup.currencyId,                                                                                                                                                                                                            │
│             maturity,                                                                                                                                                                                                                        │
│             blockTime,                                                                                                                                                                                                                       │
│             needsLiquidity,                                                                                                                                                                                                                  │
│             getRateOracleTimeWindow(cashGroup)                                                                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function loadMarket(                                                                                                                                                                                                                     │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view {                                                                                                                                                                                                                        │
│         require(marketIndex > 0 && marketIndex <= cashGroup.maxMarketIndex, "Invalid market");                                                                                                                                               │
│         uint256 maturity =                                                                                                                                                                                                                   │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         market.loadMarket(                                                                                                                                                                                                                   │
│             cashGroup.currencyId,                                                                                                                                                                                                            │
│             maturity,                                                                                                                                                                                                                        │
│             blockTime,                                                                                                                                                                                                                       │
│             needsLiquidity,                                                                                                                                                                                                                  │
│             getRateOracleTimeWindow(cashGroup)                                                                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function loadMarket(                                                                                                                                                                                                                     │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view {                                                                                                                                                                                                                        │
│         require(marketIndex > 0 && marketIndex <= cashGroup.maxMarketIndex, "Invalid market");                                                                                                                                               │
│         uint256 maturity =                                                                                                                                                                                                                   │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         market.loadMarket(                                                                                                                                                                                                                   │
│             cashGroup.currencyId,                                                                                                                                                                                                            │
│             maturity,                                                                                                                                                                                                                        │
│             blockTime,                                                                                                                                                                                                                       │
│             needsLiquidity,                                                                                                                                                                                                                  │
│             getRateOracleTimeWindow(cashGroup)                                                                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function loadMarket(                                                                                                                                                                                                                     │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view {                                                                                                                                                                                                                        │
│         require(marketIndex > 0 && marketIndex <= cashGroup.maxMarketIndex, "Invalid market");                                                                                                                                               │
│         uint256 maturity =                                                                                                                                                                                                                   │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         market.loadMarket(                                                                                                                                                                                                                   │
│             cashGroup.currencyId,                                                                                                                                                                                                            │
│             maturity,                                                                                                                                                                                                                        │
│             blockTime,                                                                                                                                                                                                                       │
│             needsLiquidity,                                                                                                                                                                                                                  │
│             getRateOracleTimeWindow(cashGroup)                                                                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function loadMarket(                                                                                                                                                                                                                     │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view {                                                                                                                                                                                                                        │
│         require(marketIndex > 0 && marketIndex <= cashGroup.maxMarketIndex, "Invalid market");                                                                                                                                               │
│         uint256 maturity =                                                                                                                                                                                                                   │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         market.loadMarket(                                                                                                                                                                                                                   │
│             cashGroup.currencyId,                                                                                                                                                                                                            │
│             maturity,                                                                                                                                                                                                                        │
│             blockTime,                                                                                                                                                                                                                       │
│             needsLiquidity,                                                                                                                                                                                                                  │
│             getRateOracleTimeWindow(cashGroup)                                                                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateOracleRate(                                                                                                                                                                                                            │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (uint256) {                                                                                                                                                                                                      │
│         (uint256 marketIndex, bool idiosyncratic) =                                                                                                                                                                                          │
│             DateTime.getMarketIndex(cashGroup.maxMarketIndex, maturity, blockTime);                                                                                                                                                          │
│         uint256 timeWindow = getRateOracleTimeWindow(cashGroup);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         if (!idiosyncratic) {                                                                                                                                                                                                                │
│             return Market.getOracleRate(cashGroup.currencyId, maturity, timeWindow, blockTime);                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 longMaturity =                                                                                                                                                                                                               │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│         uint256 longRate =                                                                                                                                                                                                                   │
│             Market.getOracleRate(cashGroup.currencyId, longMaturity, timeWindow, blockTime);                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         uint256 shortMaturity;                                                                                                                                                                                                               │
│         uint256 shortRate;                                                                                                                                                                                                                   │
│         if (marketIndex == 1) {                                                                                                                                                                                                              │
│             // In this case the short market is the annualized asset supply rate                                                                                                                                                             │
│             shortMaturity = blockTime;                                                                                                                                                                                                       │
│             shortRate = cashGroup.assetRate.getSupplyRate();                                                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             shortMaturity = DateTime.getReferenceTime(blockTime).add(                                                                                                                                                                        │
│                 DateTime.getTradedMarket(marketIndex - 1)                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             shortRate = Market.getOracleRate(                                                                                                                                                                                                │
│                 cashGroup.currencyId,                                                                                                                                                                                                        │
│                 shortMaturity,                                                                                                                                                                                                               │
│                 timeWindow,                                                                                                                                                                                                                  │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return interpolateOracleRate(shortMaturity, longMaturity, shortRate, longRate, maturity);                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculatefCashDiscounts(                                                                                                                                                                                                       │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool isNotionalPositive                                                                                                                                                                                                              │
│     ) private view returns (int256 riskAdjustedDiscountFactor, int256 liquidationDiscountFactor) {                                                                                                                                           │
│         uint256 oracleRate = factors.cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                     │
│         uint256 timeToMaturity = maturity.sub(blockTime);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (isNotionalPositive) {                                                                                                                                                                                                            │
│             // This is the discount factor used to calculate the fCash present value during free collateral                                                                                                                                  │
│             riskAdjustedDiscountFactor = AssetHandler.getDiscountFactor(                                                                                                                                                                     │
│                 timeToMaturity,                                                                                                                                                                                                              │
│                 oracleRate.add(factors.cashGroup.getfCashHaircut())                                                                                                                                                                          │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // This is the discount factor that liquidators get to purchase fCash at, will be larger than                                                                                                                                    │
│             // the risk adjusted discount factor.                                                                                                                                                                                            │
│             liquidationDiscountFactor = AssetHandler.getDiscountFactor(                                                                                                                                                                      │
│                 timeToMaturity,                                                                                                                                                                                                              │
│                 oracleRate.add(factors.cashGroup.getLiquidationfCashHaircut())                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         } else {                                                                                                                                                                                                                             │
│             uint256 buffer = factors.cashGroup.getDebtBuffer();                                                                                                                                                                              │
│             riskAdjustedDiscountFactor = AssetHandler.getDiscountFactor(                                                                                                                                                                     │
│                 timeToMaturity,                                                                                                                                                                                                              │
│                 oracleRate < buffer ? 0 : oracleRate.sub(buffer)                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             buffer = factors.cashGroup.getLiquidationDebtBuffer();                                                                                                                                                                           │
│             liquidationDiscountFactor = AssetHandler.getDiscountFactor(                                                                                                                                                                      │
│                 timeToMaturity,                                                                                                                                                                                                              │
│                 oracleRate < buffer ? 0 : oracleRate.sub(buffer)                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function calculateOracleRate(                                                                                                                                                                                                            │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (uint256) {                                                                                                                                                                                                      │
│         (uint256 marketIndex, bool idiosyncratic) =                                                                                                                                                                                          │
│             DateTime.getMarketIndex(cashGroup.maxMarketIndex, maturity, blockTime);                                                                                                                                                          │
│         uint256 timeWindow = getRateOracleTimeWindow(cashGroup);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         if (!idiosyncratic) {                                                                                                                                                                                                                │
│             return Market.getOracleRate(cashGroup.currencyId, maturity, timeWindow, blockTime);                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 longMaturity =                                                                                                                                                                                                               │
│             DateTime.getReferenceTime(blockTime).add(DateTime.getTradedMarket(marketIndex));                                                                                                                                                 │
│         uint256 longRate =                                                                                                                                                                                                                   │
│             Market.getOracleRate(cashGroup.currencyId, longMaturity, timeWindow, blockTime);                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         uint256 shortMaturity;                                                                                                                                                                                                               │
│         uint256 shortRate;                                                                                                                                                                                                                   │
│         if (marketIndex == 1) {                                                                                                                                                                                                              │
│             // In this case the short market is the annualized asset supply rate                                                                                                                                                             │
│             shortMaturity = blockTime;                                                                                                                                                                                                       │
│             shortRate = cashGroup.assetRate.getSupplyRate();                                                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             shortMaturity = DateTime.getReferenceTime(blockTime).add(                                                                                                                                                                        │
│                 DateTime.getTradedMarket(marketIndex - 1)                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             shortRate = Market.getOracleRate(                                                                                                                                                                                                │
│                 cashGroup.currencyId,                                                                                                                                                                                                        │
│                 shortMaturity,                                                                                                                                                                                                               │
│                 timeWindow,                                                                                                                                                                                                                  │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return interpolateOracleRate(shortMaturity, longMaturity, shortRate, longRate, maturity);                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function setCashGroupStorage(uint256 currencyId, CashGroupSettings calldata cashGroup)                                                                                                                                                   │
│         internal                                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         bytes32 slot = keccak256(abi.encode(currencyId, Constants.CASH_GROUP_STORAGE_OFFSET));                                                                                                                                               │
│         require(                                                                                                                                                                                                                             │
│             cashGroup.maxMarketIndex >= 0 &&                                                                                                                                                                                                 │
│                 cashGroup.maxMarketIndex <= Constants.MAX_TRADED_MARKET_INDEX,                                                                                                                                                               │
│             "CG: invalid market index"                                                                                                                                                                                                       │
│         );                                                                                                                                                                                                                                   │
│         // Due to the requirements of the yield curve we do not allow a cash group to have solely a 3 month market.                                                                                                                          │
│         // The reason is that borrowers will not have a further maturity to roll from their 3 month fixed to a 6 month                                                                                                                       │
│         // fixed. It also complicates the logic in the nToken initialization method                                                                                                                                                          │
│         require(cashGroup.maxMarketIndex != 1, "CG: invalid market index");                                                                                                                                                                  │
│         require(                                                                                                                                                                                                                             │
│             cashGroup.reserveFeeShare <= Constants.PERCENTAGE_DECIMALS,                                                                                                                                                                      │
│             "CG: invalid reserve share"                                                                                                                                                                                                      │
│         );                                                                                                                                                                                                                                   │
│         require(cashGroup.liquidityTokenHaircuts.length == cashGroup.maxMarketIndex);                                                                                                                                                        │
│         require(cashGroup.rateScalars.length == cashGroup.maxMarketIndex);                                                                                                                                                                   │
│         // This is required so that fCash liquidation can proceed correctly                                                                                                                                                                  │
│         require(cashGroup.liquidationfCashHaircut5BPS < cashGroup.fCashHaircut5BPS);                                                                                                                                                         │
│         require(cashGroup.liquidationDebtBuffer5BPS < cashGroup.debtBuffer5BPS);                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         // Market indexes cannot decrease or they will leave fCash assets stranded in the future with no valuation curve                                                                                                                     │
│         uint8 previousMaxMarketIndex = uint8(uint256(_getCashGroupStorageBytes(currencyId)));                                                                                                                                                │
│         require(                                                                                                                                                                                                                             │
│             previousMaxMarketIndex <= cashGroup.maxMarketIndex,                                                                                                                                                                              │
│             "CG: market index cannot decrease"                                                                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         // Per cash group settings                                                                                                                                                                                                           │
│         bytes32 data =                                                                                                                                                                                                                       │
│             (bytes32(uint256(cashGroup.maxMarketIndex)) |                                                                                                                                                                                    │
│                 (bytes32(uint256(cashGroup.rateOracleTimeWindowMin)) << RATE_ORACLE_TIME_WINDOW) |                                                                                                                                           │
│                 (bytes32(uint256(cashGroup.totalFeeBPS)) << TOTAL_FEE) |                                                                                                                                                                     │
│                 (bytes32(uint256(cashGroup.reserveFeeShare)) << RESERVE_FEE_SHARE) |                                                                                                                                                         │
│                 (bytes32(uint256(cashGroup.debtBuffer5BPS)) << DEBT_BUFFER) |                                                                                                                                                                │
│                 (bytes32(uint256(cashGroup.fCashHaircut5BPS)) << FCASH_HAIRCUT) |                                                                                                                                                            │
│                 (bytes32(uint256(cashGroup.settlementPenaltyRate5BPS)) << SETTLEMENT_PENALTY) |                                                                                                                                              │
│                 (bytes32(uint256(cashGroup.liquidationfCashHaircut5BPS)) <<                                                                                                                                                                  │
│                     LIQUIDATION_FCASH_HAIRCUT) |                                                                                                                                                                                             │
│                 (bytes32(uint256(cashGroup.liquidationDebtBuffer5BPS)) << LIQUIDATION_DEBT_BUFFER));                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // Per market group settings                                                                                                                                                                                                         │
│         for (uint256 i; i < cashGroup.liquidityTokenHaircuts.length; i++) {                                                                                                                                                                  │
│             require(                                                                                                                                                                                                                         │
│                 cashGroup.liquidityTokenHaircuts <= Constants.PERCENTAGE_DECIMALS,                                                                                                                                                           │
│                 "CG: invalid token haircut"                                                                                                                                                                                                  │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             data =                                                                                                                                                                                                                           │
│                 data |                                                                                                                                                                                                                       │
│                 (bytes32(uint256(cashGroup.liquidityTokenHaircuts)) <<                                                                                                                                                                       │
│                     (LIQUIDITY_TOKEN_HAIRCUT + i * 8));                                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < cashGroup.rateScalars.length; i++) {                                                                                                                                                                             │
│             // Causes a divide by zero error                                                                                                                                                                                                 │
│             require(cashGroup.rateScalars != 0, "CG: invalid rate scalar");                                                                                                                                                                  │
│             data = data | (bytes32(uint256(cashGroup.rateScalars)) << (RATE_SCALAR + i * 8));                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function deserializeCashGroupStorage(uint256 currencyId)                                                                                                                                                                                 │
│         internal                                                                                                                                                                                                                             │
│         view                                                                                                                                                                                                                                 │
│         returns (CashGroupSettings memory)                                                                                                                                                                                                   │
│     {                                                                                                                                                                                                                                        │
│         bytes32 data = _getCashGroupStorageBytes(currencyId);                                                                                                                                                                                │
│         uint8 maxMarketIndex = uint8(data[31]);                                                                                                                                                                                              │
│         uint8[] memory tokenHaircuts = new uint8[](uint256(maxMarketIndex));                                                                                                                                                                 │
│         uint8[] memory rateScalars = new uint8[](uint256(maxMarketIndex));                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         for (uint8 i; i < maxMarketIndex; i++) {                                                                                                                                                                                             │
│             tokenHaircuts = uint8(data[22 - i]);                                                                                                                                                                                             │
│             rateScalars = uint8(data[13 - i]);                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             CashGroupSettings({                                                                                                                                                                                                              │
│                 maxMarketIndex: maxMarketIndex,                                                                                                                                                                                              │
│                 rateOracleTimeWindowMin: uint8(data[30]),                                                                                                                                                                                    │
│                 totalFeeBPS: uint8(data[29]),                                                                                                                                                                                                │
│                 reserveFeeShare: uint8(data[28]),                                                                                                                                                                                            │
│                 debtBuffer5BPS: uint8(data[27]),                                                                                                                                                                                             │
│                 fCashHaircut5BPS: uint8(data[26]),                                                                                                                                                                                           │
│                 settlementPenaltyRate5BPS: uint8(data[25]),                                                                                                                                                                                  │
│                 liquidationfCashHaircut5BPS: uint8(data[24]),                                                                                                                                                                                │
│                 liquidationDebtBuffer5BPS: uint8(data[23]),                                                                                                                                                                                  │
│                 liquidityTokenHaircuts: tokenHaircuts,                                                                                                                                                                                       │
│                 rateScalars: rateScalars                                                                                                                                                                                                     │
│             });                                                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _getAssetRateView(uint256 currencyId)                                                                                                                                                                                           │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateView();                                                                                                                                                                       │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function buildSettlementRateView(uint256 currencyId, uint256 maturity)                                                                                                                                                                   │
│         internal                                                                                                                                                                                                                             │
│         view                                                                                                                                                                                                                                 │
│         returns (AssetRateParameters memory)                                                                                                                                                                                                 │
│     {                                                                                                                                                                                                                                        │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 settlementRate,                                                                                                                                                                                                           │
│             uint8 underlyingDecimalPlaces,                                                                                                                                                                                                   │
│             /* bytes32 slot */                                                                                                                                                                                                               │
│         ) = _getSettlementRateStorage(currencyId, maturity);                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         if (settlementRate == 0) {                                                                                                                                                                                                           │
│             // If settlement rate has not been set then we need to fetch it                                                                                                                                                                  │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 settlementRate,                                                                                                                                                                                                              │
│                 /* address */,                                                                                                                                                                                                               │
│                 underlyingDecimalPlaces                                                                                                                                                                                                      │
│             ) = _getAssetRateView(currencyId);                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetRateParameters(address(0), settlementRate, int256(10**underlyingDecimalPlaces));                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateView(uint256 currencyId)                                                                                                                                                                                           │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateView();                                                                                                                                                                       │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function buildSettlementRateView(uint256 currencyId, uint256 maturity)                                                                                                                                                                   │
│         internal                                                                                                                                                                                                                             │
│         view                                                                                                                                                                                                                                 │
│         returns (AssetRateParameters memory)                                                                                                                                                                                                 │
│     {                                                                                                                                                                                                                                        │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 settlementRate,                                                                                                                                                                                                           │
│             uint8 underlyingDecimalPlaces,                                                                                                                                                                                                   │
│             /* bytes32 slot */                                                                                                                                                                                                               │
│         ) = _getSettlementRateStorage(currencyId, maturity);                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         if (settlementRate == 0) {                                                                                                                                                                                                           │
│             // If settlement rate has not been set then we need to fetch it                                                                                                                                                                  │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 settlementRate,                                                                                                                                                                                                              │
│                 /* address */,                                                                                                                                                                                                               │
│                 underlyingDecimalPlaces                                                                                                                                                                                                      │
│             ) = _getAssetRateView(currencyId);                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetRateParameters(address(0), settlementRate, int256(10**underlyingDecimalPlaces));                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateView(uint256 currencyId)                                                                                                                                                                                           │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateView();                                                                                                                                                                       │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function buildAssetRateView(uint256 currencyId)                                                                                                                                                                                          │
│         internal                                                                                                                                                                                                                             │
│         view                                                                                                                                                                                                                                 │
│         returns (AssetRateParameters memory)                                                                                                                                                                                                 │
│     {                                                                                                                                                                                                                                        │
│         (int256 rate, address rateOracle, uint8 underlyingDecimalPlaces) =                                                                                                                                                                   │
│             _getAssetRateView(currencyId);                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             AssetRateParameters({                                                                                                                                                                                                            │
│                 rateOracle: rateOracle,                                                                                                                                                                                                      │
│                 rate: rate,                                                                                                                                                                                                                  │
│                 underlyingDecimals: int256(10**underlyingDecimalPlaces)                                                                                                                                                                      │
│             });                                                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateView(uint256 currencyId)                                                                                                                                                                                           │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateView();                                                                                                                                                                       │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _getAssetRateStateful(uint256 currencyId)                                                                                                                                                                                       │
│         private                                                                                                                                                                                                                              │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateStateful();                                                                                                                                                                   │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function buildAssetRateStateful(uint256 currencyId)                                                                                                                                                                                      │
│         internal                                                                                                                                                                                                                             │
│         returns (AssetRateParameters memory)                                                                                                                                                                                                 │
│     {                                                                                                                                                                                                                                        │
│         (int256 rate, address rateOracle, uint8 underlyingDecimalPlaces) =                                                                                                                                                                   │
│             _getAssetRateStateful(currencyId);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             AssetRateParameters({                                                                                                                                                                                                            │
│                 rateOracle: rateOracle,                                                                                                                                                                                                      │
│                 rate: rate,                                                                                                                                                                                                                  │
│                 underlyingDecimals: int256(10**underlyingDecimalPlaces)                                                                                                                                                                      │
│             });                                                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateStateful(uint256 currencyId)                                                                                                                                                                                       │
│         private                                                                                                                                                                                                                              │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateStateful();                                                                                                                                                                   │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function buildAssetRateStateful(uint256 currencyId)                                                                                                                                                                                      │
│         internal                                                                                                                                                                                                                             │
│         returns (AssetRateParameters memory)                                                                                                                                                                                                 │
│     {                                                                                                                                                                                                                                        │
│         (int256 rate, address rateOracle, uint8 underlyingDecimalPlaces) =                                                                                                                                                                   │
│             _getAssetRateStateful(currencyId);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             AssetRateParameters({                                                                                                                                                                                                            │
│                 rateOracle: rateOracle,                                                                                                                                                                                                      │
│                 rate: rate,                                                                                                                                                                                                                  │
│                 underlyingDecimals: int256(10**underlyingDecimalPlaces)                                                                                                                                                                      │
│             });                                                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateStateful(uint256 currencyId)                                                                                                                                                                                       │
│         private                                                                                                                                                                                                                              │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateStateful();                                                                                                                                                                   │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function buildSettlementRateStateful(                                                                                                                                                                                                    │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal returns (AssetRateParameters memory) {                                                                                                                                                                                        │
│         (int256 settlementRate, uint8 underlyingDecimalPlaces, bytes32 slot) =                                                                                                                                                               │
│             _getSettlementRateStorage(currencyId, maturity);                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         if (settlementRate == 0) {                                                                                                                                                                                                           │
│             // Settlement rate has not yet been set, set it in this branch                                                                                                                                                                   │
│             address rateOracle;                                                                                                                                                                                                              │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 settlementRate,                                                                                                                                                                                                              │
│                 rateOracle,                                                                                                                                                                                                                  │
│                 underlyingDecimalPlaces                                                                                                                                                                                                      │
│             ) = _getAssetRateStateful(currencyId);                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             if (rateOracle != address(0)) {                                                                                                                                                                                                  │
│                 // Only need to set settlement rates when the rate oracle is set (meaning the asset token has                                                                                                                                │
│                 // a conversion rate to an underlying). If not set then the asset cash always settles to underlying at a 1-1                                                                                                                 │
│                 // rate since they are the same.                                                                                                                                                                                             │
│                 require(blockTime != 0 && blockTime <= type(uint40).max); // dev: settlement rate timestamp overflow                                                                                                                         │
│                 require(settlementRate > 0 && settlementRate <= type(uint128).max); // dev: settlement rate overflow                                                                                                                         │
│                 uint128 storedRate = uint128(uint256(settlementRate));                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 bytes32 data =                                                                                                                                                                                                               │
│                     (bytes32(blockTime) |                                                                                                                                                                                                    │
│                         (bytes32(uint256(storedRate)) << 40) |                                                                                                                                                                               │
│                         (bytes32(uint256(underlyingDecimalPlaces)) << 168));                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│                 assembly {                                                                                                                                                                                                                   │
│                     sstore(slot, data)                                                                                                                                                                                                       │
│                 }                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│                 emit SetSettlementRate(currencyId, maturity, storedRate);                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetRateParameters(address(0), settlementRate, int256(10**underlyingDecimalPlaces));                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateStateful(uint256 currencyId)                                                                                                                                                                                       │
│         private                                                                                                                                                                                                                              │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateStateful();                                                                                                                                                                   │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function buildSettlementRateStateful(                                                                                                                                                                                                    │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal returns (AssetRateParameters memory) {                                                                                                                                                                                        │
│         (int256 settlementRate, uint8 underlyingDecimalPlaces, bytes32 slot) =                                                                                                                                                               │
│             _getSettlementRateStorage(currencyId, maturity);                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         if (settlementRate == 0) {                                                                                                                                                                                                           │
│             // Settlement rate has not yet been set, set it in this branch                                                                                                                                                                   │
│             address rateOracle;                                                                                                                                                                                                              │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 settlementRate,                                                                                                                                                                                                              │
│                 rateOracle,                                                                                                                                                                                                                  │
│                 underlyingDecimalPlaces                                                                                                                                                                                                      │
│             ) = _getAssetRateStateful(currencyId);                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             if (rateOracle != address(0)) {                                                                                                                                                                                                  │
│                 // Only need to set settlement rates when the rate oracle is set (meaning the asset token has                                                                                                                                │
│                 // a conversion rate to an underlying). If not set then the asset cash always settles to underlying at a 1-1                                                                                                                 │
│                 // rate since they are the same.                                                                                                                                                                                             │
│                 require(blockTime != 0 && blockTime <= type(uint40).max); // dev: settlement rate timestamp overflow                                                                                                                         │
│                 require(settlementRate > 0 && settlementRate <= type(uint128).max); // dev: settlement rate overflow                                                                                                                         │
│                 uint128 storedRate = uint128(uint256(settlementRate));                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 bytes32 data =                                                                                                                                                                                                               │
│                     (bytes32(blockTime) |                                                                                                                                                                                                    │
│                         (bytes32(uint256(storedRate)) << 40) |                                                                                                                                                                               │
│                         (bytes32(uint256(underlyingDecimalPlaces)) << 168));                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│                 assembly {                                                                                                                                                                                                                   │
│                     sstore(slot, data)                                                                                                                                                                                                       │
│                 }                                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│                 emit SetSettlementRate(currencyId, maturity, storedRate);                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetRateParameters(address(0), settlementRate, int256(10**underlyingDecimalPlaces));                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function _getAssetRateStateful(uint256 currencyId)                                                                                                                                                                                       │
│         private                                                                                                                                                                                                                              │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             address,                                                                                                                                                                                                                         │
│             uint8                                                                                                                                                                                                                            │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (address rateOracle, uint8 underlyingDecimalPlaces) = _getAssetRateStorage(currencyId);                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (rateOracle == address(0)) {                                                                                                                                                                                                      │
│             // If no rate oracle is set, then set this to the identity                                                                                                                                                                       │
│             rate = ASSET_RATE_DECIMAL_DIFFERENCE;                                                                                                                                                                                            │
│             underlyingDecimalPlaces = 0;                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             rate = AssetRateAdapter(rateOracle).getExchangeRateStateful();                                                                                                                                                                   │
│             require(rate > 0); // dev: invalid exchange rate                                                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rate, rateOracle, underlyingDecimalPlaces);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function addLiquidity(MarketParameters memory market, int256 assetCash)                                                                                                                                                                  │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256, int256)                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         require(market.totalLiquidity > 0, "M: zero liquidity");                                                                                                                                                                             │
│         if (assetCash == 0) return (0, 0);                                                                                                                                                                                                   │
│         require(assetCash > 0); // dev: negative asset cash                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         int256 liquidityTokens = market.totalLiquidity.mul(assetCash).div(market.totalAssetCash);                                                                                                                                            │
│         // No need to convert this to underlying, assetCash / totalAssetCash is a unitless proportion.                                                                                                                                       │
│         int256 fCash = market.totalfCash.mul(assetCash).div(market.totalAssetCash);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         market.totalLiquidity = market.totalLiquidity.add(liquidityTokens);                                                                                                                                                                  │
│         market.totalfCash = market.totalfCash.add(fCash);                                                                                                                                                                                    │
│         market.totalAssetCash = market.totalAssetCash.add(assetCash);                                                                                                                                                                        │
│         market.storageState = market.storageState | STORAGE_STATE_UPDATE_LIQUIDITY;                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (liquidityTokens, fCash.neg());                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function addLiquidity(MarketParameters memory market, int256 assetCash)                                                                                                                                                                  │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256, int256)                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         require(market.totalLiquidity > 0, "M: zero liquidity");                                                                                                                                                                             │
│         if (assetCash == 0) return (0, 0);                                                                                                                                                                                                   │
│         require(assetCash > 0); // dev: negative asset cash                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         int256 liquidityTokens = market.totalLiquidity.mul(assetCash).div(market.totalAssetCash);                                                                                                                                            │
│         // No need to convert this to underlying, assetCash / totalAssetCash is a unitless proportion.                                                                                                                                       │
│         int256 fCash = market.totalfCash.mul(assetCash).div(market.totalAssetCash);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         market.totalLiquidity = market.totalLiquidity.add(liquidityTokens);                                                                                                                                                                  │
│         market.totalfCash = market.totalfCash.add(fCash);                                                                                                                                                                                    │
│         market.totalAssetCash = market.totalAssetCash.add(assetCash);                                                                                                                                                                        │
│         market.storageState = market.storageState | STORAGE_STATE_UPDATE_LIQUIDITY;                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (liquidityTokens, fCash.neg());                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory market, int256 tokensToRemove)                                                                                                                                                          │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256, int256)                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         if (tokensToRemove == 0) return (0, 0);                                                                                                                                                                                              │
│         require(tokensToRemove > 0); // dev: negative tokens to remove                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         int256 assetCash = market.totalAssetCash.mul(tokensToRemove).div(market.totalLiquidity);                                                                                                                                             │
│         int256 fCash = market.totalfCash.mul(tokensToRemove).div(market.totalLiquidity);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         market.totalLiquidity = market.totalLiquidity.subNoNeg(tokensToRemove);                                                                                                                                                              │
│         market.totalfCash = market.totalfCash.subNoNeg(fCash);                                                                                                                                                                               │
│         market.totalAssetCash = market.totalAssetCash.subNoNeg(assetCash);                                                                                                                                                                   │
│         market.storageState = market.storageState | STORAGE_STATE_UPDATE_LIQUIDITY;                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory market, int256 tokensToRemove)                                                                                                                                                          │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256, int256)                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         if (tokensToRemove == 0) return (0, 0);                                                                                                                                                                                              │
│         require(tokensToRemove > 0); // dev: negative tokens to remove                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         int256 assetCash = market.totalAssetCash.mul(tokensToRemove).div(market.totalLiquidity);                                                                                                                                             │
│         int256 fCash = market.totalfCash.mul(tokensToRemove).div(market.totalLiquidity);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         market.totalLiquidity = market.totalLiquidity.subNoNeg(tokensToRemove);                                                                                                                                                              │
│         market.totalfCash = market.totalfCash.subNoNeg(fCash);                                                                                                                                                                               │
│         market.totalAssetCash = market.totalAssetCash.subNoNeg(assetCash);                                                                                                                                                                   │
│         market.storageState = market.storageState | STORAGE_STATE_UPDATE_LIQUIDITY;                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory market, int256 tokensToRemove)                                                                                                                                                          │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256, int256)                                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         if (tokensToRemove == 0) return (0, 0);                                                                                                                                                                                              │
│         require(tokensToRemove > 0); // dev: negative tokens to remove                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         int256 assetCash = market.totalAssetCash.mul(tokensToRemove).div(market.totalLiquidity);                                                                                                                                             │
│         int256 fCash = market.totalfCash.mul(tokensToRemove).div(market.totalLiquidity);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         market.totalLiquidity = market.totalLiquidity.subNoNeg(tokensToRemove);                                                                                                                                                              │
│         market.totalfCash = market.totalfCash.subNoNeg(fCash);                                                                                                                                                                               │
│         market.totalAssetCash = market.totalAssetCash.subNoNeg(assetCash);                                                                                                                                                                   │
│         market.storageState = market.storageState | STORAGE_STATE_UPDATE_LIQUIDITY;                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateTrade(                                                                                                                                                                                                                 │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 fCashToAccount,                                                                                                                                                                                                               │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         // We return false if there is not enough fCash to support this trade.                                                                                                                                                               │
│         if (market.totalfCash.sub(fCashToAccount) <= 0) return (0, 0);                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 preFeeExchangeRate;                                                                                                                                                                                                           │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (preFeeExchangeRate, success) = _getExchangeRate(                                                                                                                                                                                │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fCashToAccount                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         (int256 netCashToAccount, int256 netCashToMarket, int256 netCashToReserve) =                                                                                                                                                         │
│             _getNetCashAmountsUnderlying(                                                                                                                                                                                                    │
│                 cashGroup,                                                                                                                                                                                                                   │
│                 preFeeExchangeRate,                                                                                                                                                                                                          │
│                 fCashToAccount,                                                                                                                                                                                                              │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         if (netCashToAccount == 0) return (0, 0);                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             market.totalfCash = market.totalfCash.subNoNeg(fCashToAccount);                                                                                                                                                                  │
│             market.lastImpliedRate = getImpliedRate(                                                                                                                                                                                         │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying.add(netCashToMarket),                                                                                                                                                                                    │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // It's technically possible that the implied rate is actually exactly zero (or                                                                                                                                                  │
│             // more accurately the natural log rounds down to zero) but we will still fail                                                                                                                                                   │
│             // in this case. If this does happen we may assume that markets are not initialized.                                                                                                                                             │
│             if (market.lastImpliedRate == 0) return (0, 0);                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             _setNewMarketState(                                                                                                                                                                                                              │
│                 market,                                                                                                                                                                                                                      │
│                 cashGroup.assetRate,                                                                                                                                                                                                         │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 netCashToMarket,                                                                                                                                                                                                             │
│                 netCashToReserve                                                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getExchangeRateFactors(                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     )                                                                                                                                                                                                                                        │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 rateScalar = cashGroup.getRateScalar(marketIndex, timeToMaturity);                                                                                                                                                            │
│         int256 totalCashUnderlying = cashGroup.assetRate.convertToUnderlying(market.totalAssetCash);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // This will result in a divide by zero                                                                                                                                                                                              │
│         if (market.totalfCash == 0 || totalCashUnderlying == 0) return (0, 0, 0);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         // Get the rate anchor given the market state, this will establish the baseline for where                                                                                                                                            │
│         // the exchange rate is set.                                                                                                                                                                                                         │
│         int256 rateAnchor;                                                                                                                                                                                                                   │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (rateAnchor, success) = _getRateAnchor(                                                                                                                                                                                          │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 market.lastImpliedRate,                                                                                                                                                                                                      │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0, 0);                                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rateScalar, totalCashUnderlying, rateAnchor);                                                                                                                                                                                │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateTrade(                                                                                                                                                                                                                 │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 fCashToAccount,                                                                                                                                                                                                               │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         // We return false if there is not enough fCash to support this trade.                                                                                                                                                               │
│         if (market.totalfCash.sub(fCashToAccount) <= 0) return (0, 0);                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 preFeeExchangeRate;                                                                                                                                                                                                           │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (preFeeExchangeRate, success) = _getExchangeRate(                                                                                                                                                                                │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fCashToAccount                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         (int256 netCashToAccount, int256 netCashToMarket, int256 netCashToReserve) =                                                                                                                                                         │
│             _getNetCashAmountsUnderlying(                                                                                                                                                                                                    │
│                 cashGroup,                                                                                                                                                                                                                   │
│                 preFeeExchangeRate,                                                                                                                                                                                                          │
│                 fCashToAccount,                                                                                                                                                                                                              │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         if (netCashToAccount == 0) return (0, 0);                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             market.totalfCash = market.totalfCash.subNoNeg(fCashToAccount);                                                                                                                                                                  │
│             market.lastImpliedRate = getImpliedRate(                                                                                                                                                                                         │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying.add(netCashToMarket),                                                                                                                                                                                    │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // It's technically possible that the implied rate is actually exactly zero (or                                                                                                                                                  │
│             // more accurately the natural log rounds down to zero) but we will still fail                                                                                                                                                   │
│             // in this case. If this does happen we may assume that markets are not initialized.                                                                                                                                             │
│             if (market.lastImpliedRate == 0) return (0, 0);                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             _setNewMarketState(                                                                                                                                                                                                              │
│                 market,                                                                                                                                                                                                                      │
│                 cashGroup.assetRate,                                                                                                                                                                                                         │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 netCashToMarket,                                                                                                                                                                                                             │
│                 netCashToReserve                                                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
│     function getExchangeRateFactors(                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     )                                                                                                                                                                                                                                        │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 rateScalar = cashGroup.getRateScalar(marketIndex, timeToMaturity);                                                                                                                                                            │
│         int256 totalCashUnderlying = cashGroup.assetRate.convertToUnderlying(market.totalAssetCash);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // This will result in a divide by zero                                                                                                                                                                                              │
│         if (market.totalfCash == 0 || totalCashUnderlying == 0) return (0, 0, 0);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         // Get the rate anchor given the market state, this will establish the baseline for where                                                                                                                                            │
│         // the exchange rate is set.                                                                                                                                                                                                         │
│         int256 rateAnchor;                                                                                                                                                                                                                   │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (rateAnchor, success) = _getRateAnchor(                                                                                                                                                                                          │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 market.lastImpliedRate,                                                                                                                                                                                                      │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0, 0);                                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rateScalar, totalCashUnderlying, rateAnchor);                                                                                                                                                                                │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _getNetCashAmountsUnderlying(                                                                                                                                                                                                   │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 preFeeExchangeRate,                                                                                                                                                                                                           │
│         int256 fCashToAccount,                                                                                                                                                                                                               │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         // Fees are specified in basis points which is an implied rate denomination. We convert this to                                                                                                                                      │
│         // an exchange rate denomination for the given time to maturity. (i.e. get e^(fee * t) and multiply                                                                                                                                  │
│         // or divide depending on the side of the trade).                                                                                                                                                                                    │
│         // tradeExchangeRate = exp((tradeInterestRateNoFee +/- fee) * timeToMaturity)                                                                                                                                                        │
│         // tradeExchangeRate = tradeExchangeRateNoFee (* or /) exp(fee * timeToMaturity)                                                                                                                                                     │
│         int256 preFeeCashToAccount =                                                                                                                                                                                                         │
│             fCashToAccount.divInRatePrecision(preFeeExchangeRate).neg();                                                                                                                                                                     │
│         int256 fee = getExchangeRateFromImpliedRate(cashGroup.getTotalFee(), timeToMaturity);                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         if (fCashToAccount > 0) {                                                                                                                                                                                                            │
│             // Lending                                                                                                                                                                                                                       │
│             int256 postFeeExchangeRate = preFeeExchangeRate.divInRatePrecision(fee);                                                                                                                                                         │
│             // It's possible that the fee pushes exchange rates into negative territory. This is not possible                                                                                                                                │
│             // when borrowing. If this happens then the trade has failed.                                                                                                                                                                    │
│             if (postFeeExchangeRate < Constants.RATE_PRECISION) return (0, 0, 0);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // cashToAccount = -(fCashToAccount / exchangeRate)                                                                                                                                                                              │
│             // postFeeExchangeRate = preFeeExchangeRate / feeExchangeRate                                                                                                                                                                    │
│             // preFeeCashToAccount = -(fCashToAccount / preFeeExchangeRate)                                                                                                                                                                  │
│             // postFeeCashToAccount = -(fCashToAccount / postFeeExchangeRate)                                                                                                                                                                │
│             // netFee = preFeeCashToAccount - postFeeCashToAccount                                                                                                                                                                           │
│             // netFee = (fCashToAccount / postFeeExchangeRate) - (fCashToAccount / preFeeExchangeRate)                                                                                                                                       │
│             // netFee = ((fCashToAccount * feeExchangeRate) / preFeeExchangeRate) - (fCashToAccount / preFeeExchangeRate)                                                                                                                    │
│             // netFee = (fCashToAccount / preFeeExchangeRate) * (feeExchangeRate - 1)                                                                                                                                                        │
│             // netFee = -(preFeeCashToAccount) * (feeExchangeRate - 1)                                                                                                                                                                       │
│             // netFee = preFeeCashToAccount * (1 - feeExchangeRate)                                                                                                                                                                          │
│             fee = preFeeCashToAccount.mulInRatePrecision(Constants.RATE_PRECISION.sub(fee));                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             // Borrowing                                                                                                                                                                                                                     │
│             // cashToAccount = -(fCashToAccount / exchangeRate)                                                                                                                                                                              │
│             // postFeeExchangeRate = preFeeExchangeRate * feeExchangeRate                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│             // netFee = preFeeCashToAccount - postFeeCashToAccount                                                                                                                                                                           │
│             // netFee = (fCashToAccount / postFeeExchangeRate) - (fCashToAccount / preFeeExchangeRate)                                                                                                                                       │
│             // netFee = ((fCashToAccount / (feeExchangeRate * preFeeExchangeRate)) - (fCashToAccount / preFeeExchangeRate)                                                                                                                   │
│             // netFee = (fCashToAccount / preFeeExchangeRate) * (1 / feeExchangeRate - 1)                                                                                                                                                    │
│             // netFee = preFeeCashToAccount * ((1 - feeExchangeRate) / feeExchangeRate)                                                                                                                                                      │
│             // NOTE: preFeeCashToAccount is negative in this branch so we negate it to ensure that fee is a positive number                                                                                                                  │
│             fee = preFeeCashToAccount.mul(Constants.RATE_PRECISION.sub(fee)).div(fee).neg();                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 cashToReserve =                                                                                                                                                                                                               │
│             fee.mul(cashGroup.getReserveFeeShare()).div(Constants.PERCENTAGE_DECIMALS);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         return (                                                                                                                                                                                                                             │
│             // postFeeCashToAccount = preFeeCashToAccount - fee                                                                                                                                                                              │
│             preFeeCashToAccount.sub(fee),                                                                                                                                                                                                    │
│             // netCashToMarket = -(preFeeCashToAccount - fee + cashToReserve)                                                                                                                                                                │
│             (preFeeCashToAccount.sub(fee).add(cashToReserve)).neg(),                                                                                                                                                                         │
│             cashToReserve                                                                                                                                                                                                                    │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateTrade(                                                                                                                                                                                                                 │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 fCashToAccount,                                                                                                                                                                                                               │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         // We return false if there is not enough fCash to support this trade.                                                                                                                                                               │
│         if (market.totalfCash.sub(fCashToAccount) <= 0) return (0, 0);                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 preFeeExchangeRate;                                                                                                                                                                                                           │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (preFeeExchangeRate, success) = _getExchangeRate(                                                                                                                                                                                │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fCashToAccount                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         (int256 netCashToAccount, int256 netCashToMarket, int256 netCashToReserve) =                                                                                                                                                         │
│             _getNetCashAmountsUnderlying(                                                                                                                                                                                                    │
│                 cashGroup,                                                                                                                                                                                                                   │
│                 preFeeExchangeRate,                                                                                                                                                                                                          │
│                 fCashToAccount,                                                                                                                                                                                                              │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         if (netCashToAccount == 0) return (0, 0);                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             market.totalfCash = market.totalfCash.subNoNeg(fCashToAccount);                                                                                                                                                                  │
│             market.lastImpliedRate = getImpliedRate(                                                                                                                                                                                         │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying.add(netCashToMarket),                                                                                                                                                                                    │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // It's technically possible that the implied rate is actually exactly zero (or                                                                                                                                                  │
│             // more accurately the natural log rounds down to zero) but we will still fail                                                                                                                                                   │
│             // in this case. If this does happen we may assume that markets are not initialized.                                                                                                                                             │
│             if (market.lastImpliedRate == 0) return (0, 0);                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             _setNewMarketState(                                                                                                                                                                                                              │
│                 market,                                                                                                                                                                                                                      │
│                 cashGroup.assetRate,                                                                                                                                                                                                         │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 netCashToMarket,                                                                                                                                                                                                             │
│                 netCashToReserve                                                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
│     function _getNetCashAmountsUnderlying(                                                                                                                                                                                                   │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 preFeeExchangeRate,                                                                                                                                                                                                           │
│         int256 fCashToAccount,                                                                                                                                                                                                               │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         // Fees are specified in basis points which is an implied rate denomination. We convert this to                                                                                                                                      │
│         // an exchange rate denomination for the given time to maturity. (i.e. get e^(fee * t) and multiply                                                                                                                                  │
│         // or divide depending on the side of the trade).                                                                                                                                                                                    │
│         // tradeExchangeRate = exp((tradeInterestRateNoFee +/- fee) * timeToMaturity)                                                                                                                                                        │
│         // tradeExchangeRate = tradeExchangeRateNoFee (* or /) exp(fee * timeToMaturity)                                                                                                                                                     │
│         int256 preFeeCashToAccount =                                                                                                                                                                                                         │
│             fCashToAccount.divInRatePrecision(preFeeExchangeRate).neg();                                                                                                                                                                     │
│         int256 fee = getExchangeRateFromImpliedRate(cashGroup.getTotalFee(), timeToMaturity);                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         if (fCashToAccount > 0) {                                                                                                                                                                                                            │
│             // Lending                                                                                                                                                                                                                       │
│             int256 postFeeExchangeRate = preFeeExchangeRate.divInRatePrecision(fee);                                                                                                                                                         │
│             // It's possible that the fee pushes exchange rates into negative territory. This is not possible                                                                                                                                │
│             // when borrowing. If this happens then the trade has failed.                                                                                                                                                                    │
│             if (postFeeExchangeRate < Constants.RATE_PRECISION) return (0, 0, 0);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // cashToAccount = -(fCashToAccount / exchangeRate)                                                                                                                                                                              │
│             // postFeeExchangeRate = preFeeExchangeRate / feeExchangeRate                                                                                                                                                                    │
│             // preFeeCashToAccount = -(fCashToAccount / preFeeExchangeRate)                                                                                                                                                                  │
│             // postFeeCashToAccount = -(fCashToAccount / postFeeExchangeRate)                                                                                                                                                                │
│             // netFee = preFeeCashToAccount - postFeeCashToAccount                                                                                                                                                                           │
│             // netFee = (fCashToAccount / postFeeExchangeRate) - (fCashToAccount / preFeeExchangeRate)                                                                                                                                       │
│             // netFee = ((fCashToAccount * feeExchangeRate) / preFeeExchangeRate) - (fCashToAccount / preFeeExchangeRate)                                                                                                                    │
│             // netFee = (fCashToAccount / preFeeExchangeRate) * (feeExchangeRate - 1)                                                                                                                                                        │
│             // netFee = -(preFeeCashToAccount) * (feeExchangeRate - 1)                                                                                                                                                                       │
│             // netFee = preFeeCashToAccount * (1 - feeExchangeRate)                                                                                                                                                                          │
│             fee = preFeeCashToAccount.mulInRatePrecision(Constants.RATE_PRECISION.sub(fee));                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             // Borrowing                                                                                                                                                                                                                     │
│             // cashToAccount = -(fCashToAccount / exchangeRate)                                                                                                                                                                              │
│             // postFeeExchangeRate = preFeeExchangeRate * feeExchangeRate                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│             // netFee = preFeeCashToAccount - postFeeCashToAccount                                                                                                                                                                           │
│             // netFee = (fCashToAccount / postFeeExchangeRate) - (fCashToAccount / preFeeExchangeRate)                                                                                                                                       │
│             // netFee = ((fCashToAccount / (feeExchangeRate * preFeeExchangeRate)) - (fCashToAccount / preFeeExchangeRate)                                                                                                                   │
│             // netFee = (fCashToAccount / preFeeExchangeRate) * (1 / feeExchangeRate - 1)                                                                                                                                                    │
│             // netFee = preFeeCashToAccount * ((1 - feeExchangeRate) / feeExchangeRate)                                                                                                                                                      │
│             // NOTE: preFeeCashToAccount is negative in this branch so we negate it to ensure that fee is a positive number                                                                                                                  │
│             fee = preFeeCashToAccount.mul(Constants.RATE_PRECISION.sub(fee)).div(fee).neg();                                                                                                                                                 │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 cashToReserve =                                                                                                                                                                                                               │
│             fee.mul(cashGroup.getReserveFeeShare()).div(Constants.PERCENTAGE_DECIMALS);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         return (                                                                                                                                                                                                                             │
│             // postFeeCashToAccount = preFeeCashToAccount - fee                                                                                                                                                                              │
│             preFeeCashToAccount.sub(fee),                                                                                                                                                                                                    │
│             // netCashToMarket = -(preFeeCashToAccount - fee + cashToReserve)                                                                                                                                                                │
│             (preFeeCashToAccount.sub(fee).add(cashToReserve)).neg(),                                                                                                                                                                         │
│             cashToReserve                                                                                                                                                                                                                    │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _getRateAnchor(                                                                                                                                                                                                                 │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         uint256 lastImpliedRate,                                                                                                                                                                                                             │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     ) internal pure returns (int256, bool) {                                                                                                                                                                                                 │
│         // This is the exchange rate at the new time to maturity                                                                                                                                                                             │
│         int256 exchangeRate = getExchangeRateFromImpliedRate(lastImpliedRate, timeToMaturity);                                                                                                                                               │
│         if (exchangeRate < Constants.RATE_PRECISION) return (0, false);                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         int256 rateAnchor;                                                                                                                                                                                                                   │
│         {                                                                                                                                                                                                                                    │
│             int256 proportion =                                                                                                                                                                                                              │
│                 totalfCash.divInRatePrecision(totalfCash.add(totalCashUnderlying));                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             (int256 lnProportion, bool success) = _logProportion(proportion);                                                                                                                                                                │
│             if (!success) return (0, false);                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             rateAnchor = exchangeRate.sub(lnProportion.divInRatePrecision(rateScalar));                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rateAnchor, true);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getExchangeRateFactors(                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     )                                                                                                                                                                                                                                        │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 rateScalar = cashGroup.getRateScalar(marketIndex, timeToMaturity);                                                                                                                                                            │
│         int256 totalCashUnderlying = cashGroup.assetRate.convertToUnderlying(market.totalAssetCash);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // This will result in a divide by zero                                                                                                                                                                                              │
│         if (market.totalfCash == 0 || totalCashUnderlying == 0) return (0, 0, 0);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         // Get the rate anchor given the market state, this will establish the baseline for where                                                                                                                                            │
│         // the exchange rate is set.                                                                                                                                                                                                         │
│         int256 rateAnchor;                                                                                                                                                                                                                   │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (rateAnchor, success) = _getRateAnchor(                                                                                                                                                                                          │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 market.lastImpliedRate,                                                                                                                                                                                                      │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0, 0);                                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rateScalar, totalCashUnderlying, rateAnchor);                                                                                                                                                                                │
│     }                                                                                                                                                                                                                                        │
│     function _getRateAnchor(                                                                                                                                                                                                                 │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         uint256 lastImpliedRate,                                                                                                                                                                                                             │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     ) internal pure returns (int256, bool) {                                                                                                                                                                                                 │
│         // This is the exchange rate at the new time to maturity                                                                                                                                                                             │
│         int256 exchangeRate = getExchangeRateFromImpliedRate(lastImpliedRate, timeToMaturity);                                                                                                                                               │
│         if (exchangeRate < Constants.RATE_PRECISION) return (0, false);                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         int256 rateAnchor;                                                                                                                                                                                                                   │
│         {                                                                                                                                                                                                                                    │
│             int256 proportion =                                                                                                                                                                                                              │
│                 totalfCash.divInRatePrecision(totalfCash.add(totalCashUnderlying));                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             (int256 lnProportion, bool success) = _logProportion(proportion);                                                                                                                                                                │
│             if (!success) return (0, false);                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             rateAnchor = exchangeRate.sub(lnProportion.divInRatePrecision(rateScalar));                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rateAnchor, true);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getImpliedRate(                                                                                                                                                                                                                 │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 rateAnchor,                                                                                                                                                                                                                   │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     ) internal pure returns (uint256) {                                                                                                                                                                                                      │
│         // This will check for exchange rates < Constants.RATE_PRECISION                                                                                                                                                                     │
│         (int256 exchangeRate, bool success) =                                                                                                                                                                                                │
│             _getExchangeRate(totalfCash, totalCashUnderlying, rateScalar, rateAnchor, 0);                                                                                                                                                    │
│         if (!success) return 0;                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         // Uses continuous compounding to calculate the implied rate:                                                                                                                                                                        │
│         // ln(exchangeRate) * Constants.IMPLIED_RATE_TIME / timeToMaturity                                                                                                                                                                   │
│         int128 rate = ABDKMath64x64.fromInt(exchangeRate);                                                                                                                                                                                   │
│         int128 rateScaled = ABDKMath64x64.div(rate, Constants.RATE_PRECISION_64x64);                                                                                                                                                         │
│         // We will not have a negative log here because we check that exchangeRate > Constants.RATE_PRECISION                                                                                                                                │
│         // inside getExchangeRate                                                                                                                                                                                                            │
│         int128 lnRateScaled = ABDKMath64x64.ln(rateScaled);                                                                                                                                                                                  │
│         uint256 lnRate =                                                                                                                                                                                                                     │
│             ABDKMath64x64.toUInt(ABDKMath64x64.mul(lnRateScaled, Constants.RATE_PRECISION_64x64));                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         uint256 impliedRate = lnRate.mul(Constants.IMPLIED_RATE_TIME).div(timeToMaturity);                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         // Implied rates over 429% will overflow, this seems like a safe assumption                                                                                                                                                          │
│         if (impliedRate > type(uint32).max) return 0;                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         return impliedRate;                                                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateTrade(                                                                                                                                                                                                                 │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 fCashToAccount,                                                                                                                                                                                                               │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 marketIndex                                                                                                                                                                                                                  │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         // We return false if there is not enough fCash to support this trade.                                                                                                                                                               │
│         if (market.totalfCash.sub(fCashToAccount) <= 0) return (0, 0);                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 preFeeExchangeRate;                                                                                                                                                                                                           │
│         {                                                                                                                                                                                                                                    │
│             bool success;                                                                                                                                                                                                                    │
│             (preFeeExchangeRate, success) = _getExchangeRate(                                                                                                                                                                                │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fCashToAccount                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│             if (!success) return (0, 0);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         (int256 netCashToAccount, int256 netCashToMarket, int256 netCashToReserve) =                                                                                                                                                         │
│             _getNetCashAmountsUnderlying(                                                                                                                                                                                                    │
│                 cashGroup,                                                                                                                                                                                                                   │
│                 preFeeExchangeRate,                                                                                                                                                                                                          │
│                 fCashToAccount,                                                                                                                                                                                                              │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         if (netCashToAccount == 0) return (0, 0);                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             market.totalfCash = market.totalfCash.subNoNeg(fCashToAccount);                                                                                                                                                                  │
│             market.lastImpliedRate = getImpliedRate(                                                                                                                                                                                         │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 totalCashUnderlying.add(netCashToMarket),                                                                                                                                                                                    │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 timeToMaturity                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // It's technically possible that the implied rate is actually exactly zero (or                                                                                                                                                  │
│             // more accurately the natural log rounds down to zero) but we will still fail                                                                                                                                                   │
│             // in this case. If this does happen we may assume that markets are not initialized.                                                                                                                                             │
│             if (market.lastImpliedRate == 0) return (0, 0);                                                                                                                                                                                  │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             _setNewMarketState(                                                                                                                                                                                                              │
│                 market,                                                                                                                                                                                                                      │
│                 cashGroup.assetRate,                                                                                                                                                                                                         │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 netCashToMarket,                                                                                                                                                                                                             │
│                 netCashToReserve                                                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
│     function getImpliedRate(                                                                                                                                                                                                                 │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 rateAnchor,                                                                                                                                                                                                                   │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     ) internal pure returns (uint256) {                                                                                                                                                                                                      │
│         // This will check for exchange rates < Constants.RATE_PRECISION                                                                                                                                                                     │
│         (int256 exchangeRate, bool success) =                                                                                                                                                                                                │
│             _getExchangeRate(totalfCash, totalCashUnderlying, rateScalar, rateAnchor, 0);                                                                                                                                                    │
│         if (!success) return 0;                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         // Uses continuous compounding to calculate the implied rate:                                                                                                                                                                        │
│         // ln(exchangeRate) * Constants.IMPLIED_RATE_TIME / timeToMaturity                                                                                                                                                                   │
│         int128 rate = ABDKMath64x64.fromInt(exchangeRate);                                                                                                                                                                                   │
│         int128 rateScaled = ABDKMath64x64.div(rate, Constants.RATE_PRECISION_64x64);                                                                                                                                                         │
│         // We will not have a negative log here because we check that exchangeRate > Constants.RATE_PRECISION                                                                                                                                │
│         // inside getExchangeRate                                                                                                                                                                                                            │
│         int128 lnRateScaled = ABDKMath64x64.ln(rateScaled);                                                                                                                                                                                  │
│         uint256 lnRate =                                                                                                                                                                                                                     │
│             ABDKMath64x64.toUInt(ABDKMath64x64.mul(lnRateScaled, Constants.RATE_PRECISION_64x64));                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         uint256 impliedRate = lnRate.mul(Constants.IMPLIED_RATE_TIME).div(timeToMaturity);                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         // Implied rates over 429% will overflow, this seems like a safe assumption                                                                                                                                                          │
│         if (impliedRate > type(uint32).max) return 0;                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         return impliedRate;                                                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getTotalLiquidity(MarketParameters memory market) internal view {                                                                                                                                                               │
│         int256 totalLiquidity;                                                                                                                                                                                                               │
│         bytes32 slot = bytes32(uint256(market.storageSlot) + 1);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             totalLiquidity := sload(slot)                                                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│         market.totalLiquidity = totalLiquidity;                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _loadMarketStorage(                                                                                                                                                                                                             │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 settlementDate                                                                                                                                                                                                               │
│     ) private view {                                                                                                                                                                                                                         │
│         // Market object always uses the most current reference time as the settlement date                                                                                                                                                  │
│         bytes32 slot = getSlot(currencyId, settlementDate, maturity);                                                                                                                                                                        │
│         bytes32 data;                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             data := sload(slot)                                                                                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         market.storageSlot = slot;                                                                                                                                                                                                           │
│         market.maturity = maturity;                                                                                                                                                                                                          │
│         market.totalfCash = int256(uint80(uint256(data)));                                                                                                                                                                                   │
│         market.totalAssetCash = int256(uint80(uint256(data >> 80)));                                                                                                                                                                         │
│         market.lastImpliedRate = uint256(uint32(uint256(data >> 160)));                                                                                                                                                                      │
│         market.oracleRate = uint256(uint32(uint256(data >> 192)));                                                                                                                                                                           │
│         market.previousTradeTime = uint256(uint32(uint256(data >> 224)));                                                                                                                                                                    │
│         market.storageState = STORAGE_STATE_NO_CHANGE;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (needsLiquidity) {                                                                                                                                                                                                                │
│             getTotalLiquidity(market);                                                                                                                                                                                                       │
│         } else {                                                                                                                                                                                                                             │
│             market.totalLiquidity = 0;                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function getTotalLiquidity(MarketParameters memory market) internal view {                                                                                                                                                               │
│         int256 totalLiquidity;                                                                                                                                                                                                               │
│         bytes32 slot = bytes32(uint256(market.storageSlot) + 1);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             totalLiquidity := sload(slot)                                                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│         market.totalLiquidity = totalLiquidity;                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _loadMarketStorage(                                                                                                                                                                                                             │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 settlementDate                                                                                                                                                                                                               │
│     ) private view {                                                                                                                                                                                                                         │
│         // Market object always uses the most current reference time as the settlement date                                                                                                                                                  │
│         bytes32 slot = getSlot(currencyId, settlementDate, maturity);                                                                                                                                                                        │
│         bytes32 data;                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             data := sload(slot)                                                                                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         market.storageSlot = slot;                                                                                                                                                                                                           │
│         market.maturity = maturity;                                                                                                                                                                                                          │
│         market.totalfCash = int256(uint80(uint256(data)));                                                                                                                                                                                   │
│         market.totalAssetCash = int256(uint80(uint256(data >> 80)));                                                                                                                                                                         │
│         market.lastImpliedRate = uint256(uint32(uint256(data >> 160)));                                                                                                                                                                      │
│         market.oracleRate = uint256(uint32(uint256(data >> 192)));                                                                                                                                                                           │
│         market.previousTradeTime = uint256(uint32(uint256(data >> 224)));                                                                                                                                                                    │
│         market.storageState = STORAGE_STATE_NO_CHANGE;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (needsLiquidity) {                                                                                                                                                                                                                │
│             getTotalLiquidity(market);                                                                                                                                                                                                       │
│         } else {                                                                                                                                                                                                                             │
│             market.totalLiquidity = 0;                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function loadMarketWithSettlementDate(                                                                                                                                                                                                   │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 rateOracleTimeWindow,                                                                                                                                                                                                        │
│         uint256 settlementDate                                                                                                                                                                                                               │
│     ) internal view {                                                                                                                                                                                                                        │
│         _loadMarketStorage(market, currencyId, maturity, needsLiquidity, settlementDate);                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         market.oracleRate = _updateRateOracle(                                                                                                                                                                                               │
│             market.previousTradeTime,                                                                                                                                                                                                        │
│             market.lastImpliedRate,                                                                                                                                                                                                          │
│             market.oracleRate,                                                                                                                                                                                                               │
│             rateOracleTimeWindow,                                                                                                                                                                                                            │
│             blockTime                                                                                                                                                                                                                        │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function _loadMarketStorage(                                                                                                                                                                                                             │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 settlementDate                                                                                                                                                                                                               │
│     ) private view {                                                                                                                                                                                                                         │
│         // Market object always uses the most current reference time as the settlement date                                                                                                                                                  │
│         bytes32 slot = getSlot(currencyId, settlementDate, maturity);                                                                                                                                                                        │
│         bytes32 data;                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             data := sload(slot)                                                                                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         market.storageSlot = slot;                                                                                                                                                                                                           │
│         market.maturity = maturity;                                                                                                                                                                                                          │
│         market.totalfCash = int256(uint80(uint256(data)));                                                                                                                                                                                   │
│         market.totalAssetCash = int256(uint80(uint256(data >> 80)));                                                                                                                                                                         │
│         market.lastImpliedRate = uint256(uint32(uint256(data >> 160)));                                                                                                                                                                      │
│         market.oracleRate = uint256(uint32(uint256(data >> 192)));                                                                                                                                                                           │
│         market.previousTradeTime = uint256(uint32(uint256(data >> 224)));                                                                                                                                                                    │
│         market.storageState = STORAGE_STATE_NO_CHANGE;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (needsLiquidity) {                                                                                                                                                                                                                │
│             getTotalLiquidity(market);                                                                                                                                                                                                       │
│         } else {                                                                                                                                                                                                                             │
│             market.totalLiquidity = 0;                                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function setMarketStorage(MarketParameters memory market) internal {                                                                                                                                                                     │
│         if (market.storageState == STORAGE_STATE_NO_CHANGE) return;                                                                                                                                                                          │
│         bytes32 slot = market.storageSlot;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (market.storageState & STORAGE_STATE_UPDATE_TRADE != STORAGE_STATE_UPDATE_TRADE) {                                                                                                                                                │
│             // If no trade has occurred then the oracleRate on chain should not update.                                                                                                                                                      │
│             bytes32 oldData;                                                                                                                                                                                                                 │
│             assembly {                                                                                                                                                                                                                       │
│                 oldData := sload(slot)                                                                                                                                                                                                       │
│             }                                                                                                                                                                                                                                │
│             market.oracleRate = uint256(uint32(uint256(oldData >> 192)));                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         require(market.totalfCash >= 0 && market.totalfCash <= type(uint80).max); // dev: market storage totalfCash overflow                                                                                                                 │
│         require(market.totalAssetCash >= 0 && market.totalAssetCash <= type(uint80).max); // dev: market storage totalAssetCash overflow                                                                                                     │
│         require(market.lastImpliedRate >= 0 && market.lastImpliedRate <= type(uint32).max); // dev: market storage lastImpliedRate overflow                                                                                                  │
│         require(market.oracleRate >= 0 && market.oracleRate <= type(uint32).max); // dev: market storage oracleRate overflow                                                                                                                 │
│         require(market.previousTradeTime >= 0 && market.previousTradeTime <= type(uint32).max); // dev: market storage previous trade time overflow                                                                                          │
│                                                                                                                                                                                                                                              │
│         bytes32 data =                                                                                                                                                                                                                       │
│             (bytes32(market.totalfCash) |                                                                                                                                                                                                    │
│                 (bytes32(market.totalAssetCash) << 80) |                                                                                                                                                                                     │
│                 (bytes32(market.lastImpliedRate) << 160) |                                                                                                                                                                                   │
│                 (bytes32(market.oracleRate) << 192) |                                                                                                                                                                                        │
│                 (bytes32(market.previousTradeTime) << 224));                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             market.storageState & STORAGE_STATE_UPDATE_LIQUIDITY == STORAGE_STATE_UPDATE_LIQUIDITY                                                                                                                                           │
│         ) {                                                                                                                                                                                                                                  │
│             require(market.totalLiquidity >= 0 && market.totalLiquidity <= type(uint80).max); // dev: market storage totalLiquidity overflow                                                                                                 │
│             slot = bytes32(uint256(slot) + 1);                                                                                                                                                                                               │
│             bytes32 totalLiquidity = bytes32(market.totalLiquidity);                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(slot, totalLiquidity)                                                                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function finalizeLiquidatedCollateralAndPortfolio(                                                                                                                                                                                       │
│         address liquidateAccount,                                                                                                                                                                                                            │
│         BalanceState memory collateralBalanceState,                                                                                                                                                                                          │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         PortfolioState memory portfolio,                                                                                                                                                                                                     │
│         MarketParameters[] memory markets                                                                                                                                                                                                    │
│     ) internal {                                                                                                                                                                                                                             │
│         // Asset transfer value is set to record liquidity token withdraw balances and should not be                                                                                                                                         │
│         // finalized inside the liquidated collateral. See comment inside liquidateCollateralCurrency                                                                                                                                        │
│         // for more details                                                                                                                                                                                                                  │
│         int256 tmpAssetTransferAmount = collateralBalanceState.netAssetTransferInternalPrecision;                                                                                                                                            │
│         collateralBalanceState.netAssetTransferInternalPrecision = 0;                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // Finalize liquidated account balance                                                                                                                                                                                               │
│         collateralBalanceState.finalize(liquidateAccount, accountContext, false);                                                                                                                                                            │
│         if (accountContext.bitmapCurrencyId == 0) {                                                                                                                                                                                          │
│             // Portfolio updates only happen if the account has liquidity tokens, which can only be the                                                                                                                                      │
│             // case in a non-bitmapped portfolio.                                                                                                                                                                                            │
│             accountContext.storeAssetsAndUpdateContext(                                                                                                                                                                                      │
│                 liquidateAccount,                                                                                                                                                                                                            │
│                 portfolio,                                                                                                                                                                                                                   │
│                 true // is liquidation                                                                                                                                                                                                       │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             for (uint256 i; i < markets.length; i++) {                                                                                                                                                                                       │
│                 // Will short circuit if market does not need to be set                                                                                                                                                                      │
│                 markets.setMarketStorage();                                                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│         accountContext.setAccountContext(liquidateAccount);                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         collateralBalanceState.netAssetTransferInternalPrecision = tmpAssetTransferAmount;                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function setMarketStorage(MarketParameters memory market) internal {                                                                                                                                                                     │
│         if (market.storageState == STORAGE_STATE_NO_CHANGE) return;                                                                                                                                                                          │
│         bytes32 slot = market.storageSlot;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (market.storageState & STORAGE_STATE_UPDATE_TRADE != STORAGE_STATE_UPDATE_TRADE) {                                                                                                                                                │
│             // If no trade has occurred then the oracleRate on chain should not update.                                                                                                                                                      │
│             bytes32 oldData;                                                                                                                                                                                                                 │
│             assembly {                                                                                                                                                                                                                       │
│                 oldData := sload(slot)                                                                                                                                                                                                       │
│             }                                                                                                                                                                                                                                │
│             market.oracleRate = uint256(uint32(uint256(oldData >> 192)));                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         require(market.totalfCash >= 0 && market.totalfCash <= type(uint80).max); // dev: market storage totalfCash overflow                                                                                                                 │
│         require(market.totalAssetCash >= 0 && market.totalAssetCash <= type(uint80).max); // dev: market storage totalAssetCash overflow                                                                                                     │
│         require(market.lastImpliedRate >= 0 && market.lastImpliedRate <= type(uint32).max); // dev: market storage lastImpliedRate overflow                                                                                                  │
│         require(market.oracleRate >= 0 && market.oracleRate <= type(uint32).max); // dev: market storage oracleRate overflow                                                                                                                 │
│         require(market.previousTradeTime >= 0 && market.previousTradeTime <= type(uint32).max); // dev: market storage previous trade time overflow                                                                                          │
│                                                                                                                                                                                                                                              │
│         bytes32 data =                                                                                                                                                                                                                       │
│             (bytes32(market.totalfCash) |                                                                                                                                                                                                    │
│                 (bytes32(market.totalAssetCash) << 80) |                                                                                                                                                                                     │
│                 (bytes32(market.lastImpliedRate) << 160) |                                                                                                                                                                                   │
│                 (bytes32(market.oracleRate) << 192) |                                                                                                                                                                                        │
│                 (bytes32(market.previousTradeTime) << 224));                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             market.storageState & STORAGE_STATE_UPDATE_LIQUIDITY == STORAGE_STATE_UPDATE_LIQUIDITY                                                                                                                                           │
│         ) {                                                                                                                                                                                                                                  │
│             require(market.totalLiquidity >= 0 && market.totalLiquidity <= type(uint80).max); // dev: market storage totalLiquidity overflow                                                                                                 │
│             slot = bytes32(uint256(slot) + 1);                                                                                                                                                                                               │
│             bytes32 totalLiquidity = bytes32(market.totalLiquidity);                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(slot, totalLiquidity)                                                                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getSettlementMarket(                                                                                                                                                                                                            │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 settlementDate                                                                                                                                                                                                               │
│     ) internal view returns (SettlementMarket memory) {                                                                                                                                                                                      │
│         uint256 slot = uint256(getSlot(currencyId, settlementDate, maturity));                                                                                                                                                               │
│         int256 totalLiquidity;                                                                                                                                                                                                               │
│         bytes32 data;                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             data := sload(slot)                                                                                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 totalfCash = int256(uint80(uint256(data)));                                                                                                                                                                                   │
│         int256 totalAssetCash = int256(uint80(uint256(data >> 80)));                                                                                                                                                                         │
│         // Clear the lower 160 bits, this data will be combined with the new totalfCash                                                                                                                                                      │
│         // and totalAssetCash figures.                                                                                                                                                                                                       │
│         data = data & 0xffffffffffffffffffffffff0000000000000000000000000000000000000000;                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         slot = uint256(slot) + 1;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             totalLiquidity := sload(slot)                                                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             SettlementMarket({                                                                                                                                                                                                               │
│                 storageSlot: bytes32(slot - 1),                                                                                                                                                                                              │
│                 totalfCash: totalfCash,                                                                                                                                                                                                      │
│                 totalAssetCash: totalAssetCash,                                                                                                                                                                                              │
│                 totalLiquidity: int256(totalLiquidity),                                                                                                                                                                                      │
│                 data: data                                                                                                                                                                                                                   │
│             });                                                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function setSettlementMarket(SettlementMarket memory market) internal {                                                                                                                                                                  │
│         bytes32 slot = market.storageSlot;                                                                                                                                                                                                   │
│         bytes32 data;                                                                                                                                                                                                                        │
│         require(market.totalfCash >= 0 && market.totalfCash <= type(uint80).max); // dev: settlement market storage totalfCash overflow                                                                                                      │
│         require(market.totalAssetCash >= 0 && market.totalAssetCash <= type(uint80).max); // dev: settlement market storage totalAssetCash overflow                                                                                          │
│         require(market.totalLiquidity >= 0 && market.totalLiquidity <= type(uint80).max); // dev: settlement market storage totalLiquidity overflow                                                                                          │
│                                                                                                                                                                                                                                              │
│         data = (bytes32(market.totalfCash) |                                                                                                                                                                                                 │
│             (bytes32(market.totalAssetCash) << 80) |                                                                                                                                                                                         │
│             bytes32(market.data));                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         // Don't clear the storage even when all liquidity tokens have been removed because we need to use                                                                                                                                   │
│         // the oracle rates to initialize the next set of markets.                                                                                                                                                                           │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         slot = bytes32(uint256(slot) + 1);                                                                                                                                                                                                   │
│         bytes32 totalLiquidity = bytes32(market.totalLiquidity);                                                                                                                                                                             │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, totalLiquidity)                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getfCashGivenCashAmount(                                                                                                                                                                                                        │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 netCashToAccount,                                                                                                                                                                                                             │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 rateAnchor,                                                                                                                                                                                                                   │
│         int256 feeRate,                                                                                                                                                                                                                      │
│         uint256 maxDelta                                                                                                                                                                                                                     │
│     ) internal pure returns (int256) {                                                                                                                                                                                                       │
│         int256 fCashChangeToAccountGuess =                                                                                                                                                                                                   │
│             netCashToAccount.mul(rateAnchor).div(Constants.RATE_PRECISION).neg();                                                                                                                                                            │
│         for (uint8 i; i < 250; i++) {                                                                                                                                                                                                        │
│             (int256 exchangeRate, bool success) =                                                                                                                                                                                            │
│                 _getExchangeRate(                                                                                                                                                                                                            │
│                     totalfCash,                                                                                                                                                                                                              │
│                     totalCashUnderlying,                                                                                                                                                                                                     │
│                     rateScalar,                                                                                                                                                                                                              │
│                     rateAnchor,                                                                                                                                                                                                              │
│                     fCashChangeToAccountGuess                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             require(success); // dev: invalid exchange rate                                                                                                                                                                                  │
│             int256 delta =                                                                                                                                                                                                                   │
│                 _calculateDelta(                                                                                                                                                                                                             │
│                     netCashToAccount,                                                                                                                                                                                                        │
│                     totalfCash,                                                                                                                                                                                                              │
│                     totalCashUnderlying,                                                                                                                                                                                                     │
│                     rateScalar,                                                                                                                                                                                                              │
│                     fCashChangeToAccountGuess,                                                                                                                                                                                               │
│                     exchangeRate,                                                                                                                                                                                                            │
│                     feeRate                                                                                                                                                                                                                  │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             if (delta.abs() <= int256(maxDelta)) return fCashChangeToAccountGuess;                                                                                                                                                           │
│             fCashChangeToAccountGuess = fCashChangeToAccountGuess.sub(delta);                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         revert("No convergence");                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculateDelta(                                                                                                                                                                                                                │
│         int256 cashAmount,                                                                                                                                                                                                                   │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 fCashGuess,                                                                                                                                                                                                                   │
│         int256 exchangeRate,                                                                                                                                                                                                                 │
│         int256 feeRate                                                                                                                                                                                                                       │
│     ) private pure returns (int256) {                                                                                                                                                                                                        │
│         int256 derivative;                                                                                                                                                                                                                   │
│         // rateScalar * (totalfCash - fCash) * (totalCash + fCash)                                                                                                                                                                           │
│         // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                    │
│         int256 denominator =                                                                                                                                                                                                                 │
│             rateScalar.mulInRatePrecision(                                                                                                                                                                                                   │
│                 (totalfCash.sub(fCashGuess)).mul(totalCashUnderlying.add(fCashGuess))                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         if (fCashGuess > 0) {                                                                                                                                                                                                                │
│             // Lending                                                                                                                                                                                                                       │
│             exchangeRate = exchangeRate.divInRatePrecision(feeRate);                                                                                                                                                                         │
│             require(exchangeRate >= Constants.RATE_PRECISION); // dev: rate underflow                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             // (cashAmount / fee) * (totalfCash + totalCash)                                                                                                                                                                                 │
│             // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                │
│             derivative = cashAmount                                                                                                                                                                                                          │
│                 .mul(totalfCash.add(totalCashUnderlying))                                                                                                                                                                                    │
│                 .divInRatePrecision(feeRate);                                                                                                                                                                                                │
│         } else {                                                                                                                                                                                                                             │
│             // Borrowing                                                                                                                                                                                                                     │
│             exchangeRate = exchangeRate.mulInRatePrecision(feeRate);                                                                                                                                                                         │
│             require(exchangeRate >= Constants.RATE_PRECISION); // dev: rate underflow                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             // (cashAmount * fee) * (totalfCash + totalCash)                                                                                                                                                                                 │
│             // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                │
│             derivative = cashAmount.mulInRatePrecision(                                                                                                                                                                                      │
│                 feeRate.mul(totalfCash.add(totalCashUnderlying))                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│         // 1 - numerator / denominator                                                                                                                                                                                                       │
│         // Precision: TOKEN_PRECISION                                                                                                                                                                                                        │
│         derivative = Constants.INTERNAL_TOKEN_PRECISION.sub(derivative.div(denominator));                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // f(fCash) = cashAmount * exchangeRate * fee + fCash                                                                                                                                                                                │
│         // NOTE: exchangeRate at this point already has the fee taken into account                                                                                                                                                           │
│         int256 numerator = cashAmount.mulInRatePrecision(exchangeRate);                                                                                                                                                                      │
│         numerator = numerator.add(fCashGuess);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         // f(fCash) / f'(fCash), note that they are both denominated as cashAmount so use TOKEN_PRECISION                                                                                                                                    │
│         // here instead of RATE_PRECISION                                                                                                                                                                                                    │
│         return numerator.mul(Constants.INTERNAL_TOKEN_PRECISION).div(derivative);                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getfCashGivenCashAmount(                                                                                                                                                                                                        │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 netCashToAccount,                                                                                                                                                                                                             │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 rateAnchor,                                                                                                                                                                                                                   │
│         int256 feeRate,                                                                                                                                                                                                                      │
│         uint256 maxDelta                                                                                                                                                                                                                     │
│     ) internal pure returns (int256) {                                                                                                                                                                                                       │
│         int256 fCashChangeToAccountGuess =                                                                                                                                                                                                   │
│             netCashToAccount.mul(rateAnchor).div(Constants.RATE_PRECISION).neg();                                                                                                                                                            │
│         for (uint8 i; i < 250; i++) {                                                                                                                                                                                                        │
│             (int256 exchangeRate, bool success) =                                                                                                                                                                                            │
│                 _getExchangeRate(                                                                                                                                                                                                            │
│                     totalfCash,                                                                                                                                                                                                              │
│                     totalCashUnderlying,                                                                                                                                                                                                     │
│                     rateScalar,                                                                                                                                                                                                              │
│                     rateAnchor,                                                                                                                                                                                                              │
│                     fCashChangeToAccountGuess                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             require(success); // dev: invalid exchange rate                                                                                                                                                                                  │
│             int256 delta =                                                                                                                                                                                                                   │
│                 _calculateDelta(                                                                                                                                                                                                             │
│                     netCashToAccount,                                                                                                                                                                                                        │
│                     totalfCash,                                                                                                                                                                                                              │
│                     totalCashUnderlying,                                                                                                                                                                                                     │
│                     rateScalar,                                                                                                                                                                                                              │
│                     fCashChangeToAccountGuess,                                                                                                                                                                                               │
│                     exchangeRate,                                                                                                                                                                                                            │
│                     feeRate                                                                                                                                                                                                                  │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             if (delta.abs() <= int256(maxDelta)) return fCashChangeToAccountGuess;                                                                                                                                                           │
│             fCashChangeToAccountGuess = fCashChangeToAccountGuess.sub(delta);                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         revert("No convergence");                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
│     function _calculateDelta(                                                                                                                                                                                                                │
│         int256 cashAmount,                                                                                                                                                                                                                   │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 fCashGuess,                                                                                                                                                                                                                   │
│         int256 exchangeRate,                                                                                                                                                                                                                 │
│         int256 feeRate                                                                                                                                                                                                                       │
│     ) private pure returns (int256) {                                                                                                                                                                                                        │
│         int256 derivative;                                                                                                                                                                                                                   │
│         // rateScalar * (totalfCash - fCash) * (totalCash + fCash)                                                                                                                                                                           │
│         // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                    │
│         int256 denominator =                                                                                                                                                                                                                 │
│             rateScalar.mulInRatePrecision(                                                                                                                                                                                                   │
│                 (totalfCash.sub(fCashGuess)).mul(totalCashUnderlying.add(fCashGuess))                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         if (fCashGuess > 0) {                                                                                                                                                                                                                │
│             // Lending                                                                                                                                                                                                                       │
│             exchangeRate = exchangeRate.divInRatePrecision(feeRate);                                                                                                                                                                         │
│             require(exchangeRate >= Constants.RATE_PRECISION); // dev: rate underflow                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             // (cashAmount / fee) * (totalfCash + totalCash)                                                                                                                                                                                 │
│             // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                │
│             derivative = cashAmount                                                                                                                                                                                                          │
│                 .mul(totalfCash.add(totalCashUnderlying))                                                                                                                                                                                    │
│                 .divInRatePrecision(feeRate);                                                                                                                                                                                                │
│         } else {                                                                                                                                                                                                                             │
│             // Borrowing                                                                                                                                                                                                                     │
│             exchangeRate = exchangeRate.mulInRatePrecision(feeRate);                                                                                                                                                                         │
│             require(exchangeRate >= Constants.RATE_PRECISION); // dev: rate underflow                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             // (cashAmount * fee) * (totalfCash + totalCash)                                                                                                                                                                                 │
│             // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                │
│             derivative = cashAmount.mulInRatePrecision(                                                                                                                                                                                      │
│                 feeRate.mul(totalfCash.add(totalCashUnderlying))                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│         // 1 - numerator / denominator                                                                                                                                                                                                       │
│         // Precision: TOKEN_PRECISION                                                                                                                                                                                                        │
│         derivative = Constants.INTERNAL_TOKEN_PRECISION.sub(derivative.div(denominator));                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // f(fCash) = cashAmount * exchangeRate * fee + fCash                                                                                                                                                                                │
│         // NOTE: exchangeRate at this point already has the fee taken into account                                                                                                                                                           │
│         int256 numerator = cashAmount.mulInRatePrecision(exchangeRate);                                                                                                                                                                      │
│         numerator = numerator.add(fCashGuess);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         // f(fCash) / f'(fCash), note that they are both denominated as cashAmount so use TOKEN_PRECISION                                                                                                                                    │
│         // here instead of RATE_PRECISION                                                                                                                                                                                                    │
│         return numerator.mul(Constants.INTERNAL_TOKEN_PRECISION).div(derivative);                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function buildExchangeRate(uint256 currencyId) internal view returns (ETHRate memory) {                                                                                                                                                  │
│         bytes32 slot = keccak256(abi.encode(currencyId, ETH_RATE_STORAGE_SLOT));                                                                                                                                                             │
│         bytes32 data;                                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             data := sload(slot)                                                                                                                                                                                                              │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 rateDecimals;                                                                                                                                                                                                                 │
│         int256 rate;                                                                                                                                                                                                                         │
│         if (currencyId == Constants.ETH_CURRENCY_ID) {                                                                                                                                                                                       │
│             // ETH rates will just be 1e18, but will still have buffers, haircuts,                                                                                                                                                           │
│             // and liquidation discounts                                                                                                                                                                                                     │
│             rateDecimals = Constants.ETH_DECIMALS;                                                                                                                                                                                           │
│             rate = Constants.ETH_DECIMALS;                                                                                                                                                                                                   │
│         } else {                                                                                                                                                                                                                             │
│             address rateOracle = address(bytes20(data << 96));                                                                                                                                                                               │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 /* uint80 */,                                                                                                                                                                                                                │
│                 rate,                                                                                                                                                                                                                        │
│                 /* uint256 */,                                                                                                                                                                                                               │
│                 /* uint256 */,                                                                                                                                                                                                               │
│                 /* uint80 */                                                                                                                                                                                                                 │
│             ) = AggregatorV2V3Interface(rateOracle).latestRoundData();                                                                                                                                                                       │
│             require(rate > 0, "ExchangeRate: invalid rate");                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             uint8 rateDecimalPlaces = uint8(bytes1(data << 88));                                                                                                                                                                             │
│             rateDecimals = int256(10**rateDecimalPlaces);                                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 bytes1(data << 80) != Constants.BOOL_FALSE /* mustInvert */                                                                                                                                                                  │
│             ) {                                                                                                                                                                                                                              │
│                 rate = rateDecimals.mul(rateDecimals).div(rate);                                                                                                                                                                             │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 buffer = int256(uint8(bytes1(data << 72)));                                                                                                                                                                                   │
│         int256 haircut = int256(uint8(bytes1(data << 64)));                                                                                                                                                                                  │
│         int256 liquidationDiscount = int256(uint8(bytes1(data << 56)));                                                                                                                                                                      │
│         return                                                                                                                                                                                                                               │
│             ETHRate({                                                                                                                                                                                                                        │
│                 rateDecimals: rateDecimals,                                                                                                                                                                                                  │
│                 rate: rate,                                                                                                                                                                                                                  │
│                 buffer: buffer,                                                                                                                                                                                                              │
│                 haircut: haircut,                                                                                                                                                                                                            │
│                 liquidationDiscount: liquidationDiscount                                                                                                                                                                                     │
│             });                                                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getDiscountFactor(uint256 timeToMaturity, uint256 oracleRate)                                                                                                                                                                   │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                        │
│         int128 expValue =                                                                                                                                                                                                                    │
│             ABDKMath64x64.fromUInt(oracleRate.mul(timeToMaturity).div(Constants.IMPLIED_RATE_TIME));                                                                                                                                         │
│         expValue = ABDKMath64x64.div(expValue, Constants.RATE_PRECISION_64x64);                                                                                                                                                              │
│         expValue = ABDKMath64x64.exp(expValue * -1);                                                                                                                                                                                         │
│         expValue = ABDKMath64x64.mul(expValue, Constants.RATE_PRECISION_64x64);                                                                                                                                                              │
│         int256 discountFactor = ABDKMath64x64.toInt(expValue);                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return discountFactor;                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         int256 notional,                                                                                                                                                                                                                     │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 oracleRate                                                                                                                                                                                                                   │
│     ) internal pure returns (int256) {                                                                                                                                                                                                       │
│         if (notional == 0) return 0;                                                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         uint256 timeToMaturity = maturity.sub(blockTime);                                                                                                                                                                                    │
│         int256 discountFactor = getDiscountFactor(timeToMaturity, oracleRate);                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         require(discountFactor <= Constants.RATE_PRECISION); // dev: get present value invalid discount factor                                                                                                                               │
│         return notional.mulInRatePrecision(discountFactor);                                                                                                                                                                                  │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getCashClaims(PortfolioAsset memory token, MarketParameters memory market)                                                                                                                                                      │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256 assetCash, int256 fCash)                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         require(isLiquidityToken(token.assetType) && token.notional >= 0); // dev: invalid asset, get cash claims                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         assetCash = market.totalAssetCash.mul(token.notional).div(market.totalLiquidity);                                                                                                                                                    │
│         fCash = market.totalfCash.mul(token.notional).div(market.totalLiquidity);                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         PortfolioAsset memory liquidityToken = assets;                                                                                                                                                                                       │
│         require(isLiquidityToken(liquidityToken.assetType) && liquidityToken.notional >= 0); // dev: get liquidity token value, not liquidity token                                                                                          │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             (uint256 marketIndex, bool idiosyncratic) =                                                                                                                                                                                      │
│                 DateTime.getMarketIndex(                                                                                                                                                                                                     │
│                     cashGroup.maxMarketIndex,                                                                                                                                                                                                │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime                                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│             // Liquidity tokens can never be idiosyncratic                                                                                                                                                                                   │
│             require(!idiosyncratic); // dev: idiosyncratic liquidity token                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│             // This market will always be initialized, if a liquidity token exists that means the market has some liquidity in it.                                                                                                           │
│             cashGroup.loadMarket(market, marketIndex, true, blockTime);                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 assetCashClaim;                                                                                                                                                                                                               │
│         int256 fCashClaim;                                                                                                                                                                                                                   │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             (assetCashClaim, fCashClaim) = getHaircutCashClaims(liquidityToken, market, cashGroup);                                                                                                                                          │
│         } else {                                                                                                                                                                                                                             │
│             (assetCashClaim, fCashClaim) = getCashClaims(liquidityToken, market);                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Find the matching fCash asset and net off the value, assumes that the portfolio is sorted and                                                                                                                                     │
│         // in that case we know the previous asset will be the matching fCash asset                                                                                                                                                          │
│         if (                                                                                                                                                                                                                                 │
│             index > 0 &&                                                                                                                                                                                                                     │
│             assets.currencyId == liquidityToken.currencyId &&                                                                                                                                                                                │
│             assets.maturity == liquidityToken.maturity &&                                                                                                                                                                                    │
│             assets.assetType == Constants.FCASH_ASSET_TYPE                                                                                                                                                                                   │
│         ) {                                                                                                                                                                                                                                  │
│             // Net off the fCashClaim here and we will discount it to present value in the second pass.                                                                                                                                      │
│             // WARNING: this modifies the portfolio in memory and therefore we cannot store this portfolio!                                                                                                                                  │
│             assets.notional = assets.notional.add(fCashClaim);                                                                                                                                                                               │
│             return (assetCashClaim, 0);                                                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // If not matching fCash asset found then get the pv directly                                                                                                                                                                        │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     fCashClaim,                                                                                                                                                                                                              │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     market.oracleRate                                                                                                                                                                                                        │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getPresentValue(fCashClaim, liquidityToken.maturity, blockTime, market.oracleRate);                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function getCashClaims(PortfolioAsset memory token, MarketParameters memory market)                                                                                                                                                      │
│         internal                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256 assetCash, int256 fCash)                                                                                                                                                                                             │
│     {                                                                                                                                                                                                                                        │
│         require(isLiquidityToken(token.assetType) && token.notional >= 0); // dev: invalid asset, get cash claims                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         assetCash = market.totalAssetCash.mul(token.notional).div(market.totalLiquidity);                                                                                                                                                    │
│         fCash = market.totalfCash.mul(token.notional).div(market.totalLiquidity);                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function getHaircutCashClaims(                                                                                                                                                                                                           │
│         PortfolioAsset memory token,                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup                                                                                                                                                                                                 │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         require(isLiquidityToken(token.assetType) && token.notional >= 0); // dev: invalid asset get haircut cash claims                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         require(token.currencyId == cashGroup.currencyId); // dev: haircut cash claims, currency id mismatch                                                                                                                                 │
│         // This won't overflow, the liquidity token haircut is stored as an uint8                                                                                                                                                            │
│         int256 haircut = int256(cashGroup.getLiquidityHaircut(token.assetType));                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         int256 assetCash =                                                                                                                                                                                                                   │
│             _calcToken(market.totalAssetCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 fCash =                                                                                                                                                                                                                       │
│             _calcToken(market.totalfCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getHaircutCashClaims(                                                                                                                                                                                                           │
│         PortfolioAsset memory token,                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup                                                                                                                                                                                                 │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         require(isLiquidityToken(token.assetType) && token.notional >= 0); // dev: invalid asset get haircut cash claims                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         require(token.currencyId == cashGroup.currencyId); // dev: haircut cash claims, currency id mismatch                                                                                                                                 │
│         // This won't overflow, the liquidity token haircut is stored as an uint8                                                                                                                                                            │
│         int256 haircut = int256(cashGroup.getLiquidityHaircut(token.assetType));                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         int256 assetCash =                                                                                                                                                                                                                   │
│             _calcToken(market.totalAssetCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 fCash =                                                                                                                                                                                                                       │
│             _calcToken(market.totalfCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         PortfolioAsset memory liquidityToken = assets;                                                                                                                                                                                       │
│         require(isLiquidityToken(liquidityToken.assetType) && liquidityToken.notional >= 0); // dev: get liquidity token value, not liquidity token                                                                                          │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             (uint256 marketIndex, bool idiosyncratic) =                                                                                                                                                                                      │
│                 DateTime.getMarketIndex(                                                                                                                                                                                                     │
│                     cashGroup.maxMarketIndex,                                                                                                                                                                                                │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime                                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│             // Liquidity tokens can never be idiosyncratic                                                                                                                                                                                   │
│             require(!idiosyncratic); // dev: idiosyncratic liquidity token                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│             // This market will always be initialized, if a liquidity token exists that means the market has some liquidity in it.                                                                                                           │
│             cashGroup.loadMarket(market, marketIndex, true, blockTime);                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 assetCashClaim;                                                                                                                                                                                                               │
│         int256 fCashClaim;                                                                                                                                                                                                                   │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             (assetCashClaim, fCashClaim) = getHaircutCashClaims(liquidityToken, market, cashGroup);                                                                                                                                          │
│         } else {                                                                                                                                                                                                                             │
│             (assetCashClaim, fCashClaim) = getCashClaims(liquidityToken, market);                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Find the matching fCash asset and net off the value, assumes that the portfolio is sorted and                                                                                                                                     │
│         // in that case we know the previous asset will be the matching fCash asset                                                                                                                                                          │
│         if (                                                                                                                                                                                                                                 │
│             index > 0 &&                                                                                                                                                                                                                     │
│             assets.currencyId == liquidityToken.currencyId &&                                                                                                                                                                                │
│             assets.maturity == liquidityToken.maturity &&                                                                                                                                                                                    │
│             assets.assetType == Constants.FCASH_ASSET_TYPE                                                                                                                                                                                   │
│         ) {                                                                                                                                                                                                                                  │
│             // Net off the fCashClaim here and we will discount it to present value in the second pass.                                                                                                                                      │
│             // WARNING: this modifies the portfolio in memory and therefore we cannot store this portfolio!                                                                                                                                  │
│             assets.notional = assets.notional.add(fCashClaim);                                                                                                                                                                               │
│             return (assetCashClaim, 0);                                                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // If not matching fCash asset found then get the pv directly                                                                                                                                                                        │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     fCashClaim,                                                                                                                                                                                                              │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     market.oracleRate                                                                                                                                                                                                        │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getPresentValue(fCashClaim, liquidityToken.maturity, blockTime, market.oracleRate);                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function getHaircutCashClaims(                                                                                                                                                                                                           │
│         PortfolioAsset memory token,                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup                                                                                                                                                                                                 │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         require(isLiquidityToken(token.assetType) && token.notional >= 0); // dev: invalid asset get haircut cash claims                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         require(token.currencyId == cashGroup.currencyId); // dev: haircut cash claims, currency id mismatch                                                                                                                                 │
│         // This won't overflow, the liquidity token haircut is stored as an uint8                                                                                                                                                            │
│         int256 haircut = int256(cashGroup.getLiquidityHaircut(token.assetType));                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         int256 assetCash =                                                                                                                                                                                                                   │
│             _calcToken(market.totalAssetCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 fCash =                                                                                                                                                                                                                       │
│             _calcToken(market.totalfCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         PortfolioAsset memory liquidityToken = assets;                                                                                                                                                                                       │
│         require(isLiquidityToken(liquidityToken.assetType) && liquidityToken.notional >= 0); // dev: get liquidity token value, not liquidity token                                                                                          │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             (uint256 marketIndex, bool idiosyncratic) =                                                                                                                                                                                      │
│                 DateTime.getMarketIndex(                                                                                                                                                                                                     │
│                     cashGroup.maxMarketIndex,                                                                                                                                                                                                │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime                                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│             // Liquidity tokens can never be idiosyncratic                                                                                                                                                                                   │
│             require(!idiosyncratic); // dev: idiosyncratic liquidity token                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│             // This market will always be initialized, if a liquidity token exists that means the market has some liquidity in it.                                                                                                           │
│             cashGroup.loadMarket(market, marketIndex, true, blockTime);                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 assetCashClaim;                                                                                                                                                                                                               │
│         int256 fCashClaim;                                                                                                                                                                                                                   │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             (assetCashClaim, fCashClaim) = getHaircutCashClaims(liquidityToken, market, cashGroup);                                                                                                                                          │
│         } else {                                                                                                                                                                                                                             │
│             (assetCashClaim, fCashClaim) = getCashClaims(liquidityToken, market);                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Find the matching fCash asset and net off the value, assumes that the portfolio is sorted and                                                                                                                                     │
│         // in that case we know the previous asset will be the matching fCash asset                                                                                                                                                          │
│         if (                                                                                                                                                                                                                                 │
│             index > 0 &&                                                                                                                                                                                                                     │
│             assets.currencyId == liquidityToken.currencyId &&                                                                                                                                                                                │
│             assets.maturity == liquidityToken.maturity &&                                                                                                                                                                                    │
│             assets.assetType == Constants.FCASH_ASSET_TYPE                                                                                                                                                                                   │
│         ) {                                                                                                                                                                                                                                  │
│             // Net off the fCashClaim here and we will discount it to present value in the second pass.                                                                                                                                      │
│             // WARNING: this modifies the portfolio in memory and therefore we cannot store this portfolio!                                                                                                                                  │
│             assets.notional = assets.notional.add(fCashClaim);                                                                                                                                                                               │
│             return (assetCashClaim, 0);                                                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // If not matching fCash asset found then get the pv directly                                                                                                                                                                        │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     fCashClaim,                                                                                                                                                                                                              │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     market.oracleRate                                                                                                                                                                                                        │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getPresentValue(fCashClaim, liquidityToken.maturity, blockTime, market.oracleRate);                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function getHaircutCashClaims(                                                                                                                                                                                                           │
│         PortfolioAsset memory token,                                                                                                                                                                                                         │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup                                                                                                                                                                                                 │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         require(isLiquidityToken(token.assetType) && token.notional >= 0); // dev: invalid asset get haircut cash claims                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         require(token.currencyId == cashGroup.currencyId); // dev: haircut cash claims, currency id mismatch                                                                                                                                 │
│         // This won't overflow, the liquidity token haircut is stored as an uint8                                                                                                                                                            │
│         int256 haircut = int256(cashGroup.getLiquidityHaircut(token.assetType));                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         int256 assetCash =                                                                                                                                                                                                                   │
│             _calcToken(market.totalAssetCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 fCash =                                                                                                                                                                                                                       │
│             _calcToken(market.totalfCash, token.notional, haircut, market.totalLiquidity);                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getNetCashGroupValue(                                                                                                                                                                                                           │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 portfolioIndex                                                                                                                                                                                                               │
│     ) internal view returns (int256, uint256) {                                                                                                                                                                                              │
│         int256 presentValueAsset;                                                                                                                                                                                                            │
│         int256 presentValueUnderlying;                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         // First calculate value of liquidity tokens because we need to net off fCash value                                                                                                                                                  │
│         // before discounting to present value                                                                                                                                                                                               │
│         for (uint256 i = portfolioIndex; i < assets.length; i++) {                                                                                                                                                                           │
│             if (!isLiquidityToken(assets.assetType)) continue;                                                                                                                                                                               │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             (int256 assetCashClaim, int256 pv) =                                                                                                                                                                                             │
│                 getLiquidityTokenValue(                                                                                                                                                                                                      │
│                     i,                                                                                                                                                                                                                       │
│                     cashGroup,                                                                                                                                                                                                               │
│                     market,                                                                                                                                                                                                                  │
│                     assets,                                                                                                                                                                                                                  │
│                     blockTime,                                                                                                                                                                                                               │
│                     true // risk adjusted                                                                                                                                                                                                    │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             presentValueAsset = presentValueAsset.add(assetCashClaim);                                                                                                                                                                       │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 j = portfolioIndex;                                                                                                                                                                                                          │
│         for (; j < assets.length; j++) {                                                                                                                                                                                                     │
│             if (assets.assetType != Constants.FCASH_ASSET_TYPE) continue;                                                                                                                                                                    │
│             // If we hit a different currency id then we've accounted for all assets in this currency                                                                                                                                        │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             uint256 maturity = assets.maturity;                                                                                                                                                                                              │
│             uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     assets.notional,                                                                                                                                                                                                         │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         presentValueAsset = presentValueAsset.add(                                                                                                                                                                                           │
│             cashGroup.assetRate.convertFromUnderlying(presentValueUnderlying)                                                                                                                                                                │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (presentValueAsset, j);                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getNetCashGroupValue(                                                                                                                                                                                                           │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 portfolioIndex                                                                                                                                                                                                               │
│     ) internal view returns (int256, uint256) {                                                                                                                                                                                              │
│         int256 presentValueAsset;                                                                                                                                                                                                            │
│         int256 presentValueUnderlying;                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         // First calculate value of liquidity tokens because we need to net off fCash value                                                                                                                                                  │
│         // before discounting to present value                                                                                                                                                                                               │
│         for (uint256 i = portfolioIndex; i < assets.length; i++) {                                                                                                                                                                           │
│             if (!isLiquidityToken(assets.assetType)) continue;                                                                                                                                                                               │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             (int256 assetCashClaim, int256 pv) =                                                                                                                                                                                             │
│                 getLiquidityTokenValue(                                                                                                                                                                                                      │
│                     i,                                                                                                                                                                                                                       │
│                     cashGroup,                                                                                                                                                                                                               │
│                     market,                                                                                                                                                                                                                  │
│                     assets,                                                                                                                                                                                                                  │
│                     blockTime,                                                                                                                                                                                                               │
│                     true // risk adjusted                                                                                                                                                                                                    │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             presentValueAsset = presentValueAsset.add(assetCashClaim);                                                                                                                                                                       │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 j = portfolioIndex;                                                                                                                                                                                                          │
│         for (; j < assets.length; j++) {                                                                                                                                                                                                     │
│             if (assets.assetType != Constants.FCASH_ASSET_TYPE) continue;                                                                                                                                                                    │
│             // If we hit a different currency id then we've accounted for all assets in this currency                                                                                                                                        │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             uint256 maturity = assets.maturity;                                                                                                                                                                                              │
│             uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     assets.notional,                                                                                                                                                                                                         │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         presentValueAsset = presentValueAsset.add(                                                                                                                                                                                           │
│             cashGroup.assetRate.convertFromUnderlying(presentValueUnderlying)                                                                                                                                                                │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (presentValueAsset, j);                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function _getNTokenHaircutAssetPV(                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         nTokenPortfolio memory nToken,                                                                                                                                                                                                       │
│         int256 tokenBalance,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, bytes6) {                                                                                                                                                                                               │
│         nTokenHandler.loadNTokenPortfolioNoCashGroup(cashGroup.currencyId, nToken);                                                                                                                                                          │
│         nToken.cashGroup = cashGroup;                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 nTokenAssetPV,                                                                                                                                                                                                            │
│             /* ifCashBitmap */                                                                                                                                                                                                               │
│         ) = nToken.getNTokenAssetPV(blockTime);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 nTokenHaircutAssetPV =                                                                                                                                                                                                        │
│             tokenBalance                                                                                                                                                                                                                     │
│                 .mul(nTokenAssetPV)                                                                                                                                                                                                          │
│                 .mul(int256(uint8(nToken.parameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                                      │
│                 .div(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(nToken.totalSupply);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (nTokenHaircutAssetPV, nToken.parameters);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function _getNTokenHaircutAssetPV(                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         nTokenPortfolio memory nToken,                                                                                                                                                                                                       │
│         int256 tokenBalance,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, bytes6) {                                                                                                                                                                                               │
│         nTokenHandler.loadNTokenPortfolioNoCashGroup(cashGroup.currencyId, nToken);                                                                                                                                                          │
│         nToken.cashGroup = cashGroup;                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 nTokenAssetPV,                                                                                                                                                                                                            │
│             /* ifCashBitmap */                                                                                                                                                                                                               │
│         ) = nToken.getNTokenAssetPV(blockTime);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 nTokenHaircutAssetPV =                                                                                                                                                                                                        │
│             tokenBalance                                                                                                                                                                                                                     │
│                 .mul(nTokenAssetPV)                                                                                                                                                                                                          │
│                 .mul(int256(uint8(nToken.parameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                                      │
│                 .div(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(nToken.totalSupply);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (nTokenHaircutAssetPV, nToken.parameters);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function _getPortfolioAndNTokenAssetValue(                                                                                                                                                                                               │
│         FreeCollateralFactors memory factors,                                                                                                                                                                                                │
│         int256 nTokenBalance,                                                                                                                                                                                                                │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256 netPortfolioValue,                                                                                                                                                                                                        │
│             int256 nTokenHaircutAssetValue,                                                                                                                                                                                                  │
│             bytes6 nTokenParameters                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         // If the next asset matches the currency id then we need to calculate the cash group value                                                                                                                                          │
│         if (                                                                                                                                                                                                                                 │
│             factors.portfolioIndex < factors.portfolio.length &&                                                                                                                                                                             │
│             factors.portfolio.currencyId == factors.cashGroup.currencyId                                                                                                                                                                     │
│         ) {                                                                                                                                                                                                                                  │
│             (netPortfolioValue, factors.portfolioIndex) = AssetHandler.getNetCashGroupValue(                                                                                                                                                 │
│                 factors.portfolio,                                                                                                                                                                                                           │
│                 factors.cashGroup,                                                                                                                                                                                                           │
│                 factors.market,                                                                                                                                                                                                              │
│                 blockTime,                                                                                                                                                                                                                   │
│                 factors.portfolioIndex                                                                                                                                                                                                       │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (nTokenBalance > 0) {                                                                                                                                                                                                             │
│             (nTokenHaircutAssetValue, nTokenParameters) = _getNTokenHaircutAssetPV(                                                                                                                                                          │
│                 factors.cashGroup,                                                                                                                                                                                                           │
│                 factors.nToken,                                                                                                                                                                                                              │
│                 nTokenBalance,                                                                                                                                                                                                               │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function _getNTokenHaircutAssetPV(                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         nTokenPortfolio memory nToken,                                                                                                                                                                                                       │
│         int256 tokenBalance,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, bytes6) {                                                                                                                                                                                               │
│         nTokenHandler.loadNTokenPortfolioNoCashGroup(cashGroup.currencyId, nToken);                                                                                                                                                          │
│         nToken.cashGroup = cashGroup;                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 nTokenAssetPV,                                                                                                                                                                                                            │
│             /* ifCashBitmap */                                                                                                                                                                                                               │
│         ) = nToken.getNTokenAssetPV(blockTime);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 nTokenHaircutAssetPV =                                                                                                                                                                                                        │
│             tokenBalance                                                                                                                                                                                                                     │
│                 .mul(nTokenAssetPV)                                                                                                                                                                                                          │
│                 .mul(int256(uint8(nToken.parameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                                      │
│                 .div(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(nToken.totalSupply);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (nTokenHaircutAssetPV, nToken.parameters);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function _getPortfolioAndNTokenAssetValue(                                                                                                                                                                                               │
│         FreeCollateralFactors memory factors,                                                                                                                                                                                                │
│         int256 nTokenBalance,                                                                                                                                                                                                                │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256 netPortfolioValue,                                                                                                                                                                                                        │
│             int256 nTokenHaircutAssetValue,                                                                                                                                                                                                  │
│             bytes6 nTokenParameters                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         // If the next asset matches the currency id then we need to calculate the cash group value                                                                                                                                          │
│         if (                                                                                                                                                                                                                                 │
│             factors.portfolioIndex < factors.portfolio.length &&                                                                                                                                                                             │
│             factors.portfolio.currencyId == factors.cashGroup.currencyId                                                                                                                                                                     │
│         ) {                                                                                                                                                                                                                                  │
│             (netPortfolioValue, factors.portfolioIndex) = AssetHandler.getNetCashGroupValue(                                                                                                                                                 │
│                 factors.portfolio,                                                                                                                                                                                                           │
│                 factors.cashGroup,                                                                                                                                                                                                           │
│                 factors.market,                                                                                                                                                                                                              │
│                 blockTime,                                                                                                                                                                                                                   │
│                 factors.portfolioIndex                                                                                                                                                                                                       │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (nTokenBalance > 0) {                                                                                                                                                                                                             │
│             (nTokenHaircutAssetValue, nTokenParameters) = _getNTokenHaircutAssetPV(                                                                                                                                                          │
│                 factors.cashGroup,                                                                                                                                                                                                           │
│                 factors.nToken,                                                                                                                                                                                                              │
│                 nTokenBalance,                                                                                                                                                                                                               │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function _getNTokenHaircutAssetPV(                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         nTokenPortfolio memory nToken,                                                                                                                                                                                                       │
│         int256 tokenBalance,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, bytes6) {                                                                                                                                                                                               │
│         nTokenHandler.loadNTokenPortfolioNoCashGroup(cashGroup.currencyId, nToken);                                                                                                                                                          │
│         nToken.cashGroup = cashGroup;                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 nTokenAssetPV,                                                                                                                                                                                                            │
│             /* ifCashBitmap */                                                                                                                                                                                                               │
│         ) = nToken.getNTokenAssetPV(blockTime);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 nTokenHaircutAssetPV =                                                                                                                                                                                                        │
│             tokenBalance                                                                                                                                                                                                                     │
│                 .mul(nTokenAssetPV)                                                                                                                                                                                                          │
│                 .mul(int256(uint8(nToken.parameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                                      │
│                 .div(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(nToken.totalSupply);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (nTokenHaircutAssetPV, nToken.parameters);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function _getBitmapBalanceValue(                                                                                                                                                                                                         │
│         address account,                                                                                                                                                                                                                     │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         FreeCollateralFactors memory factors                                                                                                                                                                                                 │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256 cashBalance,                                                                                                                                                                                                              │
│             int256 nTokenHaircutAssetValue,                                                                                                                                                                                                  │
│             bytes6 nTokenParameters                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 nTokenBalance;                                                                                                                                                                                                                │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             cashBalance,                                                                                                                                                                                                                     │
│             nTokenBalance,                                                                                                                                                                                                                   │
│             /* lastClaimTime */,                                                                                                                                                                                                             │
│             /* lastClaimIntegralSupply */                                                                                                                                                                                                    │
│         ) = BalanceHandler.getBalanceStorage(account, accountContext.bitmapCurrencyId);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         if (nTokenBalance > 0) {                                                                                                                                                                                                             │
│             (nTokenHaircutAssetValue, nTokenParameters) = _getNTokenHaircutAssetPV(                                                                                                                                                          │
│                 factors.cashGroup,                                                                                                                                                                                                           │
│                 factors.nToken,                                                                                                                                                                                                              │
│                 nTokenBalance,                                                                                                                                                                                                               │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function _getNTokenHaircutAssetPV(                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         nTokenPortfolio memory nToken,                                                                                                                                                                                                       │
│         int256 tokenBalance,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, bytes6) {                                                                                                                                                                                               │
│         nTokenHandler.loadNTokenPortfolioNoCashGroup(cashGroup.currencyId, nToken);                                                                                                                                                          │
│         nToken.cashGroup = cashGroup;                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 nTokenAssetPV,                                                                                                                                                                                                            │
│             /* ifCashBitmap */                                                                                                                                                                                                               │
│         ) = nToken.getNTokenAssetPV(blockTime);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 nTokenHaircutAssetPV =                                                                                                                                                                                                        │
│             tokenBalance                                                                                                                                                                                                                     │
│                 .mul(nTokenAssetPV)                                                                                                                                                                                                          │
│                 .mul(int256(uint8(nToken.parameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                                      │
│                 .div(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(nToken.totalSupply);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (nTokenHaircutAssetPV, nToken.parameters);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function _getBitmapBalanceValue(                                                                                                                                                                                                         │
│         address account,                                                                                                                                                                                                                     │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         FreeCollateralFactors memory factors                                                                                                                                                                                                 │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256 cashBalance,                                                                                                                                                                                                              │
│             int256 nTokenHaircutAssetValue,                                                                                                                                                                                                  │
│             bytes6 nTokenParameters                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 nTokenBalance;                                                                                                                                                                                                                │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             cashBalance,                                                                                                                                                                                                                     │
│             nTokenBalance,                                                                                                                                                                                                                   │
│             /* lastClaimTime */,                                                                                                                                                                                                             │
│             /* lastClaimIntegralSupply */                                                                                                                                                                                                    │
│         ) = BalanceHandler.getBalanceStorage(account, accountContext.bitmapCurrencyId);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         if (nTokenBalance > 0) {                                                                                                                                                                                                             │
│             (nTokenHaircutAssetValue, nTokenParameters) = _getNTokenHaircutAssetPV(                                                                                                                                                          │
│                 factors.cashGroup,                                                                                                                                                                                                           │
│                 factors.nToken,                                                                                                                                                                                                              │
│                 nTokenBalance,                                                                                                                                                                                                               │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function _getNTokenHaircutAssetPV(                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         nTokenPortfolio memory nToken,                                                                                                                                                                                                       │
│         int256 tokenBalance,                                                                                                                                                                                                                 │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, bytes6) {                                                                                                                                                                                               │
│         nTokenHandler.loadNTokenPortfolioNoCashGroup(cashGroup.currencyId, nToken);                                                                                                                                                          │
│         nToken.cashGroup = cashGroup;                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             int256 nTokenAssetPV,                                                                                                                                                                                                            │
│             /* ifCashBitmap */                                                                                                                                                                                                               │
│         ) = nToken.getNTokenAssetPV(blockTime);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         int256 nTokenHaircutAssetPV =                                                                                                                                                                                                        │
│             tokenBalance                                                                                                                                                                                                                     │
│                 .mul(nTokenAssetPV)                                                                                                                                                                                                          │
│                 .mul(int256(uint8(nToken.parameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                                      │
│                 .div(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(nToken.totalSupply);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (nTokenHaircutAssetPV, nToken.parameters);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _updateNetETHValue(                                                                                                                                                                                                             │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         int256 netLocalAssetValue,                                                                                                                                                                                                           │
│         FreeCollateralFactors memory factors                                                                                                                                                                                                 │
│     ) private view returns (ETHRate memory) {                                                                                                                                                                                                │
│         ETHRate memory ethRate = ExchangeRate.buildExchangeRate(currencyId);                                                                                                                                                                 │
│         factors.netETHValue = factors.netETHValue.add(                                                                                                                                                                                       │
│             ethRate.convertToETH(factors.assetRate.convertToUnderlying(netLocalAssetValue))                                                                                                                                                  │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return ethRate;                                                                                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidationFactors(                                                                                                                                                                                                          │
│         address account,                                                                                                                                                                                                                     │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 localCurrencyId,                                                                                                                                                                                                             │
│         uint256 collateralCurrencyId                                                                                                                                                                                                         │
│     ) internal returns (LiquidationFactors memory, PortfolioAsset[] memory) {                                                                                                                                                                │
│         FreeCollateralFactors memory factors;                                                                                                                                                                                                │
│         LiquidationFactors memory liquidationFactors;                                                                                                                                                                                        │
│         // This is only set to reduce the stack size                                                                                                                                                                                         │
│         liquidationFactors.account = account;                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         if (accountContext.bitmapCurrencyId != 0) {                                                                                                                                                                                          │
│             factors.cashGroup = CashGroup.buildCashGroupStateful(accountContext.bitmapCurrencyId);                                                                                                                                           │
│             (int256 netCashBalance, int256 nTokenHaircutAssetValue, bytes6 nTokenParameters) =                                                                                                                                               │
│                 _getBitmapBalanceValue(account, blockTime, accountContext, factors);                                                                                                                                                         │
│             int256 portfolioBalance =                                                                                                                                                                                                        │
│                 _getBitmapPortfolioValue(account, blockTime, accountContext, factors);                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             int256 netLocalAssetValue =                                                                                                                                                                                                      │
│                 netCashBalance.add(nTokenHaircutAssetValue).add(portfolioBalance);                                                                                                                                                           │
│             factors.assetRate = factors.cashGroup.assetRate;                                                                                                                                                                                 │
│             ETHRate memory ethRate =                                                                                                                                                                                                         │
│                 _updateNetETHValue(accountContext.bitmapCurrencyId, netLocalAssetValue, factors);                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // If the bitmap currency id can only ever be the local currency where debt is held. During enable bitmap we check that                                                                                                          │
│             // the account has no assets in their portfolio and no cash debts.                                                                                                                                                               │
│             if (accountContext.bitmapCurrencyId == localCurrencyId) {                                                                                                                                                                        │
│                 liquidationFactors.cashGroup = factors.cashGroup;                                                                                                                                                                            │
│                 liquidationFactors.localAssetAvailable = netLocalAssetValue;                                                                                                                                                                 │
│                 liquidationFactors.localETHRate = ethRate;                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│                 // This will be the case during local currency or local fCash liquidation                                                                                                                                                    │
│                 if (collateralCurrencyId == 0) {                                                                                                                                                                                             │
│                     liquidationFactors.nTokenHaircutAssetValue = nTokenHaircutAssetValue;                                                                                                                                                    │
│                     liquidationFactors.nTokenParameters = nTokenParameters;                                                                                                                                                                  │
│                 }                                                                                                                                                                                                                            │
│             }                                                                                                                                                                                                                                │
│         } else {                                                                                                                                                                                                                             │
│             factors.portfolio = PortfolioHandler.getSortedPortfolio(                                                                                                                                                                         │
│                 account,                                                                                                                                                                                                                     │
│                 accountContext.assetArrayLength                                                                                                                                                                                              │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         bytes18 currencies = accountContext.activeCurrencies;                                                                                                                                                                                │
│         while (currencies != 0) {                                                                                                                                                                                                            │
│             bytes2 currencyBytes = bytes2(currencies);                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             // This next bit of code here is annoyingly structured to get around stack size issues                                                                                                                                           │
│             bool setLiquidationFactors;                                                                                                                                                                                                      │
│             {                                                                                                                                                                                                                                │
│                 uint256 tempId = uint256(uint16(currencyBytes & Constants.UNMASK_FLAGS));                                                                                                                                                    │
│                 setLiquidationFactors =                                                                                                                                                                                                      │
│                     (tempId == localCurrencyId && collateralCurrencyId == 0) ||                                                                                                                                                              │
│                     tempId == collateralCurrencyId;                                                                                                                                                                                          │
│             }                                                                                                                                                                                                                                │
│             int256 netLocalAssetValue =                                                                                                                                                                                                      │
│                 _calculateLiquidationAssetValue(                                                                                                                                                                                             │
│                     factors,                                                                                                                                                                                                                 │
│                     liquidationFactors,                                                                                                                                                                                                      │
│                     currencyBytes,                                                                                                                                                                                                           │
│                     setLiquidationFactors,                                                                                                                                                                                                   │
│                     blockTime                                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             uint256 currencyId = uint256(uint16(currencyBytes & Constants.UNMASK_FLAGS));                                                                                                                                                    │
│             ETHRate memory ethRate = _updateNetETHValue(currencyId, netLocalAssetValue, factors);                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             if (currencyId == collateralCurrencyId) {                                                                                                                                                                                        │
│                 // Ensure that this is set even if the cash group is not loaded                                                                                                                                                              │
│                 liquidationFactors.cashGroup.assetRate = factors.assetRate;                                                                                                                                                                  │
│                 liquidationFactors.collateralAssetAvailable = netLocalAssetValue;                                                                                                                                                            │
│                 liquidationFactors.collateralETHRate = ethRate;                                                                                                                                                                              │
│             } else if (currencyId == localCurrencyId) {                                                                                                                                                                                      │
│                 liquidationFactors.localAssetAvailable = netLocalAssetValue;                                                                                                                                                                 │
│                 liquidationFactors.localETHRate = ethRate;                                                                                                                                                                                   │
│                 liquidationFactors.localAssetRate = factors.assetRate;                                                                                                                                                                       │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             currencies = currencies << 16;                                                                                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         liquidationFactors.netETHValue = factors.netETHValue;                                                                                                                                                                                │
│         require(liquidationFactors.netETHValue < 0, "Sufficient collateral");                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         // Refetch the portfolio if it exists, AssetHandler.getNetCashValue updates values in memory to do fCash                                                                                                                             │
│         // netting which will make further calculations incorrect.                                                                                                                                                                           │
│         if (accountContext.assetArrayLength > 0) {                                                                                                                                                                                           │
│             factors.portfolio = PortfolioHandler.getSortedPortfolio(                                                                                                                                                                         │
│                 account,                                                                                                                                                                                                                     │
│                 accountContext.assetArrayLength                                                                                                                                                                                              │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (liquidationFactors, factors.portfolio);                                                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
│     function _updateNetETHValue(                                                                                                                                                                                                             │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         int256 netLocalAssetValue,                                                                                                                                                                                                           │
│         FreeCollateralFactors memory factors                                                                                                                                                                                                 │
│     ) private view returns (ETHRate memory) {                                                                                                                                                                                                │
│         ETHRate memory ethRate = ExchangeRate.buildExchangeRate(currencyId);                                                                                                                                                                 │
│         factors.netETHValue = factors.netETHValue.add(                                                                                                                                                                                       │
│             ethRate.convertToETH(factors.assetRate.convertToUnderlying(netLocalAssetValue))                                                                                                                                                  │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return ethRate;                                                                                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getFreeCollateralView(                                                                                                                                                                                                          │
│         address account,                                                                                                                                                                                                                     │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal view returns (int256, int256[] memory) {                                                                                                                                                                                      │
│         FreeCollateralFactors memory factors;                                                                                                                                                                                                │
│         uint256 netLocalIndex;                                                                                                                                                                                                               │
│         int256[] memory netLocalAssetValues = new int256[](10);                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         if (accountContext.bitmapCurrencyId != 0) {                                                                                                                                                                                          │
│             factors.cashGroup = CashGroup.buildCashGroupView(accountContext.bitmapCurrencyId);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 int256 netCashBalance,                                                                                                                                                                                                       │
│                 int256 nTokenHaircutAssetValue,                                                                                                                                                                                              │
│                 /* nTokenParameters */                                                                                                                                                                                                       │
│             ) = _getBitmapBalanceValue(account, blockTime, accountContext, factors);                                                                                                                                                         │
│             int256 portfolioBalance =                                                                                                                                                                                                        │
│                 _getBitmapPortfolioValue(account, blockTime, accountContext, factors);                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             netLocalAssetValues = netCashBalance.add(nTokenHaircutAssetValue).add(                                                                                                                                                           │
│                 portfolioBalance                                                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│             factors.assetRate = factors.cashGroup.assetRate;                                                                                                                                                                                 │
│             _updateNetETHValue(                                                                                                                                                                                                              │
│                 accountContext.bitmapCurrencyId,                                                                                                                                                                                             │
│                 netLocalAssetValues,                                                                                                                                                                                                         │
│                 factors                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│             netLocalIndex++;                                                                                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             factors.portfolio = PortfolioHandler.getSortedPortfolio(                                                                                                                                                                         │
│                 account,                                                                                                                                                                                                                     │
│                 accountContext.assetArrayLength                                                                                                                                                                                              │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         bytes18 currencies = accountContext.activeCurrencies;                                                                                                                                                                                │
│         while (currencies != 0) {                                                                                                                                                                                                            │
│             bytes2 currencyBytes = bytes2(currencies);                                                                                                                                                                                       │
│             uint256 currencyId = uint256(uint16(currencyBytes & Constants.UNMASK_FLAGS));                                                                                                                                                    │
│             int256 nTokenBalance;                                                                                                                                                                                                            │
│             (netLocalAssetValues, nTokenBalance) = _getCurrencyBalances(                                                                                                                                                                     │
│                 account,                                                                                                                                                                                                                     │
│                 currencyBytes                                                                                                                                                                                                                │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (_isActiveInPortfolio(currencyBytes) || nTokenBalance > 0) {                                                                                                                                                                  │
│                 factors.cashGroup = CashGroup.buildCashGroupView(currencyId);                                                                                                                                                                │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 (                                                                                                                                                                                                                            │
│                     int256 netPortfolioValue,                                                                                                                                                                                                │
│                     int256 nTokenHaircutAssetValue,                                                                                                                                                                                          │
│                     /* nTokenParameters */                                                                                                                                                                                                   │
│                 ) = _getPortfolioAndNTokenAssetValue(factors, nTokenBalance, blockTime);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│                 netLocalAssetValues = netLocalAssetValues                                                                                                                                                                                    │
│                     .add(netPortfolioValue)                                                                                                                                                                                                  │
│                     .add(nTokenHaircutAssetValue);                                                                                                                                                                                           │
│                 factors.assetRate = factors.cashGroup.assetRate;                                                                                                                                                                             │
│             } else {                                                                                                                                                                                                                         │
│                 factors.assetRate = AssetRate.buildAssetRateView(currencyId);                                                                                                                                                                │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             _updateNetETHValue(currencyId, netLocalAssetValues, factors);                                                                                                                                                                    │
│             netLocalIndex++;                                                                                                                                                                                                                 │
│             currencies = currencies << 16;                                                                                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (factors.netETHValue, netLocalAssetValues);                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function _updateNetETHValue(                                                                                                                                                                                                             │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         int256 netLocalAssetValue,                                                                                                                                                                                                           │
│         FreeCollateralFactors memory factors                                                                                                                                                                                                 │
│     ) private view returns (ETHRate memory) {                                                                                                                                                                                                │
│         ETHRate memory ethRate = ExchangeRate.buildExchangeRate(currencyId);                                                                                                                                                                 │
│         factors.netETHValue = factors.netETHValue.add(                                                                                                                                                                                       │
│             ethRate.convertToETH(factors.assetRate.convertToUnderlying(netLocalAssetValue))                                                                                                                                                  │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return ethRate;                                                                                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getFreeCollateralStateful(                                                                                                                                                                                                      │
│         address account,                                                                                                                                                                                                                     │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) internal returns (int256, bool) {                                                                                                                                                                                                      │
│         FreeCollateralFactors memory factors;                                                                                                                                                                                                │
│         bool hasCashDebt;                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (accountContext.bitmapCurrencyId != 0) {                                                                                                                                                                                          │
│             factors.cashGroup = CashGroup.buildCashGroupStateful(accountContext.bitmapCurrencyId);                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 int256 netCashBalance,                                                                                                                                                                                                       │
│                 int256 nTokenHaircutAssetValue,                                                                                                                                                                                              │
│                 /* nTokenParameters */                                                                                                                                                                                                       │
│             ) = _getBitmapBalanceValue(account, blockTime, accountContext, factors);                                                                                                                                                         │
│             if (netCashBalance < 0) hasCashDebt = true;                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             int256 portfolioValue =                                                                                                                                                                                                          │
│                 _getBitmapPortfolioValue(account, blockTime, accountContext, factors);                                                                                                                                                       │
│             int256 netLocalAssetValue =                                                                                                                                                                                                      │
│                 netCashBalance.add(nTokenHaircutAssetValue).add(portfolioValue);                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│             factors.assetRate = factors.cashGroup.assetRate;                                                                                                                                                                                 │
│             _updateNetETHValue(accountContext.bitmapCurrencyId, netLocalAssetValue, factors);                                                                                                                                                │
│         } else {                                                                                                                                                                                                                             │
│             factors.portfolio = PortfolioHandler.getSortedPortfolio(                                                                                                                                                                         │
│                 account,                                                                                                                                                                                                                     │
│                 accountContext.assetArrayLength                                                                                                                                                                                              │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         bytes18 currencies = accountContext.activeCurrencies;                                                                                                                                                                                │
│         while (currencies != 0) {                                                                                                                                                                                                            │
│             bytes2 currencyBytes = bytes2(currencies);                                                                                                                                                                                       │
│             uint256 currencyId = uint256(uint16(currencyBytes & Constants.UNMASK_FLAGS));                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│             (int256 netLocalAssetValue, int256 nTokenBalance) =                                                                                                                                                                              │
│                 _getCurrencyBalances(account, currencyBytes);                                                                                                                                                                                │
│             if (netLocalAssetValue < 0) hasCashDebt = true;                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│             if (_isActiveInPortfolio(currencyBytes) || nTokenBalance > 0) {                                                                                                                                                                  │
│                 factors.cashGroup = CashGroup.buildCashGroupStateful(currencyId);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 (                                                                                                                                                                                                                            │
│                     int256 netPortfolioValue,                                                                                                                                                                                                │
│                     int256 nTokenHaircutAssetValue,                                                                                                                                                                                          │
│                     /* nTokenParameters */                                                                                                                                                                                                   │
│                 ) = _getPortfolioAndNTokenAssetValue(factors, nTokenBalance, blockTime);                                                                                                                                                     │
│                 netLocalAssetValue = netLocalAssetValue.add(netPortfolioValue).add(                                                                                                                                                          │
│                     nTokenHaircutAssetValue                                                                                                                                                                                                  │
│                 );                                                                                                                                                                                                                           │
│                 factors.assetRate = factors.cashGroup.assetRate;                                                                                                                                                                             │
│             } else {                                                                                                                                                                                                                         │
│                 factors.assetRate = AssetRate.buildAssetRateStateful(currencyId);                                                                                                                                                            │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             _updateNetETHValue(currencyId, netLocalAssetValue, factors);                                                                                                                                                                     │
│             currencies = currencies << 16;                                                                                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Free collateral is the only method that examines all cash balances for an account at once. If there is no cash debt (i.e.                                                                                                         │
│         // they have been repaid or settled via more debt) then this will turn off the flag. It's possible that this flag is out of                                                                                                          │
│         // sync temporarily after a cash settlement and before the next free collateral check. The only downside for that is forcing                                                                                                         │
│         // an account to do an extra free collateral check to turn off this setting.                                                                                                                                                         │
│         if (                                                                                                                                                                                                                                 │
│             accountContext.hasDebt & Constants.HAS_CASH_DEBT == Constants.HAS_CASH_DEBT &&                                                                                                                                                   │
│             !hasCashDebt                                                                                                                                                                                                                     │
│         ) {                                                                                                                                                                                                                                  │
│             accountContext.hasDebt = accountContext.hasDebt & ~Constants.HAS_CASH_DEBT;                                                                                                                                                      │
│             factors.updateContext = true;                                                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (factors.netETHValue, factors.updateContext);                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
│     function _updateNetETHValue(                                                                                                                                                                                                             │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         int256 netLocalAssetValue,                                                                                                                                                                                                           │
│         FreeCollateralFactors memory factors                                                                                                                                                                                                 │
│     ) private view returns (ETHRate memory) {                                                                                                                                                                                                │
│         ETHRate memory ethRate = ExchangeRate.buildExchangeRate(currencyId);                                                                                                                                                                 │
│         factors.netETHValue = factors.netETHValue.add(                                                                                                                                                                                       │
│             ethRate.convertToETH(factors.assetRate.convertToUnderlying(netLocalAssetValue))                                                                                                                                                  │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return ethRate;                                                                                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function storeAssets(PortfolioState memory portfolioState, address account)                                                                                                                                                              │
│         internal                                                                                                                                                                                                                             │
│         returns (                                                                                                                                                                                                                            │
│             bool,                                                                                                                                                                                                                            │
│             bytes32,                                                                                                                                                                                                                         │
│             uint8,                                                                                                                                                                                                                           │
│             uint40                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         uint256 initialSlot = uint256(                                                                                                                                                                                                       │
│             keccak256(abi.encode(account, Constants.PORTFOLIO_ARRAY_STORAGE_OFFSET))                                                                                                                                                         │
│         );                                                                                                                                                                                                                                   │
│         bool hasDebt;                                                                                                                                                                                                                        │
│         // NOTE: cannot have more than 16 assets or this byte object will overflow. Max assets is                                                                                                                                            │
│         // set to 7 and the worst case during liquidation would be 7 liquidity tokens that generate                                                                                                                                          │
│         // 7 additional fCash assets for a total of 14 assets. Although even in this case all assets                                                                                                                                         │
│         // would be of the same currency so it would not change the end result of the active currency                                                                                                                                        │
│         // calculation.                                                                                                                                                                                                                      │
│         bytes32 portfolioActiveCurrencies;                                                                                                                                                                                                   │
│         uint256 nextSettleTime;                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         // Mark any zero notional assets as deleted                                                                                                                                                                                          │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             if (                                                                                                                                                                                                                             │
│                 portfolioState.storedAssets.storageState != AssetStorageState.Delete &&                                                                                                                                                      │
│                 portfolioState.storedAssets.notional == 0                                                                                                                                                                                    │
│             ) {                                                                                                                                                                                                                              │
│                 deleteAsset(portfolioState, i);                                                                                                                                                                                              │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // First delete assets from asset storage to maintain asset storage indexes                                                                                                                                                          │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             if (asset.storageState == AssetStorageState.Delete) {                                                                                                                                                                            │
│                 // Delete asset from storage                                                                                                                                                                                                 │
│                 uint256 currentSlot = asset.storageSlot;                                                                                                                                                                                     │
│                 assembly {                                                                                                                                                                                                                   │
│                     sstore(currentSlot, 0x00)                                                                                                                                                                                                │
│                 }                                                                                                                                                                                                                            │
│                 continue;                                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             if (portfolioState.storedAssets.storageState == AssetStorageState.Update) {                                                                                                                                                      │
│                 // Apply updates                                                                                                                                                                                                             │
│                 uint256 currentSlot = asset.storageSlot;                                                                                                                                                                                     │
│                 bytes32 encodedAsset = _encodeAssetToBytes(portfolioState.storedAssets);                                                                                                                                                     │
│                 assembly {                                                                                                                                                                                                                   │
│                     sstore(currentSlot, encodedAsset)                                                                                                                                                                                        │
│                 }                                                                                                                                                                                                                            │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             (hasDebt, portfolioActiveCurrencies, nextSettleTime) = _updatePortfolioContext(                                                                                                                                                  │
│                 asset,                                                                                                                                                                                                                       │
│                 hasDebt,                                                                                                                                                                                                                     │
│                 portfolioActiveCurrencies,                                                                                                                                                                                                   │
│                 nextSettleTime                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Add new assets                                                                                                                                                                                                                    │
│         uint256 assetStorageLength = portfolioState.storedAssetLength;                                                                                                                                                                       │
│         for (uint256 i; i < portfolioState.newAssets.length; i++) {                                                                                                                                                                          │
│             PortfolioAsset memory asset = portfolioState.newAssets;                                                                                                                                                                          │
│             if (asset.notional == 0) continue;                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             bytes32 encodedAsset = _encodeAssetToBytes(portfolioState.newAssets);                                                                                                                                                            │
│             uint256 newAssetSlot = initialSlot + assetStorageLength;                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             (hasDebt, portfolioActiveCurrencies, nextSettleTime) = _updatePortfolioContext(                                                                                                                                                  │
│                 asset,                                                                                                                                                                                                                       │
│                 hasDebt,                                                                                                                                                                                                                     │
│                 portfolioActiveCurrencies,                                                                                                                                                                                                   │
│                 nextSettleTime                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(newAssetSlot, encodedAsset)                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│             assetStorageLength += 1;                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (                                                                                                                                                                                                                             │
│             hasDebt,                                                                                                                                                                                                                         │
│             portfolioActiveCurrencies,                                                                                                                                                                                                       │
│             uint8(assetStorageLength),                                                                                                                                                                                                       │
│             uint40(nextSettleTime)                                                                                                                                                                                                           │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function storeAssets(PortfolioState memory portfolioState, address account)                                                                                                                                                              │
│         internal                                                                                                                                                                                                                             │
│         returns (                                                                                                                                                                                                                            │
│             bool,                                                                                                                                                                                                                            │
│             bytes32,                                                                                                                                                                                                                         │
│             uint8,                                                                                                                                                                                                                           │
│             uint40                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         uint256 initialSlot = uint256(                                                                                                                                                                                                       │
│             keccak256(abi.encode(account, Constants.PORTFOLIO_ARRAY_STORAGE_OFFSET))                                                                                                                                                         │
│         );                                                                                                                                                                                                                                   │
│         bool hasDebt;                                                                                                                                                                                                                        │
│         // NOTE: cannot have more than 16 assets or this byte object will overflow. Max assets is                                                                                                                                            │
│         // set to 7 and the worst case during liquidation would be 7 liquidity tokens that generate                                                                                                                                          │
│         // 7 additional fCash assets for a total of 14 assets. Although even in this case all assets                                                                                                                                         │
│         // would be of the same currency so it would not change the end result of the active currency                                                                                                                                        │
│         // calculation.                                                                                                                                                                                                                      │
│         bytes32 portfolioActiveCurrencies;                                                                                                                                                                                                   │
│         uint256 nextSettleTime;                                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         // Mark any zero notional assets as deleted                                                                                                                                                                                          │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             if (                                                                                                                                                                                                                             │
│                 portfolioState.storedAssets.storageState != AssetStorageState.Delete &&                                                                                                                                                      │
│                 portfolioState.storedAssets.notional == 0                                                                                                                                                                                    │
│             ) {                                                                                                                                                                                                                              │
│                 deleteAsset(portfolioState, i);                                                                                                                                                                                              │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // First delete assets from asset storage to maintain asset storage indexes                                                                                                                                                          │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             if (asset.storageState == AssetStorageState.Delete) {                                                                                                                                                                            │
│                 // Delete asset from storage                                                                                                                                                                                                 │
│                 uint256 currentSlot = asset.storageSlot;                                                                                                                                                                                     │
│                 assembly {                                                                                                                                                                                                                   │
│                     sstore(currentSlot, 0x00)                                                                                                                                                                                                │
│                 }                                                                                                                                                                                                                            │
│                 continue;                                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             if (portfolioState.storedAssets.storageState == AssetStorageState.Update) {                                                                                                                                                      │
│                 // Apply updates                                                                                                                                                                                                             │
│                 uint256 currentSlot = asset.storageSlot;                                                                                                                                                                                     │
│                 bytes32 encodedAsset = _encodeAssetToBytes(portfolioState.storedAssets);                                                                                                                                                     │
│                 assembly {                                                                                                                                                                                                                   │
│                     sstore(currentSlot, encodedAsset)                                                                                                                                                                                        │
│                 }                                                                                                                                                                                                                            │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             (hasDebt, portfolioActiveCurrencies, nextSettleTime) = _updatePortfolioContext(                                                                                                                                                  │
│                 asset,                                                                                                                                                                                                                       │
│                 hasDebt,                                                                                                                                                                                                                     │
│                 portfolioActiveCurrencies,                                                                                                                                                                                                   │
│                 nextSettleTime                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Add new assets                                                                                                                                                                                                                    │
│         uint256 assetStorageLength = portfolioState.storedAssetLength;                                                                                                                                                                       │
│         for (uint256 i; i < portfolioState.newAssets.length; i++) {                                                                                                                                                                          │
│             PortfolioAsset memory asset = portfolioState.newAssets;                                                                                                                                                                          │
│             if (asset.notional == 0) continue;                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             bytes32 encodedAsset = _encodeAssetToBytes(portfolioState.newAssets);                                                                                                                                                            │
│             uint256 newAssetSlot = initialSlot + assetStorageLength;                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             (hasDebt, portfolioActiveCurrencies, nextSettleTime) = _updatePortfolioContext(                                                                                                                                                  │
│                 asset,                                                                                                                                                                                                                       │
│                 hasDebt,                                                                                                                                                                                                                     │
│                 portfolioActiveCurrencies,                                                                                                                                                                                                   │
│                 nextSettleTime                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(newAssetSlot, encodedAsset)                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│             assetStorageLength += 1;                                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (                                                                                                                                                                                                                             │
│             hasDebt,                                                                                                                                                                                                                         │
│             portfolioActiveCurrencies,                                                                                                                                                                                                       │
│             uint8(assetStorageLength),                                                                                                                                                                                                       │
│             uint40(nextSettleTime)                                                                                                                                                                                                           │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         address account,                                                                                                                                                                                                                     │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         int256 notional = getifCashNotional(account, currencyId, maturity);                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         // In this case the asset has matured and the total value is just the notional amount                                                                                                                                                │
│         if (maturity <= blockTime) return notional;                                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                             │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             return                                                                                                                                                                                                                           │
│                 AssetHandler.getRiskAdjustedPresentValue(                                                                                                                                                                                    │
│                     cashGroup,                                                                                                                                                                                                               │
│                     notional,                                                                                                                                                                                                                │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetHandler.getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate, and have inside code statements that calculate/assign/distribute the balance/share/stake/fee/loan/reward                                                   │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         address account,                                                                                                                                                                                                                     │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         int256 notional = getifCashNotional(account, currencyId, maturity);                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         // In this case the asset has matured and the total value is just the notional amount                                                                                                                                                │
│         if (maturity <= blockTime) return notional;                                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                             │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             return                                                                                                                                                                                                                           │
│                 AssetHandler.getRiskAdjustedPresentValue(                                                                                                                                                                                    │
│                     cashGroup,                                                                                                                                                                                                               │
│                     notional,                                                                                                                                                                                                                │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetHandler.getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function reduceifCashAssetsProportional(                                                                                                                                                                                                 │
│         address account,                                                                                                                                                                                                                     │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 nextSettleTime,                                                                                                                                                                                                              │
│         int256 tokensToRedeem,                                                                                                                                                                                                               │
│         int256 totalSupply                                                                                                                                                                                                                   │
│     ) internal returns (PortfolioAsset[] memory) {                                                                                                                                                                                           │
│         bytes32 assetsBitmap = getAssetsBitmap(account, currencyId);                                                                                                                                                                         │
│         uint256 index = assetsBitmap.totalBitsSet();                                                                                                                                                                                         │
│         PortfolioAsset[] memory assets = new PortfolioAsset[](index);                                                                                                                                                                        │
│         index = 0;                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         uint256 bitNum = assetsBitmap.getNextBitNum();                                                                                                                                                                                       │
│         while (bitNum != 0) {                                                                                                                                                                                                                │
│             uint256 maturity = DateTime.getMaturityFromBitNum(nextSettleTime, bitNum);                                                                                                                                                       │
│             bytes32 fCashSlot = getifCashSlot(account, currencyId, maturity);                                                                                                                                                                │
│             int256 notional;                                                                                                                                                                                                                 │
│             assembly {                                                                                                                                                                                                                       │
│                 notional := sload(fCashSlot)                                                                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             int256 notionalToTransfer = notional.mul(tokensToRedeem).div(totalSupply);                                                                                                                                                       │
│             notional = notional.sub(notionalToTransfer);                                                                                                                                                                                     │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(fCashSlot, notional)                                                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             assets.currencyId = currencyId;                                                                                                                                                                                                  │
│             assets.maturity = maturity;                                                                                                                                                                                                      │
│             assets.assetType = Constants.FCASH_ASSET_TYPE;                                                                                                                                                                                   │
│             assets.notional = notionalToTransfer;                                                                                                                                                                                            │
│             index += 1;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             // Turn off the bit and look for the next one                                                                                                                                                                                    │
│             assetsBitmap = assetsBitmap.setBit(bitNum, false);                                                                                                                                                                               │
│             bitNum = assetsBitmap.getNextBitNum();                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // If the entire token supply is redeemed then the assets bitmap will have been reduced to zero.                                                                                                                                     │
│         // Because solidity truncates division there will always be dust left unless the entire supply is                                                                                                                                    │
│         // redeemed.                                                                                                                                                                                                                         │
│         if (tokensToRedeem == totalSupply) {                                                                                                                                                                                                 │
│             setAssetsBitmap(account, currencyId, 0x00);                                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return assets;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculateMarketStorage(PortfolioAsset memory asset)                                                                                                                                                                            │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             SettlementMarket memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         SettlementMarket memory market =                                                                                                                                                                                                     │
│             Market.getSettlementMarket(asset.currencyId, asset.maturity, asset.getSettlementDate());                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         int256 assetCash = market.totalAssetCash.mul(asset.notional).div(market.totalLiquidity);                                                                                                                                             │
│         int256 fCash = market.totalfCash.mul(asset.notional).div(market.totalLiquidity);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         market.totalfCash = market.totalfCash.subNoNeg(fCash);                                                                                                                                                                               │
│         market.totalAssetCash = market.totalAssetCash.subNoNeg(assetCash);                                                                                                                                                                   │
│         market.totalLiquidity = market.totalLiquidity.subNoNeg(asset.notional);                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash, market);                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _settleLiquidityTokenTofCash(PortfolioState memory portfolioState, uint256 index)                                                                                                                                               │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (int256, SettlementMarket memory)                                                                                                                                                                                            │
│     {                                                                                                                                                                                                                                        │
│         PortfolioAsset memory liquidityToken = portfolioState.storedAssets;                                                                                                                                                                  │
│         (int256 assetCash, int256 fCash, SettlementMarket memory market) =                                                                                                                                                                   │
│             _calculateMarketStorage(liquidityToken);                                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // If the liquidity token's maturity is still in the future then we change the entry to be                                                                                                                                           │
│         // an idiosyncratic fCash entry with the net fCash amount.                                                                                                                                                                           │
│         if (index != 0) {                                                                                                                                                                                                                    │
│             // Check to see if the previous index is the matching fCash asset, this will be the case when the                                                                                                                                │
│             // portfolio is sorted                                                                                                                                                                                                           │
│             PortfolioAsset memory fCashAsset = portfolioState.storedAssets;                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│             if (                                                                                                                                                                                                                             │
│                 fCashAsset.currencyId == liquidityToken.currencyId &&                                                                                                                                                                        │
│                 fCashAsset.maturity == liquidityToken.maturity &&                                                                                                                                                                            │
│                 fCashAsset.assetType == Constants.FCASH_ASSET_TYPE                                                                                                                                                                           │
│             ) {                                                                                                                                                                                                                              │
│                 // This fCash asset has not matured if were are settling to fCash                                                                                                                                                            │
│                 fCashAsset.notional = fCashAsset.notional.add(fCash);                                                                                                                                                                        │
│                 fCashAsset.storageState = AssetStorageState.Update;                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│                 portfolioState.deleteAsset(index);                                                                                                                                                                                           │
│                 return (assetCash, market);                                                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         liquidityToken.assetType = Constants.FCASH_ASSET_TYPE;                                                                                                                                                                               │
│         liquidityToken.notional = fCash;                                                                                                                                                                                                     │
│         liquidityToken.storageState = AssetStorageState.Update;                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return (assetCash, market);                                                                                                                                                                                                          │
│     }                                                                                                                                                                                                                                        │
│     function _calculateMarketStorage(PortfolioAsset memory asset)                                                                                                                                                                            │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             SettlementMarket memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         SettlementMarket memory market =                                                                                                                                                                                                     │
│             Market.getSettlementMarket(asset.currencyId, asset.maturity, asset.getSettlementDate());                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         int256 assetCash = market.totalAssetCash.mul(asset.notional).div(market.totalLiquidity);                                                                                                                                             │
│         int256 fCash = market.totalfCash.mul(asset.notional).div(market.totalLiquidity);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         market.totalfCash = market.totalfCash.subNoNeg(fCash);                                                                                                                                                                               │
│         market.totalAssetCash = market.totalAssetCash.subNoNeg(assetCash);                                                                                                                                                                   │
│         market.totalLiquidity = market.totalLiquidity.subNoNeg(asset.notional);                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash, market);                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _settleLiquidityToken(                                                                                                                                                                                                          │
│         PortfolioAsset memory asset,                                                                                                                                                                                                         │
│         AssetRateParameters memory settlementRate                                                                                                                                                                                            │
│     ) private view returns (int256, SettlementMarket memory) {                                                                                                                                                                               │
│         (int256 assetCash, int256 fCash, SettlementMarket memory market) =                                                                                                                                                                   │
│             _calculateMarketStorage(asset);                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         assetCash = assetCash.add(settlementRate.convertFromUnderlying(fCash));                                                                                                                                                              │
│         return (assetCash, market);                                                                                                                                                                                                          │
│     }                                                                                                                                                                                                                                        │
│     function _calculateMarketStorage(PortfolioAsset memory asset)                                                                                                                                                                            │
│         private                                                                                                                                                                                                                              │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             SettlementMarket memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         SettlementMarket memory market =                                                                                                                                                                                                     │
│             Market.getSettlementMarket(asset.currencyId, asset.maturity, asset.getSettlementDate());                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         int256 assetCash = market.totalAssetCash.mul(asset.notional).div(market.totalLiquidity);                                                                                                                                             │
│         int256 fCash = market.totalfCash.mul(asset.notional).div(market.totalLiquidity);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         market.totalfCash = market.totalfCash.subNoNeg(fCash);                                                                                                                                                                               │
│         market.totalAssetCash = market.totalAssetCash.subNoNeg(assetCash);                                                                                                                                                                   │
│         market.totalLiquidity = market.totalLiquidity.subNoNeg(asset.notional);                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return (assetCash, fCash, market);                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateIncentivesToClaim(                                                                                                                                                                                                     │
│         address tokenAddress,                                                                                                                                                                                                                │
│         uint256 nTokenBalance,                                                                                                                                                                                                               │
│         uint256 lastClaimTime,                                                                                                                                                                                                               │
│         uint256 lastClaimIntegralSupply,                                                                                                                                                                                                     │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 integralTotalSupply                                                                                                                                                                                                          │
│     ) internal view returns (uint256) {                                                                                                                                                                                                      │
│         if (lastClaimTime == 0 || lastClaimTime >= blockTime) return 0;                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             /* currencyId */,                                                                                                                                                                                                                │
│             uint256 emissionRatePerYear,                                                                                                                                                                                                     │
│             /* initializedTime */,                                                                                                                                                                                                           │
│             /* parameters */                                                                                                                                                                                                                 │
│         ) = nTokenHandler.getNTokenContext(tokenAddress);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // No overflow here, checked above                                                                                                                                                                                                   │
│         uint256 timeSinceLastClaim = blockTime - lastClaimTime;                                                                                                                                                                              │
│         uint256 incentiveRate =                                                                                                                                                                                                              │
│             _getIncentiveRate(                                                                                                                                                                                                               │
│                 timeSinceLastClaim,                                                                                                                                                                                                          │
│                 // Convert this to the appropriate denomination                                                                                                                                                                              │
│                 emissionRatePerYear.mul(uint256(Constants.INTERNAL_TOKEN_PRECISION))                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         // Returns the average supply between now and the previous mint time using the integral of the total                                                                                                                                 │
│         // supply.                                                                                                                                                                                                                           │
│         uint256 avgTotalSupply = integralTotalSupply.sub(lastClaimIntegralSupply).div(timeSinceLastClaim);                                                                                                                                   │
│         if (avgTotalSupply == 0) return 0;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         uint256 incentivesToClaim = nTokenBalance.mul(incentiveRate).div(avgTotalSupply);                                                                                                                                                    │
│         // incentiveRate has a decimal basis of 1e16 so divide by token precision to reduce to 1e8                                                                                                                                           │
│         incentivesToClaim = incentivesToClaim.div(uint256(Constants.INTERNAL_TOKEN_PRECISION));                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return incentivesToClaim;                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function claimIncentives(BalanceState memory balanceState, address account)                                                                                                                                                              │
│         internal                                                                                                                                                                                                                             │
│         returns (uint256)                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         uint256 blockTime = block.timestamp;                                                                                                                                                                                                 │
│         address tokenAddress = nTokenHandler.nTokenAddress(balanceState.currencyId);                                                                                                                                                         │
│         uint256 integralTotalSupply = nTokenHandler.changeNTokenSupply(                                                                                                                                                                      │
│             tokenAddress,                                                                                                                                                                                                                    │
│             balanceState.netNTokenSupplyChange,                                                                                                                                                                                              │
│             blockTime                                                                                                                                                                                                                        │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         uint256 incentivesToClaim = calculateIncentivesToClaim(                                                                                                                                                                              │
│             tokenAddress,                                                                                                                                                                                                                    │
│             uint256(balanceState.storedNTokenBalance),                                                                                                                                                                                       │
│             balanceState.lastClaimTime,                                                                                                                                                                                                      │
│             balanceState.lastClaimIntegralSupply,                                                                                                                                                                                            │
│             blockTime,                                                                                                                                                                                                                       │
│             integralTotalSupply                                                                                                                                                                                                              │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         balanceState.lastClaimTime = blockTime;                                                                                                                                                                                              │
│         balanceState.lastClaimIntegralSupply = integralTotalSupply;                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         if (incentivesToClaim > 0) TokenHandler.transferIncentive(account, incentivesToClaim);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return incentivesToClaim;                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
│     function calculateIncentivesToClaim(                                                                                                                                                                                                     │
│         address tokenAddress,                                                                                                                                                                                                                │
│         uint256 nTokenBalance,                                                                                                                                                                                                               │
│         uint256 lastClaimTime,                                                                                                                                                                                                               │
│         uint256 lastClaimIntegralSupply,                                                                                                                                                                                                     │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 integralTotalSupply                                                                                                                                                                                                          │
│     ) internal view returns (uint256) {                                                                                                                                                                                                      │
│         if (lastClaimTime == 0 || lastClaimTime >= blockTime) return 0;                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             /* currencyId */,                                                                                                                                                                                                                │
│             uint256 emissionRatePerYear,                                                                                                                                                                                                     │
│             /* initializedTime */,                                                                                                                                                                                                           │
│             /* parameters */                                                                                                                                                                                                                 │
│         ) = nTokenHandler.getNTokenContext(tokenAddress);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // No overflow here, checked above                                                                                                                                                                                                   │
│         uint256 timeSinceLastClaim = blockTime - lastClaimTime;                                                                                                                                                                              │
│         uint256 incentiveRate =                                                                                                                                                                                                              │
│             _getIncentiveRate(                                                                                                                                                                                                               │
│                 timeSinceLastClaim,                                                                                                                                                                                                          │
│                 // Convert this to the appropriate denomination                                                                                                                                                                              │
│                 emissionRatePerYear.mul(uint256(Constants.INTERNAL_TOKEN_PRECISION))                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         // Returns the average supply between now and the previous mint time using the integral of the total                                                                                                                                 │
│         // supply.                                                                                                                                                                                                                           │
│         uint256 avgTotalSupply = integralTotalSupply.sub(lastClaimIntegralSupply).div(timeSinceLastClaim);                                                                                                                                   │
│         if (avgTotalSupply == 0) return 0;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         uint256 incentivesToClaim = nTokenBalance.mul(incentiveRate).div(avgTotalSupply);                                                                                                                                                    │
│         // incentiveRate has a decimal basis of 1e16 so divide by token precision to reduce to 1e8                                                                                                                                           │
│         incentivesToClaim = incentivesToClaim.div(uint256(Constants.INTERNAL_TOKEN_PRECISION));                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return incentivesToClaim;                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function claimIncentives(BalanceState memory balanceState, address account)                                                                                                                                                              │
│         internal                                                                                                                                                                                                                             │
│         returns (uint256)                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         uint256 blockTime = block.timestamp;                                                                                                                                                                                                 │
│         address tokenAddress = nTokenHandler.nTokenAddress(balanceState.currencyId);                                                                                                                                                         │
│         uint256 integralTotalSupply = nTokenHandler.changeNTokenSupply(                                                                                                                                                                      │
│             tokenAddress,                                                                                                                                                                                                                    │
│             balanceState.netNTokenSupplyChange,                                                                                                                                                                                              │
│             blockTime                                                                                                                                                                                                                        │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         uint256 incentivesToClaim = calculateIncentivesToClaim(                                                                                                                                                                              │
│             tokenAddress,                                                                                                                                                                                                                    │
│             uint256(balanceState.storedNTokenBalance),                                                                                                                                                                                       │
│             balanceState.lastClaimTime,                                                                                                                                                                                                      │
│             balanceState.lastClaimIntegralSupply,                                                                                                                                                                                            │
│             blockTime,                                                                                                                                                                                                                       │
│             integralTotalSupply                                                                                                                                                                                                              │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         balanceState.lastClaimTime = blockTime;                                                                                                                                                                                              │
│         balanceState.lastClaimIntegralSupply = integralTotalSupply;                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         if (incentivesToClaim > 0) TokenHandler.transferIncentive(account, incentivesToClaim);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return incentivesToClaim;                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function finalize(                                                                                                                                                                                                                       │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         address account,                                                                                                                                                                                                                     │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         bool redeemToUnderlying                                                                                                                                                                                                              │
│     ) internal returns (int256 transferAmountExternal) {                                                                                                                                                                                     │
│         bool mustUpdate;                                                                                                                                                                                                                     │
│         if (balanceState.netNTokenTransfer < 0) {                                                                                                                                                                                            │
│             require(                                                                                                                                                                                                                         │
│                 balanceState.storedNTokenBalance.add(balanceState.netNTokenSupplyChange) >=                                                                                                                                                  │
│                     balanceState.netNTokenTransfer.neg(),                                                                                                                                                                                    │
│                 "Neg withdraw"                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (balanceState.netAssetTransferInternalPrecision < 0) {                                                                                                                                                                            │
│             require(                                                                                                                                                                                                                         │
│                 balanceState.storedCashBalance.add(balanceState.netCashChange).add(                                                                                                                                                          │
│                     balanceState.netAssetTransferInternalPrecision                                                                                                                                                                           │
│                 ) >= 0,                                                                                                                                                                                                                      │
│                 "Neg withdraw"                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (balanceState.netAssetTransferInternalPrecision != 0) {                                                                                                                                                                           │
│             transferAmountExternal = _finalizeTransfers(balanceState, account, redeemToUnderlying);                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             balanceState.netCashChange != 0 || balanceState.netAssetTransferInternalPrecision != 0                                                                                                                                           │
│         ) {                                                                                                                                                                                                                                  │
│             balanceState.storedCashBalance = balanceState                                                                                                                                                                                    │
│                 .storedCashBalance                                                                                                                                                                                                           │
│                 .add(balanceState.netCashChange)                                                                                                                                                                                             │
│                 .add(balanceState.netAssetTransferInternalPrecision);                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             mustUpdate = true;                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             emit CashBalanceChange(                                                                                                                                                                                                          │
│                 account,                                                                                                                                                                                                                     │
│                 uint16(balanceState.currencyId),                                                                                                                                                                                             │
│                 balanceState.netCashChange.add(balanceState.netAssetTransferInternalPrecision)                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (balanceState.netNTokenTransfer != 0 || balanceState.netNTokenSupplyChange != 0) {                                                                                                                                                │
│             // It's crucial that incentives are claimed before we do any sort of nToken transfer to prevent gaming                                                                                                                           │
│             // of the system. This method will update the lastClaimTime time in the balanceState for storage.                                                                                                                                │
│             Incentives.claimIncentives(balanceState, account);                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // nTokens are within the notional system so we can update balances directly.                                                                                                                                                    │
│             balanceState.storedNTokenBalance = balanceState                                                                                                                                                                                  │
│                 .storedNTokenBalance                                                                                                                                                                                                         │
│                 .add(balanceState.netNTokenTransfer)                                                                                                                                                                                         │
│                 .add(balanceState.netNTokenSupplyChange);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│             if (balanceState.netNTokenSupplyChange != 0) {                                                                                                                                                                                   │
│                 emit nTokenSupplyChange(                                                                                                                                                                                                     │
│                     account,                                                                                                                                                                                                                 │
│                     uint16(balanceState.currencyId),                                                                                                                                                                                         │
│                     balanceState.netNTokenSupplyChange                                                                                                                                                                                       │
│                 );                                                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             mustUpdate = true;                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (mustUpdate) {                                                                                                                                                                                                                    │
│             _setBalanceStorage(                                                                                                                                                                                                              │
│                 account,                                                                                                                                                                                                                     │
│                 balanceState.currencyId,                                                                                                                                                                                                     │
│                 balanceState.storedCashBalance,                                                                                                                                                                                              │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 balanceState.lastClaimTime,                                                                                                                                                                                                  │
│                 balanceState.lastClaimIntegralSupply                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         accountContext.setActiveCurrency(                                                                                                                                                                                                    │
│             balanceState.currencyId,                                                                                                                                                                                                         │
│             // Set active currency to true if either balance is non-zero                                                                                                                                                                     │
│             balanceState.storedCashBalance != 0 || balanceState.storedNTokenBalance != 0,                                                                                                                                                    │
│             Constants.ACTIVE_IN_BALANCES                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (balanceState.storedCashBalance < 0) {                                                                                                                                                                                            │
│             // NOTE: HAS_CASH_DEBT cannot be extinguished except by a free collateral check where all balances                                                                                                                               │
│             // are examined                                                                                                                                                                                                                  │
│             accountContext.hasDebt = accountContext.hasDebt | Constants.HAS_CASH_DEBT;                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return transferAmountExternal;                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function finalize(                                                                                                                                                                                                                       │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         address account,                                                                                                                                                                                                                     │
│         AccountContext memory accountContext,                                                                                                                                                                                                │
│         bool redeemToUnderlying                                                                                                                                                                                                              │
│     ) internal returns (int256 transferAmountExternal) {                                                                                                                                                                                     │
│         bool mustUpdate;                                                                                                                                                                                                                     │
│         if (balanceState.netNTokenTransfer < 0) {                                                                                                                                                                                            │
│             require(                                                                                                                                                                                                                         │
│                 balanceState.storedNTokenBalance.add(balanceState.netNTokenSupplyChange) >=                                                                                                                                                  │
│                     balanceState.netNTokenTransfer.neg(),                                                                                                                                                                                    │
│                 "Neg withdraw"                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (balanceState.netAssetTransferInternalPrecision < 0) {                                                                                                                                                                            │
│             require(                                                                                                                                                                                                                         │
│                 balanceState.storedCashBalance.add(balanceState.netCashChange).add(                                                                                                                                                          │
│                     balanceState.netAssetTransferInternalPrecision                                                                                                                                                                           │
│                 ) >= 0,                                                                                                                                                                                                                      │
│                 "Neg withdraw"                                                                                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (balanceState.netAssetTransferInternalPrecision != 0) {                                                                                                                                                                           │
│             transferAmountExternal = _finalizeTransfers(balanceState, account, redeemToUnderlying);                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             balanceState.netCashChange != 0 || balanceState.netAssetTransferInternalPrecision != 0                                                                                                                                           │
│         ) {                                                                                                                                                                                                                                  │
│             balanceState.storedCashBalance = balanceState                                                                                                                                                                                    │
│                 .storedCashBalance                                                                                                                                                                                                           │
│                 .add(balanceState.netCashChange)                                                                                                                                                                                             │
│                 .add(balanceState.netAssetTransferInternalPrecision);                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             mustUpdate = true;                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             emit CashBalanceChange(                                                                                                                                                                                                          │
│                 account,                                                                                                                                                                                                                     │
│                 uint16(balanceState.currencyId),                                                                                                                                                                                             │
│                 balanceState.netCashChange.add(balanceState.netAssetTransferInternalPrecision)                                                                                                                                               │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (balanceState.netNTokenTransfer != 0 || balanceState.netNTokenSupplyChange != 0) {                                                                                                                                                │
│             // It's crucial that incentives are claimed before we do any sort of nToken transfer to prevent gaming                                                                                                                           │
│             // of the system. This method will update the lastClaimTime time in the balanceState for storage.                                                                                                                                │
│             Incentives.claimIncentives(balanceState, account);                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // nTokens are within the notional system so we can update balances directly.                                                                                                                                                    │
│             balanceState.storedNTokenBalance = balanceState                                                                                                                                                                                  │
│                 .storedNTokenBalance                                                                                                                                                                                                         │
│                 .add(balanceState.netNTokenTransfer)                                                                                                                                                                                         │
│                 .add(balanceState.netNTokenSupplyChange);                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│             if (balanceState.netNTokenSupplyChange != 0) {                                                                                                                                                                                   │
│                 emit nTokenSupplyChange(                                                                                                                                                                                                     │
│                     account,                                                                                                                                                                                                                 │
│                     uint16(balanceState.currencyId),                                                                                                                                                                                         │
│                     balanceState.netNTokenSupplyChange                                                                                                                                                                                       │
│                 );                                                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             mustUpdate = true;                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (mustUpdate) {                                                                                                                                                                                                                    │
│             _setBalanceStorage(                                                                                                                                                                                                              │
│                 account,                                                                                                                                                                                                                     │
│                 balanceState.currencyId,                                                                                                                                                                                                     │
│                 balanceState.storedCashBalance,                                                                                                                                                                                              │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 balanceState.lastClaimTime,                                                                                                                                                                                                  │
│                 balanceState.lastClaimIntegralSupply                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         accountContext.setActiveCurrency(                                                                                                                                                                                                    │
│             balanceState.currencyId,                                                                                                                                                                                                         │
│             // Set active currency to true if either balance is non-zero                                                                                                                                                                     │
│             balanceState.storedCashBalance != 0 || balanceState.storedNTokenBalance != 0,                                                                                                                                                    │
│             Constants.ACTIVE_IN_BALANCES                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (balanceState.storedCashBalance < 0) {                                                                                                                                                                                            │
│             // NOTE: HAS_CASH_DEBT cannot be extinguished except by a free collateral check where all balances                                                                                                                               │
│             // are examined                                                                                                                                                                                                                  │
│             accountContext.hasDebt = accountContext.hasDebt | Constants.HAS_CASH_DEBT;                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return transferAmountExternal;                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function loadBalanceState(                                                                                                                                                                                                               │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         address account,                                                                                                                                                                                                                     │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         AccountContext memory accountContext                                                                                                                                                                                                 │
│     ) internal view {                                                                                                                                                                                                                        │
│         require(currencyId != 0); // dev: invalid currency id                                                                                                                                                                                │
│         balanceState.currencyId = currencyId;                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         if (accountContext.isActiveInBalances(currencyId)) {                                                                                                                                                                                 │
│             (                                                                                                                                                                                                                                │
│                 balanceState.storedCashBalance,                                                                                                                                                                                              │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 balanceState.lastClaimTime,                                                                                                                                                                                                  │
│                 balanceState.lastClaimIntegralSupply                                                                                                                                                                                         │
│             ) = getBalanceStorage(account, currencyId);                                                                                                                                                                                      │
│         } else {                                                                                                                                                                                                                             │
│             balanceState.storedCashBalance = 0;                                                                                                                                                                                              │
│             balanceState.storedNTokenBalance = 0;                                                                                                                                                                                            │
│             balanceState.lastClaimTime = 0;                                                                                                                                                                                                  │
│             balanceState.lastClaimIntegralSupply = 0;                                                                                                                                                                                        │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         balanceState.netCashChange = 0;                                                                                                                                                                                                      │
│         balanceState.netAssetTransferInternalPrecision = 0;                                                                                                                                                                                  │
│         balanceState.netNTokenTransfer = 0;                                                                                                                                                                                                  │
│         balanceState.netNTokenSupplyChange = 0;                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: add or check approval via require/if statements before the token transfer,                                                                                                                                                        │
│ Code:                                                                                                                                                                                                                                        │
│     function setToken(                                                                                                                                                                                                                       │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         bool underlying,                                                                                                                                                                                                                     │
│         TokenStorage memory tokenStorage                                                                                                                                                                                                     │
│     ) internal {                                                                                                                                                                                                                             │
│         bytes32 slot = _getSlot(currencyId, underlying);                                                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         if (tokenStorage.tokenType == TokenType.Ether && currencyId == Constants.ETH_CURRENCY_ID) {                                                                                                                                          │
│             // Specific storage for Ether token type                                                                                                                                                                                         │
│             bytes32 etherData =                                                                                                                                                                                                              │
│                 ((bytes32(bytes20(address(0))) >> 96) |                                                                                                                                                                                      │
│                     (bytes32(bytes1(Constants.BOOL_FALSE)) >> 88) |                                                                                                                                                                          │
│                     bytes32(uint256(18) << 168) |                                                                                                                                                                                            │
│                     bytes32(uint256(TokenType.Ether) << 176));                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(slot, etherData)                                                                                                                                                                                                      │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             return;                                                                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│         require(tokenStorage.tokenType != TokenType.Ether); // dev: ether can only be set once                                                                                                                                               │
│         require(tokenStorage.tokenAddress != address(0), "TH: address is zero");                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         uint8 decimalPlaces = ERC20(tokenStorage.tokenAddress).decimals();                                                                                                                                                                   │
│         require(decimalPlaces != 0, "TH: decimals is zero");                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         // Once a token is set we cannot override it. In the case that we do need to do change a token address                                                                                                                               │
│         // then we should explicitly upgrade this method to allow for a token to be changed.                                                                                                                                                 │
│         Token memory token = getToken(currencyId, underlying);                                                                                                                                                                               │
│         require(                                                                                                                                                                                                                             │
│             token.tokenAddress == tokenStorage.tokenAddress || token.tokenAddress == address(0),                                                                                                                                             │
│             "TH: token cannot be reset"                                                                                                                                                                                                      │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (tokenStorage.tokenType == TokenType.cToken) {                                                                                                                                                                                    │
│             // Set the approval for the underlying so that we can mint cTokens                                                                                                                                                               │
│             Token memory underlyingToken = getToken(currencyId, true);                                                                                                                                                                       │
│             ERC20(underlyingToken.tokenAddress).approve(                                                                                                                                                                                     │
│                 tokenStorage.tokenAddress,                                                                                                                                                                                                   │
│                 type(uint256).max                                                                                                                                                                                                            │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         bytes1 transferFee =                                                                                                                                                                                                                 │
│             tokenStorage.hasTransferFee ? Constants.BOOL_TRUE : Constants.BOOL_FALSE;                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         bytes32 data =                                                                                                                                                                                                                       │
│             ((bytes32(bytes20(tokenStorage.tokenAddress)) >> 96) |                                                                                                                                                                           │
│                 (bytes32(bytes1(transferFee)) >> 88) |                                                                                                                                                                                       │
│                 bytes32(uint256(decimalPlaces) << 168) |                                                                                                                                                                                     │
│                 bytes32(uint256(tokenStorage.tokenType) << 176));                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: add or check approval via require/if statements before the token transfer, and there is no clear/reset of the approval when the transfer finishes its main branch or encounters exceptions                                        │
│ Code:                                                                                                                                                                                                                                        │
│     function setToken(                                                                                                                                                                                                                       │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         bool underlying,                                                                                                                                                                                                                     │
│         TokenStorage memory tokenStorage                                                                                                                                                                                                     │
│     ) internal {                                                                                                                                                                                                                             │
│         bytes32 slot = _getSlot(currencyId, underlying);                                                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         if (tokenStorage.tokenType == TokenType.Ether && currencyId == Constants.ETH_CURRENCY_ID) {                                                                                                                                          │
│             // Specific storage for Ether token type                                                                                                                                                                                         │
│             bytes32 etherData =                                                                                                                                                                                                              │
│                 ((bytes32(bytes20(address(0))) >> 96) |                                                                                                                                                                                      │
│                     (bytes32(bytes1(Constants.BOOL_FALSE)) >> 88) |                                                                                                                                                                          │
│                     bytes32(uint256(18) << 168) |                                                                                                                                                                                            │
│                     bytes32(uint256(TokenType.Ether) << 176));                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             assembly {                                                                                                                                                                                                                       │
│                 sstore(slot, etherData)                                                                                                                                                                                                      │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             return;                                                                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│         require(tokenStorage.tokenType != TokenType.Ether); // dev: ether can only be set once                                                                                                                                               │
│         require(tokenStorage.tokenAddress != address(0), "TH: address is zero");                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         uint8 decimalPlaces = ERC20(tokenStorage.tokenAddress).decimals();                                                                                                                                                                   │
│         require(decimalPlaces != 0, "TH: decimals is zero");                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         // Once a token is set we cannot override it. In the case that we do need to do change a token address                                                                                                                               │
│         // then we should explicitly upgrade this method to allow for a token to be changed.                                                                                                                                                 │
│         Token memory token = getToken(currencyId, underlying);                                                                                                                                                                               │
│         require(                                                                                                                                                                                                                             │
│             token.tokenAddress == tokenStorage.tokenAddress || token.tokenAddress == address(0),                                                                                                                                             │
│             "TH: token cannot be reset"                                                                                                                                                                                                      │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (tokenStorage.tokenType == TokenType.cToken) {                                                                                                                                                                                    │
│             // Set the approval for the underlying so that we can mint cTokens                                                                                                                                                               │
│             Token memory underlyingToken = getToken(currencyId, true);                                                                                                                                                                       │
│             ERC20(underlyingToken.tokenAddress).approve(                                                                                                                                                                                     │
│                 tokenStorage.tokenAddress,                                                                                                                                                                                                   │
│                 type(uint256).max                                                                                                                                                                                                            │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         bytes1 transferFee =                                                                                                                                                                                                                 │
│             tokenStorage.hasTransferFee ? Constants.BOOL_TRUE : Constants.BOOL_FALSE;                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         bytes32 data =                                                                                                                                                                                                                       │
│             ((bytes32(bytes20(tokenStorage.tokenAddress)) >> 96) |                                                                                                                                                                           │
│                 (bytes32(bytes1(transferFee)) >> 88) |                                                                                                                                                                                       │
│                 bytes32(uint256(decimalPlaces) << 168) |                                                                                                                                                                                     │
│                 bytes32(uint256(tokenStorage.tokenType) << 176));                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function mint(Token memory token, uint256 underlyingAmountExternal) internal returns (int256) {                                                                                                                                          │
│         uint256 startingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         uint256 success;                                                                                                                                                                                                                     │
│         if (token.tokenType == TokenType.cToken) {                                                                                                                                                                                           │
│             success = CErc20Interface(token.tokenAddress).mint(underlyingAmountExternal);                                                                                                                                                    │
│         } else if (token.tokenType == TokenType.cETH) {                                                                                                                                                                                      │
│             // Reverts on error                                                                                                                                                                                                              │
│             CEtherInterface(token.tokenAddress).mint{value: msg.value}();                                                                                                                                                                    │
│         } else {                                                                                                                                                                                                                             │
│             revert(); // dev: non mintable token                                                                                                                                                                                             │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         require(success == 0, "Mint fail");                                                                                                                                                                                                  │
│         uint256 endingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // This is the starting and ending balance in external precision                                                                                                                                                                     │
│         return int256(endingBalance.sub(startingBalance));                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function mint(Token memory token, uint256 underlyingAmountExternal) internal returns (int256) {                                                                                                                                          │
│         uint256 startingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         uint256 success;                                                                                                                                                                                                                     │
│         if (token.tokenType == TokenType.cToken) {                                                                                                                                                                                           │
│             success = CErc20Interface(token.tokenAddress).mint(underlyingAmountExternal);                                                                                                                                                    │
│         } else if (token.tokenType == TokenType.cETH) {                                                                                                                                                                                      │
│             // Reverts on error                                                                                                                                                                                                              │
│             CEtherInterface(token.tokenAddress).mint{value: msg.value}();                                                                                                                                                                    │
│         } else {                                                                                                                                                                                                                             │
│             revert(); // dev: non mintable token                                                                                                                                                                                             │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         require(success == 0, "Mint fail");                                                                                                                                                                                                  │
│         uint256 endingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // This is the starting and ending balance in external precision                                                                                                                                                                     │
│         return int256(endingBalance.sub(startingBalance));                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function mint(Token memory token, uint256 underlyingAmountExternal) internal returns (int256) {                                                                                                                                          │
│         uint256 startingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         uint256 success;                                                                                                                                                                                                                     │
│         if (token.tokenType == TokenType.cToken) {                                                                                                                                                                                           │
│             success = CErc20Interface(token.tokenAddress).mint(underlyingAmountExternal);                                                                                                                                                    │
│         } else if (token.tokenType == TokenType.cETH) {                                                                                                                                                                                      │
│             // Reverts on error                                                                                                                                                                                                              │
│             CEtherInterface(token.tokenAddress).mint{value: msg.value}();                                                                                                                                                                    │
│         } else {                                                                                                                                                                                                                             │
│             revert(); // dev: non mintable token                                                                                                                                                                                             │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         require(success == 0, "Mint fail");                                                                                                                                                                                                  │
│         uint256 endingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         // This is the starting and ending balance in external precision                                                                                                                                                                     │
│         return int256(endingBalance.sub(startingBalance));                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function redeem(                                                                                                                                                                                                                         │
│         Token memory assetToken,                                                                                                                                                                                                             │
│         Token memory underlyingToken,                                                                                                                                                                                                        │
│         uint256 assetAmountExternal                                                                                                                                                                                                          │
│     ) internal returns (int256) {                                                                                                                                                                                                            │
│         uint256 startingBalance;                                                                                                                                                                                                             │
│         if (assetToken.tokenType == TokenType.cETH) {                                                                                                                                                                                        │
│             startingBalance = address(this).balance;                                                                                                                                                                                         │
│         } else if (assetToken.tokenType == TokenType.cToken) {                                                                                                                                                                               │
│             startingBalance = IERC20(underlyingToken.tokenAddress).balanceOf(address(this));                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             revert(); // dev: non redeemable failure                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 success = CErc20Interface(assetToken.tokenAddress).redeem(assetAmountExternal);                                                                                                                                              │
│         require(success == 0, "Redeem fail");                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         uint256 endingBalance;                                                                                                                                                                                                               │
│         if (assetToken.tokenType == TokenType.cETH) {                                                                                                                                                                                        │
│             endingBalance = address(this).balance;                                                                                                                                                                                           │
│         } else {                                                                                                                                                                                                                             │
│             endingBalance = IERC20(underlyingToken.tokenAddress).balanceOf(address(this));                                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Underlying token external precision                                                                                                                                                                                               │
│         return int256(endingBalance.sub(startingBalance));                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function redeem(                                                                                                                                                                                                                         │
│         Token memory assetToken,                                                                                                                                                                                                             │
│         Token memory underlyingToken,                                                                                                                                                                                                        │
│         uint256 assetAmountExternal                                                                                                                                                                                                          │
│     ) internal returns (int256) {                                                                                                                                                                                                            │
│         uint256 startingBalance;                                                                                                                                                                                                             │
│         if (assetToken.tokenType == TokenType.cETH) {                                                                                                                                                                                        │
│             startingBalance = address(this).balance;                                                                                                                                                                                         │
│         } else if (assetToken.tokenType == TokenType.cToken) {                                                                                                                                                                               │
│             startingBalance = IERC20(underlyingToken.tokenAddress).balanceOf(address(this));                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             revert(); // dev: non redeemable failure                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 success = CErc20Interface(assetToken.tokenAddress).redeem(assetAmountExternal);                                                                                                                                              │
│         require(success == 0, "Redeem fail");                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         uint256 endingBalance;                                                                                                                                                                                                               │
│         if (assetToken.tokenType == TokenType.cETH) {                                                                                                                                                                                        │
│             endingBalance = address(this).balance;                                                                                                                                                                                           │
│         } else {                                                                                                                                                                                                                             │
│             endingBalance = IERC20(underlyingToken.tokenAddress).balanceOf(address(this));                                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Underlying token external precision                                                                                                                                                                                               │
│         return int256(endingBalance.sub(startingBalance));                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function redeem(                                                                                                                                                                                                                         │
│         Token memory assetToken,                                                                                                                                                                                                             │
│         Token memory underlyingToken,                                                                                                                                                                                                        │
│         uint256 assetAmountExternal                                                                                                                                                                                                          │
│     ) internal returns (int256) {                                                                                                                                                                                                            │
│         uint256 startingBalance;                                                                                                                                                                                                             │
│         if (assetToken.tokenType == TokenType.cETH) {                                                                                                                                                                                        │
│             startingBalance = address(this).balance;                                                                                                                                                                                         │
│         } else if (assetToken.tokenType == TokenType.cToken) {                                                                                                                                                                               │
│             startingBalance = IERC20(underlyingToken.tokenAddress).balanceOf(address(this));                                                                                                                                                 │
│         } else {                                                                                                                                                                                                                             │
│             revert(); // dev: non redeemable failure                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 success = CErc20Interface(assetToken.tokenAddress).redeem(assetAmountExternal);                                                                                                                                              │
│         require(success == 0, "Redeem fail");                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│         uint256 endingBalance;                                                                                                                                                                                                               │
│         if (assetToken.tokenType == TokenType.cETH) {                                                                                                                                                                                        │
│             endingBalance = address(this).balance;                                                                                                                                                                                           │
│         } else {                                                                                                                                                                                                                             │
│             endingBalance = IERC20(underlyingToken.tokenAddress).balanceOf(address(this));                                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Underlying token external precision                                                                                                                                                                                               │
│         return int256(endingBalance.sub(startingBalance));                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _deposit(                                                                                                                                                                                                                       │
│         Token memory token,                                                                                                                                                                                                                  │
│         address account,                                                                                                                                                                                                                     │
│         uint256 amount                                                                                                                                                                                                                       │
│     ) private returns (int256) {                                                                                                                                                                                                             │
│         if (token.hasTransferFee) {                                                                                                                                                                                                          │
│             // Must deposit from the token and calculate the net transfer                                                                                                                                                                    │
│             uint256 startingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                   │
│             safeTransferIn(IERC20(token.tokenAddress), account, amount);                                                                                                                                                                     │
│             uint256 endingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│             return int256(endingBalance.sub(startingBalance));                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         safeTransferIn(IERC20(token.tokenAddress), account, amount);                                                                                                                                                                         │
│         return int256(amount);                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function transfer(                                                                                                                                                                                                                       │
│         Token memory token,                                                                                                                                                                                                                  │
│         address account,                                                                                                                                                                                                                     │
│         int256 netTransferExternal                                                                                                                                                                                                           │
│     ) internal returns (int256) {                                                                                                                                                                                                            │
│         if (netTransferExternal > 0) {                                                                                                                                                                                                       │
│             // Deposits must account for transfer fees.                                                                                                                                                                                      │
│             netTransferExternal = _deposit(token, account, uint256(netTransferExternal));                                                                                                                                                    │
│         } else if (token.tokenType == TokenType.Ether) {                                                                                                                                                                                     │
│             require(netTransferExternal < 0); // dev: cannot transfer ether                                                                                                                                                                  │
│             address payable accountPayable = payable(account);                                                                                                                                                                               │
│             // This does not work with contracts, but is reentrancy safe. If contracts want to withdraw underlying                                                                                                                           │
│             // ETH they will have to withdraw the cETH token and then redeem it manually.                                                                                                                                                    │
│             accountPayable.transfer(uint256(netTransferExternal.neg()));                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             safeTransferOut(                                                                                                                                                                                                                 │
│                 IERC20(token.tokenAddress),                                                                                                                                                                                                  │
│                 account,                                                                                                                                                                                                                     │
│                 uint256(netTransferExternal.neg())                                                                                                                                                                                           │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return netTransferExternal;                                                                                                                                                                                                          │
│     }                                                                                                                                                                                                                                        │
│     function _deposit(                                                                                                                                                                                                                       │
│         Token memory token,                                                                                                                                                                                                                  │
│         address account,                                                                                                                                                                                                                     │
│         uint256 amount                                                                                                                                                                                                                       │
│     ) private returns (int256) {                                                                                                                                                                                                             │
│         if (token.hasTransferFee) {                                                                                                                                                                                                          │
│             // Must deposit from the token and calculate the net transfer                                                                                                                                                                    │
│             uint256 startingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                   │
│             safeTransferIn(IERC20(token.tokenAddress), account, amount);                                                                                                                                                                     │
│             uint256 endingBalance = IERC20(token.tokenAddress).balanceOf(address(this));                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│             return int256(endingBalance.sub(startingBalance));                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         safeTransferIn(IERC20(token.tokenAddress), account, amount);                                                                                                                                                                         │
│         return int256(amount);                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateLocalCurrency(                                                                                                                                                                                                         │
│         uint256 localCurrency,                                                                                                                                                                                                               │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 assetBenefitRequired =                                                                                                                                                                                                        │
│             factors.cashGroup.assetRate.convertFromUnderlying(                                                                                                                                                                               │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .convertETHTo(factors.netETHValue.neg())                                                                                                                                                                                 │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(factors.localETHRate.buffer)                                                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (_hasLiquidityTokens(portfolio.storedAssets, localCurrency)) {                                                                                                                                                                    │
│             WithdrawFactors memory w;                                                                                                                                                                                                        │
│             (w, assetBenefitRequired) = _withdrawLocalLiquidityTokens(                                                                                                                                                                       │
│                 portfolio,                                                                                                                                                                                                                   │
│                 factors,                                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 assetBenefitRequired                                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│             netAssetCashFromLiquidator = w.totalIncentivePaid.neg();                                                                                                                                                                         │
│             balanceState.netCashChange = w.totalCashClaim.sub(w.totalIncentivePaid);                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                                                           │
│             int256 nTokensToLiquidate;                                                                                                                                                                                                       │
│             {                                                                                                                                                                                                                                │
│                 // This will not underflow, checked when saving parameters                                                                                                                                                                   │
│                 int256 haircutDiff =                                                                                                                                                                                                         │
│                     int256(                                                                                                                                                                                                                  │
│                         uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE]) -                                                                                                                                          │
│                             uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])                                                                                                                                                 │
│                     ) * Constants.PERCENTAGE_DECIMALS;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // benefitGained = nTokensToLiquidate * (liquidatedPV - freeCollateralPV)                                                                                                                                                    │
│                 // benefitGained = nTokensToLiquidate * (fullNTokenPV * liquidatedPV - fullNTokenPV * pvHaircut)                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * fullNTokenPV * (liquidatedPV - pvHaircut) / totalBalance                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * (haircutTokenPV / haircutPercentage) * (liquidationHaircut - pvHaircut) / totalBalance                                                                                               │
│                 // benefitGained = nTokensToLiquidate * haircutTokenPV * (liquidationHaircut - pvHaircut) / (totalBalance * haircutPercentage)                                                                                               │
│                 // nTokensToLiquidate = (benefitGained * totalBalance * haircutPercentage) / (haircutTokenPV * (liquidationHaircut - pvHaircut))                                                                                             │
│                 nTokensToLiquidate = assetBenefitRequired                                                                                                                                                                                    │
│                     .mul(balanceState.storedNTokenBalance)                                                                                                                                                                                   │
│                     .mul(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                           │
│                     .div(factors.nTokenHaircutAssetValue.mul(haircutDiff));                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             nTokensToLiquidate = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                              │
│                 nTokensToLiquidate,                                                                                                                                                                                                          │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│             balanceState.netNTokenTransfer = nTokensToLiquidate.neg();                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             {                                                                                                                                                                                                                                │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // localFromLiquidator = tokensToLiquidate * fullNTokenPV * liquidationHaircut / totalBalance                                                                                                                                │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 int256 localAssetCash =                                                                                                                                                                                                      │
│                     nTokensToLiquidate                                                                                                                                                                                                       │
│                         .mul(int256(uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE])))                                                                                                                              │
│                         .mul(factors.nTokenHaircutAssetValue)                                                                                                                                                                                │
│                         .div(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                       │
│                         .div(balanceState.storedNTokenBalance);                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.netCashChange.add(localAssetCash);                                                                                                                                                 │
│                 netAssetCashFromLiquidator = netAssetCashFromLiquidator.add(localAssetCash);                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateLocalCurrency(                                                                                                                                                                                                         │
│         uint256 localCurrency,                                                                                                                                                                                                               │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 assetBenefitRequired =                                                                                                                                                                                                        │
│             factors.cashGroup.assetRate.convertFromUnderlying(                                                                                                                                                                               │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .convertETHTo(factors.netETHValue.neg())                                                                                                                                                                                 │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(factors.localETHRate.buffer)                                                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (_hasLiquidityTokens(portfolio.storedAssets, localCurrency)) {                                                                                                                                                                    │
│             WithdrawFactors memory w;                                                                                                                                                                                                        │
│             (w, assetBenefitRequired) = _withdrawLocalLiquidityTokens(                                                                                                                                                                       │
│                 portfolio,                                                                                                                                                                                                                   │
│                 factors,                                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 assetBenefitRequired                                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│             netAssetCashFromLiquidator = w.totalIncentivePaid.neg();                                                                                                                                                                         │
│             balanceState.netCashChange = w.totalCashClaim.sub(w.totalIncentivePaid);                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                                                           │
│             int256 nTokensToLiquidate;                                                                                                                                                                                                       │
│             {                                                                                                                                                                                                                                │
│                 // This will not underflow, checked when saving parameters                                                                                                                                                                   │
│                 int256 haircutDiff =                                                                                                                                                                                                         │
│                     int256(                                                                                                                                                                                                                  │
│                         uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE]) -                                                                                                                                          │
│                             uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])                                                                                                                                                 │
│                     ) * Constants.PERCENTAGE_DECIMALS;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // benefitGained = nTokensToLiquidate * (liquidatedPV - freeCollateralPV)                                                                                                                                                    │
│                 // benefitGained = nTokensToLiquidate * (fullNTokenPV * liquidatedPV - fullNTokenPV * pvHaircut)                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * fullNTokenPV * (liquidatedPV - pvHaircut) / totalBalance                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * (haircutTokenPV / haircutPercentage) * (liquidationHaircut - pvHaircut) / totalBalance                                                                                               │
│                 // benefitGained = nTokensToLiquidate * haircutTokenPV * (liquidationHaircut - pvHaircut) / (totalBalance * haircutPercentage)                                                                                               │
│                 // nTokensToLiquidate = (benefitGained * totalBalance * haircutPercentage) / (haircutTokenPV * (liquidationHaircut - pvHaircut))                                                                                             │
│                 nTokensToLiquidate = assetBenefitRequired                                                                                                                                                                                    │
│                     .mul(balanceState.storedNTokenBalance)                                                                                                                                                                                   │
│                     .mul(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                           │
│                     .div(factors.nTokenHaircutAssetValue.mul(haircutDiff));                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             nTokensToLiquidate = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                              │
│                 nTokensToLiquidate,                                                                                                                                                                                                          │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│             balanceState.netNTokenTransfer = nTokensToLiquidate.neg();                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             {                                                                                                                                                                                                                                │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // localFromLiquidator = tokensToLiquidate * fullNTokenPV * liquidationHaircut / totalBalance                                                                                                                                │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 int256 localAssetCash =                                                                                                                                                                                                      │
│                     nTokensToLiquidate                                                                                                                                                                                                       │
│                         .mul(int256(uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE])))                                                                                                                              │
│                         .mul(factors.nTokenHaircutAssetValue)                                                                                                                                                                                │
│                         .div(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                       │
│                         .div(balanceState.storedNTokenBalance);                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.netCashChange.add(localAssetCash);                                                                                                                                                 │
│                 netAssetCashFromLiquidator = netAssetCashFromLiquidator.add(localAssetCash);                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculateCollateralToRaise(                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         int256 maxCollateralLiquidation                                                                                                                                                                                                      │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256 requiredCollateralAssetCash,                                                                                                                                                                                              │
│             int256 localAssetCashFromLiquidator,                                                                                                                                                                                             │
│             int256 liquidationDiscount                                                                                                                                                                                                       │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 assetCashBenefitRequired;                                                                                                                                                                                                     │
│         (assetCashBenefitRequired, liquidationDiscount) = LiquidationHelpers                                                                                                                                                                 │
│             .calculateCrossCurrencyBenefitAndDiscount(factors);                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             // collateralCurrencyBenefit = localPurchased * localBuffer * exchangeRate -                                                                                                                                                     │
│             //      collateralToSell * collateralHaircut                                                                                                                                                                                     │
│             // localPurchased = collateralToSell / (exchangeRate * liquidationDiscount)                                                                                                                                                      │
│             //                                                                                                                                                                                                                               │
│             // collateralCurrencyBenefit =  * localBuffer * exchangeRate -                                                                                                                                                                   │
│             //      collateralToSell * collateralHaircut                                                                                                                                                                                     │
│             // collateralCurrencyBenefit = (collateralToSell * localBuffer) / liquidationDiscount - collateralToSell * collateralHaircut                                                                                                     │
│             // collateralCurrencyBenefit = collateralToSell * (localBuffer / liquidationDiscount - collateralHaircut)                                                                                                                        │
│             // collateralToSell = collateralCurrencyBenefit / [(localBuffer / liquidationDiscount - collateralHaircut)]                                                                                                                      │
│             int256 denominator =                                                                                                                                                                                                             │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .buffer                                                                                                                                                                                                                  │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(liquidationDiscount)                                                                                                                                                                                                │
│                     .sub(factors.collateralETHRate.haircut);                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             requiredCollateralAssetCash = assetCashBenefitRequired                                                                                                                                                                           │
│                 .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(denominator);                                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         requiredCollateralAssetCash = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                         │
│             requiredCollateralAssetCash,                                                                                                                                                                                                     │
│             factors.collateralAssetAvailable,                                                                                                                                                                                                │
│             0 // will check userSpecifiedAmount below                                                                                                                                                                                        │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         // Enforce the user specified max liquidation amount                                                                                                                                                                                 │
│         if (                                                                                                                                                                                                                                 │
│             maxCollateralLiquidation > 0 && requiredCollateralAssetCash > maxCollateralLiquidation                                                                                                                                           │
│         ) {                                                                                                                                                                                                                                  │
│             requiredCollateralAssetCash = maxCollateralLiquidation;                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (requiredCollateralAssetCash, localAssetCashFromLiquidator) = LiquidationHelpers                                                                                                                                                     │
│             .calculateLocalToPurchase(                                                                                                                                                                                                       │
│                 factors,                                                                                                                                                                                                                     │
│                 liquidationDiscount,                                                                                                                                                                                                         │
│                 requiredCollateralAssetCash,                                                                                                                                                                                                 │
│                 requiredCollateralAssetCash                                                                                                                                                                                                  │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return (requiredCollateralAssetCash, localAssetCashFromLiquidator, liquidationDiscount);                                                                                                                                             │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateCollateralCurrency(                                                                                                                                                                                                    │
│         uint128 maxCollateralLiquidation,                                                                                                                                                                                                    │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│         require(factors.collateralAssetAvailable > 0, "No collateral");                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         (                                                                                                                                                                                                                                    │
│             int256 requiredCollateralAssetCash,                                                                                                                                                                                              │
│             int256 localAssetCashFromLiquidator,                                                                                                                                                                                             │
│             int256 liquidationDiscount                                                                                                                                                                                                       │
│         ) = _calculateCollateralToRaise(factors, int256(maxCollateralLiquidation));                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 collateralAssetRemaining = requiredCollateralAssetCash;                                                                                                                                                                       │
│         if (balanceState.storedCashBalance > 0) {                                                                                                                                                                                            │
│             if (balanceState.storedCashBalance > collateralAssetRemaining) {                                                                                                                                                                 │
│                 balanceState.netCashChange = collateralAssetRemaining.neg();                                                                                                                                                                 │
│                 collateralAssetRemaining = 0;                                                                                                                                                                                                │
│             } else {                                                                                                                                                                                                                         │
│                 // Sell off all cash balance and calculate remaining collateral                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.storedCashBalance.neg();                                                                                                                                                           │
│                 collateralAssetRemaining = collateralAssetRemaining.sub(                                                                                                                                                                     │
│                     balanceState.storedCashBalance                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             collateralAssetRemaining > 0 &&                                                                                                                                                                                                  │
│             _hasLiquidityTokens(portfolio.storedAssets, balanceState.currencyId)                                                                                                                                                             │
│         ) {                                                                                                                                                                                                                                  │
│             int256 newCollateralAssetRemaining =                                                                                                                                                                                             │
│                 _withdrawCollateralLiquidityTokens(                                                                                                                                                                                          │
│                     portfolio,                                                                                                                                                                                                               │
│                     factors,                                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     collateralAssetRemaining                                                                                                                                                                                                 │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             // This is a hack and ugly but there are stack issues in `LiquidateCurrencyAction.liquidateCollateralCurrency`                                                                                                                   │
│             // and this is a way to deal with it with the fewest contortions. There are no asset cash transfers within liquidation                                                                                                           │
│             // so we overload the meaning of the field here to hold the net liquidity token cash change. Will zero this out before                                                                                                           │
│             // going into finalize for the liquidated account's cash balances. This value is not simply added to the netCashChange field                                                                                                     │
│             // because the cashClaim value is not stored in the balances and therefore the liquidated account will have too much cash                                                                                                        │
│             // debited from their stored cash value.                                                                                                                                                                                         │
│             balanceState.netAssetTransferInternalPrecision = collateralAssetRemaining.sub(                                                                                                                                                   │
│                 newCollateralAssetRemaining                                                                                                                                                                                                  │
│             );                                                                                                                                                                                                                               │
│             collateralAssetRemaining = newCollateralAssetRemaining;                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (collateralAssetRemaining > 0 && factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                           │
│             collateralAssetRemaining = _calculateCollateralNTokenTransfer(                                                                                                                                                                   │
│                 balanceState,                                                                                                                                                                                                                │
│                 factors,                                                                                                                                                                                                                     │
│                 collateralAssetRemaining,                                                                                                                                                                                                    │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (collateralAssetRemaining > 0) {                                                                                                                                                                                                  │
│             // If there is any collateral asset remaining then recalculate the localAssetCashFromLiquidator                                                                                                                                  │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 /* collateralToRaise */,                                                                                                                                                                                                     │
│                 localAssetCashFromLiquidator                                                                                                                                                                                                 │
│             ) = LiquidationHelpers.calculateLocalToPurchase(                                                                                                                                                                                 │
│                 factors,                                                                                                                                                                                                                     │
│                 liquidationDiscount,                                                                                                                                                                                                         │
│                 requiredCollateralAssetCash.sub(collateralAssetRemaining),                                                                                                                                                                   │
│                 requiredCollateralAssetCash.sub(collateralAssetRemaining)                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return localAssetCashFromLiquidator;                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
│     function _calculateCollateralToRaise(                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         int256 maxCollateralLiquidation                                                                                                                                                                                                      │
│     )                                                                                                                                                                                                                                        │
│         private                                                                                                                                                                                                                              │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256 requiredCollateralAssetCash,                                                                                                                                                                                              │
│             int256 localAssetCashFromLiquidator,                                                                                                                                                                                             │
│             int256 liquidationDiscount                                                                                                                                                                                                       │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         int256 assetCashBenefitRequired;                                                                                                                                                                                                     │
│         (assetCashBenefitRequired, liquidationDiscount) = LiquidationHelpers                                                                                                                                                                 │
│             .calculateCrossCurrencyBenefitAndDiscount(factors);                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             // collateralCurrencyBenefit = localPurchased * localBuffer * exchangeRate -                                                                                                                                                     │
│             //      collateralToSell * collateralHaircut                                                                                                                                                                                     │
│             // localPurchased = collateralToSell / (exchangeRate * liquidationDiscount)                                                                                                                                                      │
│             //                                                                                                                                                                                                                               │
│             // collateralCurrencyBenefit =  * localBuffer * exchangeRate -                                                                                                                                                                   │
│             //      collateralToSell * collateralHaircut                                                                                                                                                                                     │
│             // collateralCurrencyBenefit = (collateralToSell * localBuffer) / liquidationDiscount - collateralToSell * collateralHaircut                                                                                                     │
│             // collateralCurrencyBenefit = collateralToSell * (localBuffer / liquidationDiscount - collateralHaircut)                                                                                                                        │
│             // collateralToSell = collateralCurrencyBenefit / [(localBuffer / liquidationDiscount - collateralHaircut)]                                                                                                                      │
│             int256 denominator =                                                                                                                                                                                                             │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .buffer                                                                                                                                                                                                                  │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(liquidationDiscount)                                                                                                                                                                                                │
│                     .sub(factors.collateralETHRate.haircut);                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             requiredCollateralAssetCash = assetCashBenefitRequired                                                                                                                                                                           │
│                 .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .div(denominator);                                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         requiredCollateralAssetCash = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                         │
│             requiredCollateralAssetCash,                                                                                                                                                                                                     │
│             factors.collateralAssetAvailable,                                                                                                                                                                                                │
│             0 // will check userSpecifiedAmount below                                                                                                                                                                                        │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         // Enforce the user specified max liquidation amount                                                                                                                                                                                 │
│         if (                                                                                                                                                                                                                                 │
│             maxCollateralLiquidation > 0 && requiredCollateralAssetCash > maxCollateralLiquidation                                                                                                                                           │
│         ) {                                                                                                                                                                                                                                  │
│             requiredCollateralAssetCash = maxCollateralLiquidation;                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (requiredCollateralAssetCash, localAssetCashFromLiquidator) = LiquidationHelpers                                                                                                                                                     │
│             .calculateLocalToPurchase(                                                                                                                                                                                                       │
│                 factors,                                                                                                                                                                                                                     │
│                 liquidationDiscount,                                                                                                                                                                                                         │
│                 requiredCollateralAssetCash,                                                                                                                                                                                                 │
│                 requiredCollateralAssetCash                                                                                                                                                                                                  │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return (requiredCollateralAssetCash, localAssetCashFromLiquidator, liquidationDiscount);                                                                                                                                             │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "Yes"}                                                                                                                                                                                                                     │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateLocalCurrency(                                                                                                                                                                                                         │
│         uint256 localCurrency,                                                                                                                                                                                                               │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 assetBenefitRequired =                                                                                                                                                                                                        │
│             factors.cashGroup.assetRate.convertFromUnderlying(                                                                                                                                                                               │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .convertETHTo(factors.netETHValue.neg())                                                                                                                                                                                 │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(factors.localETHRate.buffer)                                                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (_hasLiquidityTokens(portfolio.storedAssets, localCurrency)) {                                                                                                                                                                    │
│             WithdrawFactors memory w;                                                                                                                                                                                                        │
│             (w, assetBenefitRequired) = _withdrawLocalLiquidityTokens(                                                                                                                                                                       │
│                 portfolio,                                                                                                                                                                                                                   │
│                 factors,                                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 assetBenefitRequired                                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│             netAssetCashFromLiquidator = w.totalIncentivePaid.neg();                                                                                                                                                                         │
│             balanceState.netCashChange = w.totalCashClaim.sub(w.totalIncentivePaid);                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                                                           │
│             int256 nTokensToLiquidate;                                                                                                                                                                                                       │
│             {                                                                                                                                                                                                                                │
│                 // This will not underflow, checked when saving parameters                                                                                                                                                                   │
│                 int256 haircutDiff =                                                                                                                                                                                                         │
│                     int256(                                                                                                                                                                                                                  │
│                         uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE]) -                                                                                                                                          │
│                             uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])                                                                                                                                                 │
│                     ) * Constants.PERCENTAGE_DECIMALS;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // benefitGained = nTokensToLiquidate * (liquidatedPV - freeCollateralPV)                                                                                                                                                    │
│                 // benefitGained = nTokensToLiquidate * (fullNTokenPV * liquidatedPV - fullNTokenPV * pvHaircut)                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * fullNTokenPV * (liquidatedPV - pvHaircut) / totalBalance                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * (haircutTokenPV / haircutPercentage) * (liquidationHaircut - pvHaircut) / totalBalance                                                                                               │
│                 // benefitGained = nTokensToLiquidate * haircutTokenPV * (liquidationHaircut - pvHaircut) / (totalBalance * haircutPercentage)                                                                                               │
│                 // nTokensToLiquidate = (benefitGained * totalBalance * haircutPercentage) / (haircutTokenPV * (liquidationHaircut - pvHaircut))                                                                                             │
│                 nTokensToLiquidate = assetBenefitRequired                                                                                                                                                                                    │
│                     .mul(balanceState.storedNTokenBalance)                                                                                                                                                                                   │
│                     .mul(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                           │
│                     .div(factors.nTokenHaircutAssetValue.mul(haircutDiff));                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             nTokensToLiquidate = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                              │
│                 nTokensToLiquidate,                                                                                                                                                                                                          │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│             balanceState.netNTokenTransfer = nTokensToLiquidate.neg();                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             {                                                                                                                                                                                                                                │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // localFromLiquidator = tokensToLiquidate * fullNTokenPV * liquidationHaircut / totalBalance                                                                                                                                │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 int256 localAssetCash =                                                                                                                                                                                                      │
│                     nTokensToLiquidate                                                                                                                                                                                                       │
│                         .mul(int256(uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE])))                                                                                                                              │
│                         .mul(factors.nTokenHaircutAssetValue)                                                                                                                                                                                │
│                         .div(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                       │
│                         .div(balanceState.storedNTokenBalance);                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.netCashChange.add(localAssetCash);                                                                                                                                                 │
│                 netAssetCashFromLiquidator = netAssetCashFromLiquidator.add(localAssetCash);                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "Yes"}                                                                                                                                                                                                                     │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateLocalCurrency(                                                                                                                                                                                                         │
│         uint256 localCurrency,                                                                                                                                                                                                               │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 assetBenefitRequired =                                                                                                                                                                                                        │
│             factors.cashGroup.assetRate.convertFromUnderlying(                                                                                                                                                                               │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .convertETHTo(factors.netETHValue.neg())                                                                                                                                                                                 │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(factors.localETHRate.buffer)                                                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (_hasLiquidityTokens(portfolio.storedAssets, localCurrency)) {                                                                                                                                                                    │
│             WithdrawFactors memory w;                                                                                                                                                                                                        │
│             (w, assetBenefitRequired) = _withdrawLocalLiquidityTokens(                                                                                                                                                                       │
│                 portfolio,                                                                                                                                                                                                                   │
│                 factors,                                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 assetBenefitRequired                                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│             netAssetCashFromLiquidator = w.totalIncentivePaid.neg();                                                                                                                                                                         │
│             balanceState.netCashChange = w.totalCashClaim.sub(w.totalIncentivePaid);                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                                                           │
│             int256 nTokensToLiquidate;                                                                                                                                                                                                       │
│             {                                                                                                                                                                                                                                │
│                 // This will not underflow, checked when saving parameters                                                                                                                                                                   │
│                 int256 haircutDiff =                                                                                                                                                                                                         │
│                     int256(                                                                                                                                                                                                                  │
│                         uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE]) -                                                                                                                                          │
│                             uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])                                                                                                                                                 │
│                     ) * Constants.PERCENTAGE_DECIMALS;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // benefitGained = nTokensToLiquidate * (liquidatedPV - freeCollateralPV)                                                                                                                                                    │
│                 // benefitGained = nTokensToLiquidate * (fullNTokenPV * liquidatedPV - fullNTokenPV * pvHaircut)                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * fullNTokenPV * (liquidatedPV - pvHaircut) / totalBalance                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * (haircutTokenPV / haircutPercentage) * (liquidationHaircut - pvHaircut) / totalBalance                                                                                               │
│                 // benefitGained = nTokensToLiquidate * haircutTokenPV * (liquidationHaircut - pvHaircut) / (totalBalance * haircutPercentage)                                                                                               │
│                 // nTokensToLiquidate = (benefitGained * totalBalance * haircutPercentage) / (haircutTokenPV * (liquidationHaircut - pvHaircut))                                                                                             │
│                 nTokensToLiquidate = assetBenefitRequired                                                                                                                                                                                    │
│                     .mul(balanceState.storedNTokenBalance)                                                                                                                                                                                   │
│                     .mul(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                           │
│                     .div(factors.nTokenHaircutAssetValue.mul(haircutDiff));                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             nTokensToLiquidate = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                              │
│                 nTokensToLiquidate,                                                                                                                                                                                                          │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│             balanceState.netNTokenTransfer = nTokensToLiquidate.neg();                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             {                                                                                                                                                                                                                                │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // localFromLiquidator = tokensToLiquidate * fullNTokenPV * liquidationHaircut / totalBalance                                                                                                                                │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 int256 localAssetCash =                                                                                                                                                                                                      │
│                     nTokensToLiquidate                                                                                                                                                                                                       │
│                         .mul(int256(uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE])))                                                                                                                              │
│                         .mul(factors.nTokenHaircutAssetValue)                                                                                                                                                                                │
│                         .div(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                       │
│                         .div(balanceState.storedNTokenBalance);                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.netCashChange.add(localAssetCash);                                                                                                                                                 │
│                 netAssetCashFromLiquidator = netAssetCashFromLiquidator.add(localAssetCash);                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateLocalCurrency(                                                                                                                                                                                                         │
│         uint256 localCurrency,                                                                                                                                                                                                               │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 assetBenefitRequired =                                                                                                                                                                                                        │
│             factors.cashGroup.assetRate.convertFromUnderlying(                                                                                                                                                                               │
│                 factors                                                                                                                                                                                                                      │
│                     .localETHRate                                                                                                                                                                                                            │
│                     .convertETHTo(factors.netETHValue.neg())                                                                                                                                                                                 │
│                     .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                      │
│                     .div(factors.localETHRate.buffer)                                                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         int256 netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         if (_hasLiquidityTokens(portfolio.storedAssets, localCurrency)) {                                                                                                                                                                    │
│             WithdrawFactors memory w;                                                                                                                                                                                                        │
│             (w, assetBenefitRequired) = _withdrawLocalLiquidityTokens(                                                                                                                                                                       │
│                 portfolio,                                                                                                                                                                                                                   │
│                 factors,                                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 assetBenefitRequired                                                                                                                                                                                                         │
│             );                                                                                                                                                                                                                               │
│             netAssetCashFromLiquidator = w.totalIncentivePaid.neg();                                                                                                                                                                         │
│             balanceState.netCashChange = w.totalCashClaim.sub(w.totalIncentivePaid);                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                                                           │
│             int256 nTokensToLiquidate;                                                                                                                                                                                                       │
│             {                                                                                                                                                                                                                                │
│                 // This will not underflow, checked when saving parameters                                                                                                                                                                   │
│                 int256 haircutDiff =                                                                                                                                                                                                         │
│                     int256(                                                                                                                                                                                                                  │
│                         uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE]) -                                                                                                                                          │
│                             uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])                                                                                                                                                 │
│                     ) * Constants.PERCENTAGE_DECIMALS;                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // benefitGained = nTokensToLiquidate * (liquidatedPV - freeCollateralPV)                                                                                                                                                    │
│                 // benefitGained = nTokensToLiquidate * (fullNTokenPV * liquidatedPV - fullNTokenPV * pvHaircut)                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * fullNTokenPV * (liquidatedPV - pvHaircut) / totalBalance                                                                                                                             │
│                 // benefitGained = nTokensToLiquidate * (haircutTokenPV / haircutPercentage) * (liquidationHaircut - pvHaircut) / totalBalance                                                                                               │
│                 // benefitGained = nTokensToLiquidate * haircutTokenPV * (liquidationHaircut - pvHaircut) / (totalBalance * haircutPercentage)                                                                                               │
│                 // nTokensToLiquidate = (benefitGained * totalBalance * haircutPercentage) / (haircutTokenPV * (liquidationHaircut - pvHaircut))                                                                                             │
│                 nTokensToLiquidate = assetBenefitRequired                                                                                                                                                                                    │
│                     .mul(balanceState.storedNTokenBalance)                                                                                                                                                                                   │
│                     .mul(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                           │
│                     .div(factors.nTokenHaircutAssetValue.mul(haircutDiff));                                                                                                                                                                  │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             nTokensToLiquidate = LiquidationHelpers.calculateLiquidationAmount(                                                                                                                                                              │
│                 nTokensToLiquidate,                                                                                                                                                                                                          │
│                 balanceState.storedNTokenBalance,                                                                                                                                                                                            │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│             balanceState.netNTokenTransfer = nTokensToLiquidate.neg();                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│             {                                                                                                                                                                                                                                │
│                 // fullNTokenPV = haircutTokenPV / haircutPercentage                                                                                                                                                                         │
│                 // localFromLiquidator = tokensToLiquidate * fullNTokenPV * liquidationHaircut / totalBalance                                                                                                                                │
│                 // prettier-ignore                                                                                                                                                                                                           │
│                 int256 localAssetCash =                                                                                                                                                                                                      │
│                     nTokensToLiquidate                                                                                                                                                                                                       │
│                         .mul(int256(uint8(factors.nTokenParameters[Constants.LIQUIDATION_HAIRCUT_PERCENTAGE])))                                                                                                                              │
│                         .mul(factors.nTokenHaircutAssetValue)                                                                                                                                                                                │
│                         .div(int256(uint8(factors.nTokenParameters[Constants.PV_HAIRCUT_PERCENTAGE])))                                                                                                                                       │
│                         .div(balanceState.storedNTokenBalance);                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.netCashChange.add(localAssetCash);                                                                                                                                                 │
│                 netAssetCashFromLiquidator = netAssetCashFromLiquidator.add(localAssetCash);                                                                                                                                                 │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return netAssetCashFromLiquidator;                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculateNetCashIncreaseAndIncentivePaid(                                                                                                                                                                                      │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         WithdrawFactors memory w,                                                                                                                                                                                                            │
│         uint256 assetType                                                                                                                                                                                                                    │
│     ) private pure {                                                                                                                                                                                                                         │
│         // We can only recollateralize the local currency using the part of the liquidity token that                                                                                                                                         │
│         // between the pre-haircut cash claim and the post-haircut cash claim. Part of the cash raised                                                                                                                                       │
│         // is paid out as an incentive so that must be accounted for.                                                                                                                                                                        │
│         // netCashIncrease = cashClaim * (1 - haircut)                                                                                                                                                                                       │
│         // netCashIncrease = netCashToAccount + incentivePaid                                                                                                                                                                                │
│         // incentivePaid = netCashIncrease * incentive                                                                                                                                                                                       │
│         int256 haircut = int256(factors.cashGroup.getLiquidityHaircut(assetType));                                                                                                                                                           │
│         w.netCashIncrease = w.assetCash.mul(Constants.PERCENTAGE_DECIMALS.sub(haircut)).div(                                                                                                                                                 │
│             Constants.PERCENTAGE_DECIMALS                                                                                                                                                                                                    │
│         );                                                                                                                                                                                                                                   │
│         w.incentivePaid = w.netCashIncrease.mul(Constants.TOKEN_REPO_INCENTIVE_PERCENT).div(                                                                                                                                                 │
│             Constants.PERCENTAGE_DECIMALS                                                                                                                                                                                                    │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function _calculateNetCashIncreaseAndIncentivePaid(                                                                                                                                                                                      │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         WithdrawFactors memory w,                                                                                                                                                                                                            │
│         uint256 assetType                                                                                                                                                                                                                    │
│     ) private pure {                                                                                                                                                                                                                         │
│         // We can only recollateralize the local currency using the part of the liquidity token that                                                                                                                                         │
│         // between the pre-haircut cash claim and the post-haircut cash claim. Part of the cash raised                                                                                                                                       │
│         // is paid out as an incentive so that must be accounted for.                                                                                                                                                                        │
│         // netCashIncrease = cashClaim * (1 - haircut)                                                                                                                                                                                       │
│         // netCashIncrease = netCashToAccount + incentivePaid                                                                                                                                                                                │
│         // incentivePaid = netCashIncrease * incentive                                                                                                                                                                                       │
│         int256 haircut = int256(factors.cashGroup.getLiquidityHaircut(assetType));                                                                                                                                                           │
│         w.netCashIncrease = w.assetCash.mul(Constants.PERCENTAGE_DECIMALS.sub(haircut)).div(                                                                                                                                                 │
│             Constants.PERCENTAGE_DECIMALS                                                                                                                                                                                                    │
│         );                                                                                                                                                                                                                                   │
│         w.incentivePaid = w.netCashIncrease.mul(Constants.TOKEN_REPO_INCENTIVE_PERCENT).div(                                                                                                                                                 │
│             Constants.PERCENTAGE_DECIMALS                                                                                                                                                                                                    │
│         );                                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateCollateralCurrency(                                                                                                                                                                                                    │
│         uint128 maxCollateralLiquidation,                                                                                                                                                                                                    │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│         require(factors.collateralAssetAvailable > 0, "No collateral");                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         (                                                                                                                                                                                                                                    │
│             int256 requiredCollateralAssetCash,                                                                                                                                                                                              │
│             int256 localAssetCashFromLiquidator,                                                                                                                                                                                             │
│             int256 liquidationDiscount                                                                                                                                                                                                       │
│         ) = _calculateCollateralToRaise(factors, int256(maxCollateralLiquidation));                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 collateralAssetRemaining = requiredCollateralAssetCash;                                                                                                                                                                       │
│         if (balanceState.storedCashBalance > 0) {                                                                                                                                                                                            │
│             if (balanceState.storedCashBalance > collateralAssetRemaining) {                                                                                                                                                                 │
│                 balanceState.netCashChange = collateralAssetRemaining.neg();                                                                                                                                                                 │
│                 collateralAssetRemaining = 0;                                                                                                                                                                                                │
│             } else {                                                                                                                                                                                                                         │
│                 // Sell off all cash balance and calculate remaining collateral                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.storedCashBalance.neg();                                                                                                                                                           │
│                 collateralAssetRemaining = collateralAssetRemaining.sub(                                                                                                                                                                     │
│                     balanceState.storedCashBalance                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             collateralAssetRemaining > 0 &&                                                                                                                                                                                                  │
│             _hasLiquidityTokens(portfolio.storedAssets, balanceState.currencyId)                                                                                                                                                             │
│         ) {                                                                                                                                                                                                                                  │
│             int256 newCollateralAssetRemaining =                                                                                                                                                                                             │
│                 _withdrawCollateralLiquidityTokens(                                                                                                                                                                                          │
│                     portfolio,                                                                                                                                                                                                               │
│                     factors,                                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     collateralAssetRemaining                                                                                                                                                                                                 │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             // This is a hack and ugly but there are stack issues in `LiquidateCurrencyAction.liquidateCollateralCurrency`                                                                                                                   │
│             // and this is a way to deal with it with the fewest contortions. There are no asset cash transfers within liquidation                                                                                                           │
│             // so we overload the meaning of the field here to hold the net liquidity token cash change. Will zero this out before                                                                                                           │
│             // going into finalize for the liquidated account's cash balances. This value is not simply added to the netCashChange field                                                                                                     │
│             // because the cashClaim value is not stored in the balances and therefore the liquidated account will have too much cash                                                                                                        │
│             // debited from their stored cash value.                                                                                                                                                                                         │
│             balanceState.netAssetTransferInternalPrecision = collateralAssetRemaining.sub(                                                                                                                                                   │
│                 newCollateralAssetRemaining                                                                                                                                                                                                  │
│             );                                                                                                                                                                                                                               │
│             collateralAssetRemaining = newCollateralAssetRemaining;                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (collateralAssetRemaining > 0 && factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                           │
│             collateralAssetRemaining = _calculateCollateralNTokenTransfer(                                                                                                                                                                   │
│                 balanceState,                                                                                                                                                                                                                │
│                 factors,                                                                                                                                                                                                                     │
│                 collateralAssetRemaining,                                                                                                                                                                                                    │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (collateralAssetRemaining > 0) {                                                                                                                                                                                                  │
│             // If there is any collateral asset remaining then recalculate the localAssetCashFromLiquidator                                                                                                                                  │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 /* collateralToRaise */,                                                                                                                                                                                                     │
│                 localAssetCashFromLiquidator                                                                                                                                                                                                 │
│             ) = LiquidationHelpers.calculateLocalToPurchase(                                                                                                                                                                                 │
│                 factors,                                                                                                                                                                                                                     │
│                 liquidationDiscount,                                                                                                                                                                                                         │
│                 requiredCollateralAssetCash.sub(collateralAssetRemaining),                                                                                                                                                                   │
│                 requiredCollateralAssetCash.sub(collateralAssetRemaining)                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return localAssetCashFromLiquidator;                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function liquidateCollateralCurrency(                                                                                                                                                                                                    │
│         uint128 maxCollateralLiquidation,                                                                                                                                                                                                    │
│         uint96 maxNTokenLiquidation,                                                                                                                                                                                                         │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         BalanceState memory balanceState,                                                                                                                                                                                                    │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         PortfolioState memory portfolio                                                                                                                                                                                                      │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(factors.localAssetAvailable < 0, "No local debt");                                                                                                                                                                           │
│         require(factors.collateralAssetAvailable > 0, "No collateral");                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         (                                                                                                                                                                                                                                    │
│             int256 requiredCollateralAssetCash,                                                                                                                                                                                              │
│             int256 localAssetCashFromLiquidator,                                                                                                                                                                                             │
│             int256 liquidationDiscount                                                                                                                                                                                                       │
│         ) = _calculateCollateralToRaise(factors, int256(maxCollateralLiquidation));                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         int256 collateralAssetRemaining = requiredCollateralAssetCash;                                                                                                                                                                       │
│         if (balanceState.storedCashBalance > 0) {                                                                                                                                                                                            │
│             if (balanceState.storedCashBalance > collateralAssetRemaining) {                                                                                                                                                                 │
│                 balanceState.netCashChange = collateralAssetRemaining.neg();                                                                                                                                                                 │
│                 collateralAssetRemaining = 0;                                                                                                                                                                                                │
│             } else {                                                                                                                                                                                                                         │
│                 // Sell off all cash balance and calculate remaining collateral                                                                                                                                                              │
│                 balanceState.netCashChange = balanceState.storedCashBalance.neg();                                                                                                                                                           │
│                 collateralAssetRemaining = collateralAssetRemaining.sub(                                                                                                                                                                     │
│                     balanceState.storedCashBalance                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│             }                                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (                                                                                                                                                                                                                                 │
│             collateralAssetRemaining > 0 &&                                                                                                                                                                                                  │
│             _hasLiquidityTokens(portfolio.storedAssets, balanceState.currencyId)                                                                                                                                                             │
│         ) {                                                                                                                                                                                                                                  │
│             int256 newCollateralAssetRemaining =                                                                                                                                                                                             │
│                 _withdrawCollateralLiquidityTokens(                                                                                                                                                                                          │
│                     portfolio,                                                                                                                                                                                                               │
│                     factors,                                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     collateralAssetRemaining                                                                                                                                                                                                 │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             // This is a hack and ugly but there are stack issues in `LiquidateCurrencyAction.liquidateCollateralCurrency`                                                                                                                   │
│             // and this is a way to deal with it with the fewest contortions. There are no asset cash transfers within liquidation                                                                                                           │
│             // so we overload the meaning of the field here to hold the net liquidity token cash change. Will zero this out before                                                                                                           │
│             // going into finalize for the liquidated account's cash balances. This value is not simply added to the netCashChange field                                                                                                     │
│             // because the cashClaim value is not stored in the balances and therefore the liquidated account will have too much cash                                                                                                        │
│             // debited from their stored cash value.                                                                                                                                                                                         │
│             balanceState.netAssetTransferInternalPrecision = collateralAssetRemaining.sub(                                                                                                                                                   │
│                 newCollateralAssetRemaining                                                                                                                                                                                                  │
│             );                                                                                                                                                                                                                               │
│             collateralAssetRemaining = newCollateralAssetRemaining;                                                                                                                                                                          │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (collateralAssetRemaining > 0 && factors.nTokenHaircutAssetValue > 0) {                                                                                                                                                           │
│             collateralAssetRemaining = _calculateCollateralNTokenTransfer(                                                                                                                                                                   │
│                 balanceState,                                                                                                                                                                                                                │
│                 factors,                                                                                                                                                                                                                     │
│                 collateralAssetRemaining,                                                                                                                                                                                                    │
│                 int256(maxNTokenLiquidation)                                                                                                                                                                                                 │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         if (collateralAssetRemaining > 0) {                                                                                                                                                                                                  │
│             // If there is any collateral asset remaining then recalculate the localAssetCashFromLiquidator                                                                                                                                  │
│             // prettier-ignore                                                                                                                                                                                                               │
│             (                                                                                                                                                                                                                                │
│                 /* collateralToRaise */,                                                                                                                                                                                                     │
│                 localAssetCashFromLiquidator                                                                                                                                                                                                 │
│             ) = LiquidationHelpers.calculateLocalToPurchase(                                                                                                                                                                                 │
│                 factors,                                                                                                                                                                                                                     │
│                 liquidationDiscount,                                                                                                                                                                                                         │
│                 requiredCollateralAssetCash.sub(collateralAssetRemaining),                                                                                                                                                                   │
│                 requiredCollateralAssetCash.sub(collateralAssetRemaining)                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return localAssetCashFromLiquidator;                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateLocalToPurchase(                                                                                                                                                                                                       │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         int256 liquidationDiscount,                                                                                                                                                                                                          │
│         int256 collateralAssetPresentValue,                                                                                                                                                                                                  │
│         int256 collateralAssetBalanceToSell                                                                                                                                                                                                  │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         // Converts collateral present value to the local amount along with the liquidation discount.                                                                                                                                        │
│         // localPurchased = collateralToSell / (exchangeRate * liquidationDiscount)                                                                                                                                                          │
│         int256 collateralUnderlyingPresentValue =                                                                                                                                                                                            │
│             factors.cashGroup.assetRate.convertToUnderlying(collateralAssetPresentValue);                                                                                                                                                    │
│         int256 localUnderlyingFromLiquidator =                                                                                                                                                                                               │
│             collateralUnderlyingPresentValue                                                                                                                                                                                                 │
│                 .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .mul(factors.localETHRate.rateDecimals)                                                                                                                                                                                      │
│                 .div(ExchangeRate.exchangeRate(factors.localETHRate, factors.collateralETHRate))                                                                                                                                             │
│                 .div(liquidationDiscount);                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         int256 localAssetFromLiquidator =                                                                                                                                                                                                    │
│             factors.localAssetRate.convertFromUnderlying(localUnderlyingFromLiquidator);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         if (localAssetFromLiquidator > factors.localAssetAvailable.neg()) {                                                                                                                                                                  │
│             // If the local to purchase will flip the sign of localAssetAvailable then the calculations                                                                                                                                      │
│             // for the collateral purchase amounts will be thrown off. The positive portion of localAssetAvailable                                                                                                                           │
│             // has to have a haircut applied. If this haircut reduces the localAssetAvailable value below                                                                                                                                    │
│             // the collateralAssetValue then this may actually decrease overall free collateral.                                                                                                                                             │
│             collateralAssetBalanceToSell = collateralAssetBalanceToSell                                                                                                                                                                      │
│                 .mul(factors.localAssetAvailable.neg())                                                                                                                                                                                      │
│                 .div(localAssetFromLiquidator);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│             localAssetFromLiquidator = factors.localAssetAvailable.neg();                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (collateralAssetBalanceToSell, localAssetFromLiquidator);                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculateLocalToPurchaseUnderlying(                                                                                                                                                                                            │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         int256 liquidationDiscount,                                                                                                                                                                                                          │
│         int256 fCashLiquidationUnderlyingPV,                                                                                                                                                                                                 │
│         int256 fCashToLiquidate                                                                                                                                                                                                              │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         int256 localUnderlyingFromLiquidator =                                                                                                                                                                                               │
│             fCashLiquidationUnderlyingPV                                                                                                                                                                                                     │
│                 .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .mul(factors.localETHRate.rateDecimals)                                                                                                                                                                                      │
│                 .div(ExchangeRate.exchangeRate(factors.localETHRate, factors.collateralETHRate))                                                                                                                                             │
│                 .div(liquidationDiscount);                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         int256 localAssetFromLiquidator =                                                                                                                                                                                                    │
│             factors.localAssetRate.convertFromUnderlying(localUnderlyingFromLiquidator);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         if (localAssetFromLiquidator > factors.localAssetAvailable.neg()) {                                                                                                                                                                  │
│             // If the local to purchase will put the local available into negative territory we                                                                                                                                              │
│             // have to cut the collateral purchase amount back. Putting local available into negative                                                                                                                                        │
│             // territory will force the liquidated account to incur more debt.                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // This is still in underlying terms because it is multiplied by a ratio of two values in asset terms                                                                                                                            │
│             fCashToLiquidate = fCashToLiquidate.mul(factors.localAssetAvailable.neg()).div(                                                                                                                                                  │
│                 localAssetFromLiquidator                                                                                                                                                                                                     │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             localAssetFromLiquidator = factors.localAssetAvailable.neg();                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (fCashToLiquidate, localAssetFromLiquidator);                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _limitPurchaseByAvailableAmounts(                                                                                                                                                                                               │
│         fCashContext memory c,                                                                                                                                                                                                               │
│         int256 liquidationDiscountFactor,                                                                                                                                                                                                    │
│         int256 riskAdjustedDiscountFactor,                                                                                                                                                                                                   │
│         int256 fCashToLiquidate                                                                                                                                                                                                              │
│     ) private pure returns (int256, int256) {                                                                                                                                                                                                │
│         // The collateral value of the fCash is discounted back to PV given the liquidation discount factor,                                                                                                                                 │
│         // this is the discounted value that the liquidator will purchase it at.                                                                                                                                                             │
│         int256 fCashLiquidationUnderlyingPV = fCashToLiquidate.mulInRatePrecision(liquidationDiscountFactor);                                                                                                                                │
│         int256 fCashRiskAdjustedUnderlyingPV = fCashToLiquidate.mulInRatePrecision(riskAdjustedDiscountFactor);                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         // Ensures that collateralAssetAvailable does not go below zero                                                                                                                                                                      │
│         int256 collateralUnderlyingAvailable =                                                                                                                                                                                               │
│             c.factors.cashGroup.assetRate.convertToUnderlying(c.factors.collateralAssetAvailable);                                                                                                                                           │
│         if (fCashRiskAdjustedUnderlyingPV > collateralUnderlyingAvailable) {                                                                                                                                                                 │
│             // If inside this if statement then all collateralAssetAvailable should be coming from fCashRiskAdjustedPV                                                                                                                       │
│             // collateralAssetAvailable = fCashRiskAdjustedPV                                                                                                                                                                                │
│             // collateralAssetAvailable = fCashToLiquidate * riskAdjustedDiscountFactor                                                                                                                                                      │
│             // fCashToLiquidate = collateralAssetAvailable / riskAdjustedDiscountFactor                                                                                                                                                      │
│             fCashToLiquidate = collateralUnderlyingAvailable.divInRatePrecision(riskAdjustedDiscountFactor);                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             fCashRiskAdjustedUnderlyingPV = collateralUnderlyingAvailable;                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│             // Recalculate the PV at the new liquidation amount                                                                                                                                                                              │
│             fCashLiquidationUnderlyingPV = fCashToLiquidate.mulInRatePrecision(liquidationDiscountFactor);                                                                                                                                   │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 localAssetCashFromLiquidator;                                                                                                                                                                                                 │
│         (fCashToLiquidate, localAssetCashFromLiquidator) = _calculateLocalToPurchaseUnderlying(                                                                                                                                              │
│             c.factors,                                                                                                                                                                                                                       │
│             c.liquidationDiscount,                                                                                                                                                                                                           │
│             fCashLiquidationUnderlyingPV,                                                                                                                                                                                                    │
│             fCashToLiquidate                                                                                                                                                                                                                 │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         // As we liquidate here the local available and collateral available will change. Update values accordingly so                                                                                                                       │
│         // that the limits will be hit on subsequent iterations.                                                                                                                                                                             │
│         c.factors.collateralAssetAvailable = c.factors.collateralAssetAvailable.subNoNeg(                                                                                                                                                    │
│             c.factors.cashGroup.assetRate.convertFromUnderlying(fCashRiskAdjustedUnderlyingPV)                                                                                                                                               │
│         );                                                                                                                                                                                                                                   │
│         c.factors.localAssetAvailable = c.factors.localAssetAvailable.add(                                                                                                                                                                   │
│             localAssetCashFromLiquidator                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (fCashToLiquidate, localAssetCashFromLiquidator);                                                                                                                                                                             │
│     }                                                                                                                                                                                                                                        │
│     function _calculateLocalToPurchaseUnderlying(                                                                                                                                                                                            │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         int256 liquidationDiscount,                                                                                                                                                                                                          │
│         int256 fCashLiquidationUnderlyingPV,                                                                                                                                                                                                 │
│         int256 fCashToLiquidate                                                                                                                                                                                                              │
│     ) internal pure returns (int256, int256) {                                                                                                                                                                                               │
│         int256 localUnderlyingFromLiquidator =                                                                                                                                                                                               │
│             fCashLiquidationUnderlyingPV                                                                                                                                                                                                     │
│                 .mul(Constants.PERCENTAGE_DECIMALS)                                                                                                                                                                                          │
│                 .mul(factors.localETHRate.rateDecimals)                                                                                                                                                                                      │
│                 .div(ExchangeRate.exchangeRate(factors.localETHRate, factors.collateralETHRate))                                                                                                                                             │
│                 .div(liquidationDiscount);                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         int256 localAssetFromLiquidator =                                                                                                                                                                                                    │
│             factors.localAssetRate.convertFromUnderlying(localUnderlyingFromLiquidator);                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         if (localAssetFromLiquidator > factors.localAssetAvailable.neg()) {                                                                                                                                                                  │
│             // If the local to purchase will put the local available into negative territory we                                                                                                                                              │
│             // have to cut the collateral purchase amount back. Putting local available into negative                                                                                                                                        │
│             // territory will force the liquidated account to incur more debt.                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // This is still in underlying terms because it is multiplied by a ratio of two values in asset terms                                                                                                                            │
│             fCashToLiquidate = fCashToLiquidate.mul(factors.localAssetAvailable.neg()).div(                                                                                                                                                  │
│                 localAssetFromLiquidator                                                                                                                                                                                                     │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             localAssetFromLiquidator = factors.localAssetAvailable.neg();                                                                                                                                                                    │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (fCashToLiquidate, localAssetFromLiquidator);                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function exchange(                                                                                                                                                                                                                       │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountIn                                                                                                                                                                                                                     │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountOut = (amountIn * exchangeRate) / 1e18;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "Yes"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate, and have inside code statements that calculate/assign/distribute the balance/share/stake/fee/loan/reward                                                   │
│ Code:                                                                                                                                                                                                                                        │
│     function exchange(                                                                                                                                                                                                                       │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountIn                                                                                                                                                                                                                     │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountOut = (amountIn * exchangeRate) / 1e18;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function exchangeOut(                                                                                                                                                                                                                    │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountOut                                                                                                                                                                                                                    │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountIn = (amountOut * 1e18) / exchangeRate;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function assertRateDirection(                                                                                                                                                                                                            │
│         int256 base,                                                                                                                                                                                                                         │
│         int256 quote,                                                                                                                                                                                                                        │
│         ETHRate memory er                                                                                                                                                                                                                    │
│     ) private pure {                                                                                                                                                                                                                         │
│         require(er.rate > 0);                                                                                                                                                                                                                │
│         if (base == 0) return;                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         if (er.rate == er.rateDecimals) {                                                                                                                                                                                                    │
│             assert(quote.abs() == base.abs());                                                                                                                                                                                               │
│         } else if (er.rate < er.rateDecimals) {                                                                                                                                                                                              │
│             assert(quote.abs() < base.abs());                                                                                                                                                                                                │
│         } else if (er.rate > er.rateDecimals) {                                                                                                                                                                                              │
│             assert(quote.abs() > base.abs());                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function convertToETH(ETHRate memory er, int256 balance) external pure returns (int256) {                                                                                                                                                │
│         require(er.rate > 0);                                                                                                                                                                                                                │
│         int256 result = er.convertToETH(balance);                                                                                                                                                                                            │
│         assertBalanceSign(balance, result);                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function convertETHTo(ETHRate memory er, int256 balance) external pure returns (int256) {                                                                                                                                                │
│         require(er.rate > 0);                                                                                                                                                                                                                │
│         int256 result = er.convertETHTo(balance);                                                                                                                                                                                            │
│         assertBalanceSign(balance, result);                                                                                                                                                                                                  │
│         assertRateDirection(result, balance, er);                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function exchangeRate(ETHRate memory baseER, ETHRate memory quoteER)                                                                                                                                                                     │
│         external                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                        │
│         require(baseER.rate > 0);                                                                                                                                                                                                            │
│         require(quoteER.rate > 0);                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 result = baseER.exchangeRate(quoteER);                                                                                                                                                                                        │
│         assert(result > 0);                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _getRateAnchor(                                                                                                                                                                                                                 │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         uint256 lastImpliedRate,                                                                                                                                                                                                             │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     ) internal pure returns (int256, bool) {                                                                                                                                                                                                 │
│         // This is the exchange rate at the new time to maturity                                                                                                                                                                             │
│         int256 exchangeRate = getExchangeRateFromImpliedRate(lastImpliedRate, timeToMaturity);                                                                                                                                               │
│         if (exchangeRate < Constants.RATE_PRECISION) return (0, false);                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         int256 rateAnchor;                                                                                                                                                                                                                   │
│         {                                                                                                                                                                                                                                    │
│             int256 proportion =                                                                                                                                                                                                              │
│                 totalfCash.divInRatePrecision(totalfCash.add(totalCashUnderlying));                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             (int256 lnProportion, bool success) = _logProportion(proportion);                                                                                                                                                                │
│             if (!success) return (0, false);                                                                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│             rateAnchor = exchangeRate.sub(lnProportion.divInRatePrecision(rateScalar));                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (rateAnchor, true);                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
│     function exchangeRate(ETHRate memory baseER, ETHRate memory quoteER)                                                                                                                                                                     │
│         external                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                        │
│         require(baseER.rate > 0);                                                                                                                                                                                                            │
│         require(quoteER.rate > 0);                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 result = baseER.exchangeRate(quoteER);                                                                                                                                                                                        │
│         assert(result > 0);                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function _calculateDelta(                                                                                                                                                                                                                │
│         int256 cashAmount,                                                                                                                                                                                                                   │
│         int256 totalfCash,                                                                                                                                                                                                                   │
│         int256 totalCashUnderlying,                                                                                                                                                                                                          │
│         int256 rateScalar,                                                                                                                                                                                                                   │
│         int256 fCashGuess,                                                                                                                                                                                                                   │
│         int256 exchangeRate,                                                                                                                                                                                                                 │
│         int256 feeRate                                                                                                                                                                                                                       │
│     ) private pure returns (int256) {                                                                                                                                                                                                        │
│         int256 derivative;                                                                                                                                                                                                                   │
│         // rateScalar * (totalfCash - fCash) * (totalCash + fCash)                                                                                                                                                                           │
│         // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                    │
│         int256 denominator =                                                                                                                                                                                                                 │
│             rateScalar.mulInRatePrecision(                                                                                                                                                                                                   │
│                 (totalfCash.sub(fCashGuess)).mul(totalCashUnderlying.add(fCashGuess))                                                                                                                                                        │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         if (fCashGuess > 0) {                                                                                                                                                                                                                │
│             // Lending                                                                                                                                                                                                                       │
│             exchangeRate = exchangeRate.divInRatePrecision(feeRate);                                                                                                                                                                         │
│             require(exchangeRate >= Constants.RATE_PRECISION); // dev: rate underflow                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             // (cashAmount / fee) * (totalfCash + totalCash)                                                                                                                                                                                 │
│             // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                │
│             derivative = cashAmount                                                                                                                                                                                                          │
│                 .mul(totalfCash.add(totalCashUnderlying))                                                                                                                                                                                    │
│                 .divInRatePrecision(feeRate);                                                                                                                                                                                                │
│         } else {                                                                                                                                                                                                                             │
│             // Borrowing                                                                                                                                                                                                                     │
│             exchangeRate = exchangeRate.mulInRatePrecision(feeRate);                                                                                                                                                                         │
│             require(exchangeRate >= Constants.RATE_PRECISION); // dev: rate underflow                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             // (cashAmount * fee) * (totalfCash + totalCash)                                                                                                                                                                                 │
│             // Precision: TOKEN_PRECISION ^ 2                                                                                                                                                                                                │
│             derivative = cashAmount.mulInRatePrecision(                                                                                                                                                                                      │
│                 feeRate.mul(totalfCash.add(totalCashUnderlying))                                                                                                                                                                             │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│         // 1 - numerator / denominator                                                                                                                                                                                                       │
│         // Precision: TOKEN_PRECISION                                                                                                                                                                                                        │
│         derivative = Constants.INTERNAL_TOKEN_PRECISION.sub(derivative.div(denominator));                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // f(fCash) = cashAmount * exchangeRate * fee + fCash                                                                                                                                                                                │
│         // NOTE: exchangeRate at this point already has the fee taken into account                                                                                                                                                           │
│         int256 numerator = cashAmount.mulInRatePrecision(exchangeRate);                                                                                                                                                                      │
│         numerator = numerator.add(fCashGuess);                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         // f(fCash) / f'(fCash), note that they are both denominated as cashAmount so use TOKEN_PRECISION                                                                                                                                    │
│         // here instead of RATE_PRECISION                                                                                                                                                                                                    │
│         return numerator.mul(Constants.INTERNAL_TOKEN_PRECISION).div(derivative);                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
│     function exchangeRate(ETHRate memory baseER, ETHRate memory quoteER)                                                                                                                                                                     │
│         external                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                        │
│         require(baseER.rate > 0);                                                                                                                                                                                                            │
│         require(quoteER.rate > 0);                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│         int256 result = baseER.exchangeRate(quoteER);                                                                                                                                                                                        │
│         assert(result > 0);                                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function convert(uint256 currencyId, int256 balance) public view returns (int256, int256) {                                                                                                                                              │
│         AssetRateParameters memory assetRate = AssetRate.buildAssetRateView(currencyId);                                                                                                                                                     │
│         int256 underlying = AssetRate.convertToUnderlying(assetRate, balance);                                                                                                                                                               │
│         ETHRate memory ethRate = ExchangeRate.buildExchangeRate(currencyId);                                                                                                                                                                 │
│         int256 eth = ExchangeRate.convertToETH(ethRate, underlying);                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return (underlying, eth);                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         int256 notional,                                                                                                                                                                                                                     │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 oracleRate                                                                                                                                                                                                                   │
│     ) public pure returns (int256) {                                                                                                                                                                                                         │
│         int256 pv = AssetHandler.getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                 │
│         if (notional > 0) assert(pv > 0);                                                                                                                                                                                                    │
│         if (notional < 0) assert(pv < 0);                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         assert(pv.abs() <= notional.abs());                                                                                                                                                                                                  │
│         return pv;                                                                                                                                                                                                                           │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getRiskAdjustedPresentValue(                                                                                                                                                                                                    │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 notional,                                                                                                                                                                                                                     │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 oracleRate                                                                                                                                                                                                                   │
│     ) public pure returns (int256) {                                                                                                                                                                                                         │
│         int256 riskPv =                                                                                                                                                                                                                      │
│             AssetHandler.getRiskAdjustedPresentValue(                                                                                                                                                                                        │
│                 cashGroup,                                                                                                                                                                                                                   │
│                 notional,                                                                                                                                                                                                                    │
│                 maturity,                                                                                                                                                                                                                    │
│                 blockTime,                                                                                                                                                                                                                   │
│                 oracleRate                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│         int256 pv = getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         assert(riskPv <= pv);                                                                                                                                                                                                                │
│         assert(riskPv.abs() <= notional.abs());                                                                                                                                                                                              │
│         return riskPv;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getCashClaims(                                                                                                                                                                                                                  │
│         PortfolioAsset memory liquidityToken,                                                                                                                                                                                                │
│         MarketParameters memory marketState                                                                                                                                                                                                  │
│     ) public pure returns (int256, int256) {                                                                                                                                                                                                 │
│         (int256 cash, int256 fCash) = liquidityToken.getCashClaims(marketState);                                                                                                                                                             │
│         assert(cash > 0);                                                                                                                                                                                                                    │
│         assert(fCash > 0);                                                                                                                                                                                                                   │
│         assert(cash <= marketState.totalAssetCash);                                                                                                                                                                                          │
│         assert(fCash <= marketState.totalfCash);                                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         return (cash, fCash);                                                                                                                                                                                                                │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256, int256) {                                                                                                                                                                                               │
│         PortfolioAsset memory liquidityToken = assets;                                                                                                                                                                                       │
│         require(isLiquidityToken(liquidityToken.assetType) && liquidityToken.notional >= 0); // dev: get liquidity token value, not liquidity token                                                                                          │
│                                                                                                                                                                                                                                              │
│         {                                                                                                                                                                                                                                    │
│             (uint256 marketIndex, bool idiosyncratic) =                                                                                                                                                                                      │
│                 DateTime.getMarketIndex(                                                                                                                                                                                                     │
│                     cashGroup.maxMarketIndex,                                                                                                                                                                                                │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime                                                                                                                                                                                                                │
│                 );                                                                                                                                                                                                                           │
│             // Liquidity tokens can never be idiosyncratic                                                                                                                                                                                   │
│             require(!idiosyncratic); // dev: idiosyncratic liquidity token                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│             // This market will always be initialized, if a liquidity token exists that means the market has some liquidity in it.                                                                                                           │
│             cashGroup.loadMarket(market, marketIndex, true, blockTime);                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         int256 assetCashClaim;                                                                                                                                                                                                               │
│         int256 fCashClaim;                                                                                                                                                                                                                   │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             (assetCashClaim, fCashClaim) = getHaircutCashClaims(liquidityToken, market, cashGroup);                                                                                                                                          │
│         } else {                                                                                                                                                                                                                             │
│             (assetCashClaim, fCashClaim) = getCashClaims(liquidityToken, market);                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // Find the matching fCash asset and net off the value, assumes that the portfolio is sorted and                                                                                                                                     │
│         // in that case we know the previous asset will be the matching fCash asset                                                                                                                                                          │
│         if (                                                                                                                                                                                                                                 │
│             index > 0 &&                                                                                                                                                                                                                     │
│             assets.currencyId == liquidityToken.currencyId &&                                                                                                                                                                                │
│             assets.maturity == liquidityToken.maturity &&                                                                                                                                                                                    │
│             assets.assetType == Constants.FCASH_ASSET_TYPE                                                                                                                                                                                   │
│         ) {                                                                                                                                                                                                                                  │
│             // Net off the fCashClaim here and we will discount it to present value in the second pass.                                                                                                                                      │
│             // WARNING: this modifies the portfolio in memory and therefore we cannot store this portfolio!                                                                                                                                  │
│             assets.notional = assets.notional.add(fCashClaim);                                                                                                                                                                               │
│             return (assetCashClaim, 0);                                                                                                                                                                                                      │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         // If not matching fCash asset found then get the pv directly                                                                                                                                                                        │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     fCashClaim,                                                                                                                                                                                                              │
│                     liquidityToken.maturity,                                                                                                                                                                                                 │
│                     blockTime,                                                                                                                                                                                                               │
│                     market.oracleRate                                                                                                                                                                                                        │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getPresentValue(fCashClaim, liquidityToken.maturity, blockTime, market.oracleRate);                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             return (assetCashClaim, pv);                                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function getCashClaims(                                                                                                                                                                                                                  │
│         PortfolioAsset memory liquidityToken,                                                                                                                                                                                                │
│         MarketParameters memory marketState                                                                                                                                                                                                  │
│     ) public pure returns (int256, int256) {                                                                                                                                                                                                 │
│         (int256 cash, int256 fCash) = liquidityToken.getCashClaims(marketState);                                                                                                                                                             │
│         assert(cash > 0);                                                                                                                                                                                                                    │
│         assert(fCash > 0);                                                                                                                                                                                                                   │
│         assert(cash <= marketState.totalAssetCash);                                                                                                                                                                                          │
│         assert(fCash <= marketState.totalfCash);                                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         return (cash, fCash);                                                                                                                                                                                                                │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValueRiskAdjusted(                                                                                                                                                                                             │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         public                                                                                                                                                                                                                               │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             PortfolioAsset[] memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         (int256 assetValue, int256 pv) =                                                                                                                                                                                                     │
│             AssetHandler.getLiquidityTokenValue(index, cashGroup, market, assets, blockTime, true);                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (assetValue, pv, assets);                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValueRiskAdjusted(                                                                                                                                                                                             │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         public                                                                                                                                                                                                                               │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             PortfolioAsset[] memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         (int256 assetValue, int256 pv) =                                                                                                                                                                                                     │
│             AssetHandler.getLiquidityTokenValue(index, cashGroup, market, assets, blockTime, true);                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         return (assetValue, pv, assets);                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         public                                                                                                                                                                                                                               │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             PortfolioAsset[] memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         (int256 assetValue, int256 pv) =                                                                                                                                                                                                     │
│             AssetHandler.getLiquidityTokenValue(index, cashGroup, market, assets, blockTime, false);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return (assetValue, pv, assets);                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         public                                                                                                                                                                                                                               │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             PortfolioAsset[] memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         (int256 assetValue, int256 pv) =                                                                                                                                                                                                     │
│             AssetHandler.getLiquidityTokenValue(index, cashGroup, market, assets, blockTime, false);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return (assetValue, pv, assets);                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getNetCashGroupValue(                                                                                                                                                                                                           │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 portfolioIndex                                                                                                                                                                                                               │
│     ) internal view returns (int256, uint256) {                                                                                                                                                                                              │
│         int256 presentValueAsset;                                                                                                                                                                                                            │
│         int256 presentValueUnderlying;                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         // First calculate value of liquidity tokens because we need to net off fCash value                                                                                                                                                  │
│         // before discounting to present value                                                                                                                                                                                               │
│         for (uint256 i = portfolioIndex; i < assets.length; i++) {                                                                                                                                                                           │
│             if (!isLiquidityToken(assets.assetType)) continue;                                                                                                                                                                               │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             (int256 assetCashClaim, int256 pv) =                                                                                                                                                                                             │
│                 getLiquidityTokenValue(                                                                                                                                                                                                      │
│                     i,                                                                                                                                                                                                                       │
│                     cashGroup,                                                                                                                                                                                                               │
│                     market,                                                                                                                                                                                                                  │
│                     assets,                                                                                                                                                                                                                  │
│                     blockTime,                                                                                                                                                                                                               │
│                     true // risk adjusted                                                                                                                                                                                                    │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             presentValueAsset = presentValueAsset.add(assetCashClaim);                                                                                                                                                                       │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 j = portfolioIndex;                                                                                                                                                                                                          │
│         for (; j < assets.length; j++) {                                                                                                                                                                                                     │
│             if (assets.assetType != Constants.FCASH_ASSET_TYPE) continue;                                                                                                                                                                    │
│             // If we hit a different currency id then we've accounted for all assets in this currency                                                                                                                                        │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             uint256 maturity = assets.maturity;                                                                                                                                                                                              │
│             uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     assets.notional,                                                                                                                                                                                                         │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         presentValueAsset = presentValueAsset.add(                                                                                                                                                                                           │
│             cashGroup.assetRate.convertFromUnderlying(presentValueUnderlying)                                                                                                                                                                │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (presentValueAsset, j);                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         public                                                                                                                                                                                                                               │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             PortfolioAsset[] memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         (int256 assetValue, int256 pv) =                                                                                                                                                                                                     │
│             AssetHandler.getLiquidityTokenValue(index, cashGroup, market, assets, blockTime, false);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return (assetValue, pv, assets);                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getNetCashGroupValue(                                                                                                                                                                                                           │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         uint256 portfolioIndex                                                                                                                                                                                                               │
│     ) internal view returns (int256, uint256) {                                                                                                                                                                                              │
│         int256 presentValueAsset;                                                                                                                                                                                                            │
│         int256 presentValueUnderlying;                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         // First calculate value of liquidity tokens because we need to net off fCash value                                                                                                                                                  │
│         // before discounting to present value                                                                                                                                                                                               │
│         for (uint256 i = portfolioIndex; i < assets.length; i++) {                                                                                                                                                                           │
│             if (!isLiquidityToken(assets.assetType)) continue;                                                                                                                                                                               │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             (int256 assetCashClaim, int256 pv) =                                                                                                                                                                                             │
│                 getLiquidityTokenValue(                                                                                                                                                                                                      │
│                     i,                                                                                                                                                                                                                       │
│                     cashGroup,                                                                                                                                                                                                               │
│                     market,                                                                                                                                                                                                                  │
│                     assets,                                                                                                                                                                                                                  │
│                     blockTime,                                                                                                                                                                                                               │
│                     true // risk adjusted                                                                                                                                                                                                    │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│             presentValueAsset = presentValueAsset.add(assetCashClaim);                                                                                                                                                                       │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         uint256 j = portfolioIndex;                                                                                                                                                                                                          │
│         for (; j < assets.length; j++) {                                                                                                                                                                                                     │
│             if (assets.assetType != Constants.FCASH_ASSET_TYPE) continue;                                                                                                                                                                    │
│             // If we hit a different currency id then we've accounted for all assets in this currency                                                                                                                                        │
│             if (assets.currencyId != cashGroup.currencyId) break;                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             uint256 maturity = assets.maturity;                                                                                                                                                                                              │
│             uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│             int256 pv =                                                                                                                                                                                                                      │
│                 getRiskAdjustedPresentValue(                                                                                                                                                                                                 │
│                     cashGroup,                                                                                                                                                                                                               │
│                     assets.notional,                                                                                                                                                                                                         │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│             presentValueUnderlying = presentValueUnderlying.add(pv);                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         presentValueAsset = presentValueAsset.add(                                                                                                                                                                                           │
│             cashGroup.assetRate.convertFromUnderlying(presentValueUnderlying)                                                                                                                                                                │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         return (presentValueAsset, j);                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
│     function getLiquidityTokenValue(                                                                                                                                                                                                         │
│         uint256 index,                                                                                                                                                                                                                       │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         PortfolioAsset[] memory assets,                                                                                                                                                                                                      │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     )                                                                                                                                                                                                                                        │
│         public                                                                                                                                                                                                                               │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             int256,                                                                                                                                                                                                                          │
│             int256,                                                                                                                                                                                                                          │
│             PortfolioAsset[] memory                                                                                                                                                                                                          │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         (int256 assetValue, int256 pv) =                                                                                                                                                                                                     │
│             AssetHandler.getLiquidityTokenValue(index, cashGroup, market, assets, blockTime, false);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return (assetValue, pv, assets);                                                                                                                                                                                                     │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function withdraw(uint256 wad) public {                                                                                                                                                                                                  │
│         require(balanceOf >= wad, "");                                                                                                                                                                                                       │
│         balanceOf -= wad;                                                                                                                                                                                                                    │
│         // WARNING: msg.sender.transfer fails in buidler, not sure if this will fail                                                                                                                                                         │
│         // on real environments                                                                                                                                                                                                              │
│         msg.sender.transfer(wad);                                                                                                                                                                                                            │
│         emit Withdrawal(msg.sender, wad);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function transferFrom(                                                                                                                                                                                                                   │
│         address src,                                                                                                                                                                                                                         │
│         address dst,                                                                                                                                                                                                                         │
│         uint256 wad                                                                                                                                                                                                                          │
│     ) public returns (bool) {                                                                                                                                                                                                                │
│         require(balanceOf >= wad, "");                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (src != msg.sender && allowance != uint256(-1)) {                                                                                                                                                                                 │
│             require(allowance >= wad, "");                                                                                                                                                                                                   │
│             allowance -= wad;                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         balanceOf -= wad;                                                                                                                                                                                                                    │
│         balanceOf += wad;                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         emit Transfer(src, dst, wad);                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         return true;                                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function exchange(                                                                                                                                                                                                                       │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountIn                                                                                                                                                                                                                     │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountOut = (amountIn * exchangeRate) / 1e18;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function transferFrom(                                                                                                                                                                                                                   │
│         address src,                                                                                                                                                                                                                         │
│         address dst,                                                                                                                                                                                                                         │
│         uint256 wad                                                                                                                                                                                                                          │
│     ) public returns (bool) {                                                                                                                                                                                                                │
│         require(balanceOf >= wad, "");                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (src != msg.sender && allowance != uint256(-1)) {                                                                                                                                                                                 │
│             require(allowance >= wad, "");                                                                                                                                                                                                   │
│             allowance -= wad;                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         balanceOf -= wad;                                                                                                                                                                                                                    │
│         balanceOf += wad;                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         emit Transfer(src, dst, wad);                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         return true;                                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function exchangeOut(                                                                                                                                                                                                                    │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountOut                                                                                                                                                                                                                    │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountIn = (amountOut * 1e18) / exchangeRate;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function transferFrom(                                                                                                                                                                                                                   │
│         address src,                                                                                                                                                                                                                         │
│         address dst,                                                                                                                                                                                                                         │
│         uint256 wad                                                                                                                                                                                                                          │
│     ) public returns (bool) {                                                                                                                                                                                                                │
│         require(balanceOf >= wad, "");                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (src != msg.sender && allowance != uint256(-1)) {                                                                                                                                                                                 │
│             require(allowance >= wad, "");                                                                                                                                                                                                   │
│             allowance -= wad;                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         balanceOf -= wad;                                                                                                                                                                                                                    │
│         balanceOf += wad;                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         emit Transfer(src, dst, wad);                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         return true;                                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function executeFlashLoan(                                                                                                                                                                                                               │
│         address[] calldata assets,                                                                                                                                                                                                           │
│         uint256[] calldata amounts,                                                                                                                                                                                                          │
│         IFlashLoanReceiver receiver,                                                                                                                                                                                                         │
│         bytes calldata params                                                                                                                                                                                                                │
│     ) external {                                                                                                                                                                                                                             │
│         uint256[] memory premiums = new uint256[](assets.length);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < assets.length; i++) {                                                                                                                                                                                            │
│             // 9 basis point fee                                                                                                                                                                                                             │
│             premiums = (amounts * 9) / 10000;                                                                                                                                                                                                │
│             IERC20(assets).transfer(address(receiver), amounts);                                                                                                                                                                             │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         bool success = receiver.executeOperation(assets, amounts, premiums, msg.sender, params);                                                                                                                                             │
│         require(success);                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < assets.length; i++) {                                                                                                                                                                                            │
│             IERC20(assets).transferFrom(                                                                                                                                                                                                     │
│                 address(receiver),                                                                                                                                                                                                           │
│                 address(this),                                                                                                                                                                                                               │
│                 amounts + premiums                                                                                                                                                                                                           │
│             );                                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function transferFrom(                                                                                                                                                                                                                   │
│         address src,                                                                                                                                                                                                                         │
│         address dst,                                                                                                                                                                                                                         │
│         uint256 wad                                                                                                                                                                                                                          │
│     ) public returns (bool) {                                                                                                                                                                                                                │
│         require(balanceOf >= wad, "");                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         if (src != msg.sender && allowance != uint256(-1)) {                                                                                                                                                                                 │
│             require(allowance >= wad, "");                                                                                                                                                                                                   │
│             allowance -= wad;                                                                                                                                                                                                                │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         balanceOf -= wad;                                                                                                                                                                                                                    │
│         balanceOf += wad;                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         emit Transfer(src, dst, wad);                                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│         return true;                                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getRateScalar(                                                                                                                                                                                                                  │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         uint256 timeToMaturity                                                                                                                                                                                                               │
│     ) public pure returns (int256) {                                                                                                                                                                                                         │
│         int256 rateScalar = cashGroup.getRateScalar(marketIndex, timeToMaturity);                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         return rateScalar;                                                                                                                                                                                                                   │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function interpolateOracleRate(                                                                                                                                                                                                          │
│         uint256 shortMaturity,                                                                                                                                                                                                               │
│         uint256 longMaturity,                                                                                                                                                                                                                │
│         uint256 shortRate,                                                                                                                                                                                                                   │
│         uint256 longRate,                                                                                                                                                                                                                    │
│         uint256 assetMaturity                                                                                                                                                                                                                │
│     ) public pure returns (uint256) {                                                                                                                                                                                                        │
│         uint256 rate =                                                                                                                                                                                                                       │
│             CashGroup.interpolateOracleRate(                                                                                                                                                                                                 │
│                 shortMaturity,                                                                                                                                                                                                               │
│                 longMaturity,                                                                                                                                                                                                                │
│                 shortRate,                                                                                                                                                                                                                   │
│                 longRate,                                                                                                                                                                                                                    │
│                 assetMaturity                                                                                                                                                                                                                │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         if (shortRate == longRate) {                                                                                                                                                                                                         │
│             assert(rate == shortRate);                                                                                                                                                                                                       │
│         } else if (shortRate < longRate) {                                                                                                                                                                                                   │
│             assert(shortRate < rate && rate < longRate);                                                                                                                                                                                     │
│         } else {                                                                                                                                                                                                                             │
│             assert(shortRate > rate && rate > longRate);                                                                                                                                                                                     │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return rate;                                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ have code statements that get or calculate LP token's value/price                                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function addLiquidity(MarketParameters memory marketState, int256 assetCash)                                                                                                                                                             │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 liquidityTokens, int256 fCash) = marketState.addLiquidity(assetCash);                                                                                                                                                        │
│         assert(liquidityTokens >= 0);                                                                                                                                                                                                        │
│         assert(fCash <= 0);                                                                                                                                                                                                                  │
│         return (marketState, liquidityTokens, fCash);                                                                                                                                                                                        │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "No"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function addLiquidity(MarketParameters memory marketState, int256 assetCash)                                                                                                                                                             │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 liquidityTokens, int256 fCash) = marketState.addLiquidity(assetCash);                                                                                                                                                        │
│         assert(liquidityTokens >= 0);                                                                                                                                                                                                        │
│         assert(fCash <= 0);                                                                                                                                                                                                                  │
│         return (marketState, liquidityTokens, fCash);                                                                                                                                                                                        │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory marketState, int256 tokensToRemove)                                                                                                                                                     │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 assetCash, int256 fCash) = marketState.removeLiquidity(tokensToRemove);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         assert(assetCash >= 0);                                                                                                                                                                                                              │
│         assert(fCash >= 0);                                                                                                                                                                                                                  │
│         return (marketState, assetCash, fCash);                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory marketState, int256 tokensToRemove)                                                                                                                                                     │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 assetCash, int256 fCash) = marketState.removeLiquidity(tokensToRemove);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         assert(assetCash >= 0);                                                                                                                                                                                                              │
│         assert(fCash >= 0);                                                                                                                                                                                                                  │
│         return (marketState, assetCash, fCash);                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawCollateralLiquidityTokens(                                                                                                                                                                                             │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 collateralToWithdraw                                                                                                                                                                                                          │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│             (int256 cashClaim, int256 fCashClaim) =                                                                                                                                                                                          │
│                 asset.getCashClaims(factors.markets);                                                                                                                                                                                        │
│                                                                                                                                                                                                                                              │
│             if (cashClaim <= collateralToWithdraw) {                                                                                                                                                                                         │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 collateralToWithdraw = collateralToWithdraw - cashClaim;                                                                                                                                                                     │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 // NOTE: dust can accrue when withdrawing liquidity at this point                                                                                                                                                            │
│                 int256 tokensToRemove = asset.notional.mul(collateralToWithdraw).div(cashClaim);                                                                                                                                             │
│                 (cashClaim, fCashClaim) = factors.markets.removeLiquidity(                                                                                                                                                                   │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 collateralToWithdraw = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 fCashClaim                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (collateralToWithdraw == 0) return 0;                                                                                                                                                                                         │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return collateralToWithdraw;                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory marketState, int256 tokensToRemove)                                                                                                                                                     │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 assetCash, int256 fCash) = marketState.removeLiquidity(tokensToRemove);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         assert(assetCash >= 0);                                                                                                                                                                                                              │
│         assert(fCash >= 0);                                                                                                                                                                                                                  │
│         return (marketState, assetCash, fCash);                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries,                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory marketState, int256 tokensToRemove)                                                                                                                                                     │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 assetCash, int256 fCash) = marketState.removeLiquidity(tokensToRemove);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         assert(assetCash >= 0);                                                                                                                                                                                                              │
│         assert(fCash >= 0);                                                                                                                                                                                                                  │
│         return (marketState, assetCash, fCash);                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve calculating swap/liquidity or adding liquidity, and there is asset exchanges or price queries, but this operation could be attacked by slippage/Sandwich Attack due to no slip limit/minimum value check                  │
│ Code:                                                                                                                                                                                                                                        │
│     function _withdrawLocalLiquidityTokens(                                                                                                                                                                                                  │
│         PortfolioState memory portfolioState,                                                                                                                                                                                                │
│         LiquidationFactors memory factors,                                                                                                                                                                                                   │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         int256 assetAmountRemaining                                                                                                                                                                                                          │
│     ) internal view returns (WithdrawFactors memory, int256) {                                                                                                                                                                               │
│         require(portfolioState.newAssets.length == 0); // dev: new assets in portfolio                                                                                                                                                       │
│         factors.markets = new MarketParameters[](factors.cashGroup.maxMarketIndex);                                                                                                                                                          │
│         // Do this to deal with stack issues                                                                                                                                                                                                 │
│         WithdrawFactors memory w;                                                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│         for (uint256 i; i < portfolioState.storedAssets.length; i++) {                                                                                                                                                                       │
│             PortfolioAsset memory asset = portfolioState.storedAssets;                                                                                                                                                                       │
│             if (asset.storageState == AssetStorageState.Delete) continue;                                                                                                                                                                    │
│             if (                                                                                                                                                                                                                             │
│                 !AssetHandler.isLiquidityToken(asset.assetType) ||                                                                                                                                                                           │
│                 asset.currencyId != factors.cashGroup.currencyId                                                                                                                                                                             │
│             ) continue;                                                                                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│             uint256 marketIndex = asset.assetType - 1;                                                                                                                                                                                       │
│             // This is set up this way so that we can delay setting storage of markets so that this method can                                                                                                                               │
│             // remain a view function                                                                                                                                                                                                        │
│             factors.cashGroup.loadMarket(                                                                                                                                                                                                    │
│                 factors.markets,                                                                                                                                                                                                             │
│                 marketIndex,                                                                                                                                                                                                                 │
│                 true,                                                                                                                                                                                                                        │
│                 blockTime                                                                                                                                                                                                                    │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             // NOTE: we do not give any credit to the haircut fCash in this procedure but it will end up adding                                                                                                                              │
│             // additional collateral value back into the account. It's probably too complex to deal with this so                                                                                                                             │
│             // we will just leave it as such.                                                                                                                                                                                                │
│             (w.assetCash, w.fCash) = asset.getCashClaims(factors.markets);                                                                                                                                                                   │
│             _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│             // (netCashToAccount <= assetAmountRemaining)                                                                                                                                                                                    │
│             if (w.netCashIncrease.subNoNeg(w.incentivePaid) <= assetAmountRemaining) {                                                                                                                                                       │
│                 // The additional cash is insufficient to cover asset amount required so we just remove all of it.                                                                                                                           │
│                 portfolioState.deleteAsset(i);                                                                                                                                                                                               │
│                 factors.markets.removeLiquidity(asset.notional);                                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│                 // assetAmountRemaining = assetAmountRemaining - netCashToAccount                                                                                                                                                            │
│                 // netCashToAccount = netCashIncrease - incentivePaid                                                                                                                                                                        │
│                 // overflow checked above                                                                                                                                                                                                    │
│                 assetAmountRemaining =                                                                                                                                                                                                       │
│                     assetAmountRemaining -                                                                                                                                                                                                   │
│                     w.netCashIncrease.sub(w.incentivePaid);                                                                                                                                                                                  │
│             } else {                                                                                                                                                                                                                         │
│                 // Otherwise remove a proportional amount of liquidity tokens to cover the amount remaining.                                                                                                                                 │
│                 int256 tokensToRemove =                                                                                                                                                                                                      │
│                     asset.notional.mul(assetAmountRemaining).div(                                                                                                                                                                            │
│                         w.netCashIncrease.subNoNeg(w.incentivePaid)                                                                                                                                                                          │
│                     );                                                                                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│                 (w.assetCash, w.fCash) = factors.markets.removeLiquidity(                                                                                                                                                                    │
│                     tokensToRemove                                                                                                                                                                                                           │
│                 );                                                                                                                                                                                                                           │
│                 // Recalculate net cash increase and incentive paid. w.assetCash is different because we partially                                                                                                                           │
│                 // remove asset cash                                                                                                                                                                                                         │
│                 _calculateNetCashIncreaseAndIncentivePaid(factors, w, asset.assetType);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│                 // Remove liquidity token balance                                                                                                                                                                                            │
│                 portfolioState.storedAssets.notional = asset.notional.subNoNeg(tokensToRemove);                                                                                                                                              │
│                 portfolioState.storedAssets.storageState = AssetStorageState.Update;                                                                                                                                                         │
│                 assetAmountRemaining = 0;                                                                                                                                                                                                    │
│             }                                                                                                                                                                                                                                │
│                                                                                                                                                                                                                                              │
│             w.totalIncentivePaid = w.totalIncentivePaid.add(w.incentivePaid);                                                                                                                                                                │
│             w.totalCashClaim = w.totalCashClaim.add(w.assetCash);                                                                                                                                                                            │
│                                                                                                                                                                                                                                              │
│             // Add the netfCash asset to the portfolio since we've withdrawn the liquidity tokens                                                                                                                                            │
│             portfolioState.addAsset(                                                                                                                                                                                                         │
│                 factors.cashGroup.currencyId,                                                                                                                                                                                                │
│                 asset.maturity,                                                                                                                                                                                                              │
│                 Constants.FCASH_ASSET_TYPE,                                                                                                                                                                                                  │
│                 w.fCash                                                                                                                                                                                                                      │
│             );                                                                                                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│             if (assetAmountRemaining == 0) break;                                                                                                                                                                                            │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return (w, assetAmountRemaining);                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
│     function removeLiquidity(MarketParameters memory marketState, int256 tokensToRemove)                                                                                                                                                     │
│         public                                                                                                                                                                                                                               │
│         pure                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             MarketParameters memory,                                                                                                                                                                                                         │
│             int256,                                                                                                                                                                                                                          │
│             int256                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (int256 assetCash, int256 fCash) = marketState.removeLiquidity(tokensToRemove);                                                                                                                                                      │
│                                                                                                                                                                                                                                              │
│         assert(assetCash >= 0);                                                                                                                                                                                                              │
│         assert(fCash >= 0);                                                                                                                                                                                                                  │
│         return (marketState, assetCash, fCash);                                                                                                                                                                                              │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function buildMarket(                                                                                                                                                                                                                    │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         bool needsLiquidity,                                                                                                                                                                                                                 │
│         uint256 rateOracleTimeWindow                                                                                                                                                                                                         │
│     ) public view returns (MarketParameters memory) {                                                                                                                                                                                        │
│         MarketParameters memory market;                                                                                                                                                                                                      │
│         market.loadMarket(currencyId, maturity, blockTime, needsLiquidity, rateOracleTimeWindow);                                                                                                                                            │
│         return market;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ Code:                                                                                                                                                                                                                                        │
│     function getfCashAmountGivenCashAmount(                                                                                                                                                                                                  │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 netCashToAccount,                                                                                                                                                                                                             │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 maxfCashDelta                                                                                                                                                                                                                │
│     ) external pure returns (int256) {                                                                                                                                                                                                       │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             Market.getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                   │
│         // Rate scalar can never be zero so this signifies a failure and we return zero                                                                                                                                                      │
│         if (rateScalar == 0) revert();                                                                                                                                                                                                       │
│         int256 fee = Market.getExchangeRateFromImpliedRate(cashGroup.getTotalFee(), timeToMaturity);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             Market.getfCashGivenCashAmount(                                                                                                                                                                                                  │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fee,                                                                                                                                                                                                                         │
│                 maxfCashDelta                                                                                                                                                                                                                │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "Yes"}                                                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate, and have inside code statements that calculate/assign/distribute the balance/share/stake/fee/loan/reward                                                   │
│ Code:                                                                                                                                                                                                                                        │
│     function getfCashAmountGivenCashAmount(                                                                                                                                                                                                  │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 netCashToAccount,                                                                                                                                                                                                             │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 maxfCashDelta                                                                                                                                                                                                                │
│     ) external pure returns (int256) {                                                                                                                                                                                                       │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             Market.getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                   │
│         // Rate scalar can never be zero so this signifies a failure and we return zero                                                                                                                                                      │
│         if (rateScalar == 0) revert();                                                                                                                                                                                                       │
│         int256 fee = Market.getExchangeRateFromImpliedRate(cashGroup.getTotalFee(), timeToMaturity);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             Market.getfCashGivenCashAmount(                                                                                                                                                                                                  │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fee,                                                                                                                                                                                                                         │
│                 maxfCashDelta                                                                                                                                                                                                                │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function convertToUnderlying(AssetRateParameters memory er, int256 balance)                                                                                                                                                              │
│         external                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                        │
│         require(er.rate > 0);                                                                                                                                                                                                                │
│         int256 result = er.convertToUnderlying(balance);                                                                                                                                                                                     │
│         assertBalanceSign(balance, result);                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function convertFromUnderlying(AssetRateParameters memory er, int256 balance)                                                                                                                                                            │
│         external                                                                                                                                                                                                                             │
│         pure                                                                                                                                                                                                                                 │
│         returns (int256)                                                                                                                                                                                                                     │
│     {                                                                                                                                                                                                                                        │
│         require(er.rate > 0);                                                                                                                                                                                                                │
│         int256 result = er.convertFromUnderlying(balance);                                                                                                                                                                                   │
│         assertBalanceSign(balance, result);                                                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return result;                                                                                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function buildAssetRate(uint256 currencyId) external returns (AssetRateParameters memory) {                                                                                                                                              │
│         AssetRateParameters memory assetRateStateful = AssetRate.buildAssetRateStateful(currencyId);                                                                                                                                         │
│         AssetRateParameters memory assetRateView = AssetRate.buildAssetRateView(currencyId);                                                                                                                                                 │
│                                                                                                                                                                                                                                              │
│         assert(assetRateStateful.rate == assetRateView.rate);                                                                                                                                                                                │
│         assert(assetRateStateful.underlyingDecimals == assetRateView.underlyingDecimals);                                                                                                                                                    │
│         assert(assetRateStateful.rateOracle == assetRateView.rateOracle);                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return assetRateStateful;                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function buildSettlementRate(                                                                                                                                                                                                            │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) external returns (AssetRateParameters memory) {                                                                                                                                                                                        │
│         AssetRateParameters memory initialViewRate =                                                                                                                                                                                         │
│             AssetRate.buildSettlementRateView(currencyId, maturity);                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         AssetRateParameters memory statefulRate =                                                                                                                                                                                            │
│             AssetRate.buildSettlementRateStateful(currencyId, maturity, blockTime);                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         assert(initialViewRate.rate == statefulRate.rate);                                                                                                                                                                                   │
│         assert(initialViewRate.underlyingDecimals == statefulRate.underlyingDecimals);                                                                                                                                                       │
│                                                                                                                                                                                                                                              │
│         return statefulRate;                                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 notional,                                                                                                                                                                                                                     │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) public view returns (int256) {                                                                                                                                                                                                         │
│         uint256 oracleRate = CashGroup.calculateOracleRate(cashGroup, maturity, blockTime);                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return AssetHandler.getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getRiskAdjustedPresentValue(                                                                                                                                                                                                    │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 notional,                                                                                                                                                                                                                     │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) public view returns (int256) {                                                                                                                                                                                                         │
│         uint256 oracleRate = CashGroup.calculateOracleRate(cashGroup, maturity, blockTime);                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             AssetHandler.getRiskAdjustedPresentValue(                                                                                                                                                                                        │
│                 cashGroup,                                                                                                                                                                                                                   │
│                 notional,                                                                                                                                                                                                                    │
│                 maturity,                                                                                                                                                                                                                    │
│                 blockTime,                                                                                                                                                                                                                   │
│                 oracleRate                                                                                                                                                                                                                   │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function getNTokenContext(address tokenAddress)                                                                                                                                                                                          │
│         external                                                                                                                                                                                                                             │
│         view                                                                                                                                                                                                                                 │
│         returns (                                                                                                                                                                                                                            │
│             uint256,                                                                                                                                                                                                                         │
│             uint256,                                                                                                                                                                                                                         │
│             uint256,                                                                                                                                                                                                                         │
│             bytes6                                                                                                                                                                                                                           │
│         )                                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         (                                                                                                                                                                                                                                    │
│             uint256 currencyId,                                                                                                                                                                                                              │
│             uint256 incentiveRate,                                                                                                                                                                                                           │
│             uint256 lastInitializedTime,                                                                                                                                                                                                     │
│             bytes6 parameters                                                                                                                                                                                                                │
│         ) = nTokenHandler.getNTokenContext(tokenAddress);                                                                                                                                                                                    │
│         assert(nTokenHandler.nTokenAddress(currencyId) == tokenAddress);                                                                                                                                                                     │
│                                                                                                                                                                                                                                              │
│         return (currencyId, incentiveRate, lastInitializedTime, parameters);                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function nTokenAddress(uint256 currencyId) external view returns (address) {                                                                                                                                                             │
│         address tokenAddress = nTokenHandler.nTokenAddress(currencyId);                                                                                                                                                                      │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             uint256 currencyIdStored,                                                                                                                                                                                                        │
│             /* incentiveRate */,                                                                                                                                                                                                             │
│             /* lastInitializedTime */,                                                                                                                                                                                                       │
│             /* parameters */                                                                                                                                                                                                                 │
│         ) = nTokenHandler.getNTokenContext(tokenAddress);                                                                                                                                                                                    │
│         assert(currencyIdStored == currencyId);                                                                                                                                                                                              │
│                                                                                                                                                                                                                                              │
│         return tokenAddress;                                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                                       │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function setNTokenParameters(                                                                                                                                                                                                            │
│         uint16 currencyId,                                                                                                                                                                                                                   │
│         address tokenAddress,                                                                                                                                                                                                                │
│         int256 totalSupply,                                                                                                                                                                                                                  │
│         uint32 emissionRate,                                                                                                                                                                                                                 │
│         uint32 blockTime                                                                                                                                                                                                                     │
│     ) external returns (uint256) {                                                                                                                                                                                                           │
│         nTokenHandler.setNTokenAddress(currencyId, tokenAddress);                                                                                                                                                                            │
│         nTokenHandler.setIncentiveEmissionRate(tokenAddress, emissionRate);                                                                                                                                                                  │
│         return nTokenHandler.changeNTokenSupply(tokenAddress, totalSupply, blockTime);                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "Yes", "3": "Yes"}                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate, and have inside code statements that calculate/assign/distribute the balance/share/stake/fee/loan/reward                                                   │
│ Code:                                                                                                                                                                                                                                        │
│     function setNTokenParameters(                                                                                                                                                                                                            │
│         uint16 currencyId,                                                                                                                                                                                                                   │
│         address tokenAddress,                                                                                                                                                                                                                │
│         int256 totalSupply,                                                                                                                                                                                                                  │
│         uint32 emissionRate,                                                                                                                                                                                                                 │
│         uint32 blockTime                                                                                                                                                                                                                     │
│     ) external returns (uint256) {                                                                                                                                                                                                           │
│         nTokenHandler.setNTokenAddress(currencyId, tokenAddress);                                                                                                                                                                            │
│         nTokenHandler.setIncentiveEmissionRate(tokenAddress, emissionRate);                                                                                                                                                                  │
│         return nTokenHandler.changeNTokenSupply(tokenAddress, totalSupply, blockTime);                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ───────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function setNTokenParameters(                                                                                                                                                                                                            │
│         uint16 currencyId,                                                                                                                                                                                                                   │
│         address tokenAddress,                                                                                                                                                                                                                │
│         int256 totalSupply,                                                                                                                                                                                                                  │
│         uint32 emissionRate,                                                                                                                                                                                                                 │
│         uint32 blockTime                                                                                                                                                                                                                     │
│     ) external returns (uint256) {                                                                                                                                                                                                           │
│         nTokenHandler.setNTokenAddress(currencyId, tokenAddress);                                                                                                                                                                            │
│         nTokenHandler.setIncentiveEmissionRate(tokenAddress, emissionRate);                                                                                                                                                                  │
│         return nTokenHandler.changeNTokenSupply(tokenAddress, totalSupply, blockTime);                                                                                                                                                       │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function calculateIncentivesToClaim(                                                                                                                                                                                                     │
│         address tokenAddress,                                                                                                                                                                                                                │
│         uint256 nTokenBalance,                                                                                                                                                                                                               │
│         uint256 lastClaimTime,                                                                                                                                                                                                               │
│         uint256 lastClaimIntegralSupply,                                                                                                                                                                                                     │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) external view returns (uint256) {                                                                                                                                                                                                      │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             /* */,                                                                                                                                                                                                                           │
│             uint256 integralTotalSupply,                                                                                                                                                                                                     │
│             /* */                                                                                                                                                                                                                            │
│         ) = nTokenHandler.calculateIntegralTotalSupply(tokenAddress, blockTime);                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             Incentives.calculateIncentivesToClaim(                                                                                                                                                                                           │
│                 tokenAddress,                                                                                                                                                                                                                │
│                 nTokenBalance,                                                                                                                                                                                                               │
│                 lastClaimTime,                                                                                                                                                                                                               │
│                 lastClaimIntegralSupply,                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 integralTotalSupply                                                                                                                                                                                                          │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                                                 │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                                             │
│ Code:                                                                                                                                                                                                                                        │
│     function claimIncentives(BalanceState memory balanceState, address account)                                                                                                                                                              │
│         internal                                                                                                                                                                                                                             │
│         returns (uint256)                                                                                                                                                                                                                    │
│     {                                                                                                                                                                                                                                        │
│         uint256 blockTime = block.timestamp;                                                                                                                                                                                                 │
│         address tokenAddress = nTokenHandler.nTokenAddress(balanceState.currencyId);                                                                                                                                                         │
│         uint256 integralTotalSupply = nTokenHandler.changeNTokenSupply(                                                                                                                                                                      │
│             tokenAddress,                                                                                                                                                                                                                    │
│             balanceState.netNTokenSupplyChange,                                                                                                                                                                                              │
│             blockTime                                                                                                                                                                                                                        │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         uint256 incentivesToClaim = calculateIncentivesToClaim(                                                                                                                                                                              │
│             tokenAddress,                                                                                                                                                                                                                    │
│             uint256(balanceState.storedNTokenBalance),                                                                                                                                                                                       │
│             balanceState.lastClaimTime,                                                                                                                                                                                                      │
│             balanceState.lastClaimIntegralSupply,                                                                                                                                                                                            │
│             blockTime,                                                                                                                                                                                                                       │
│             integralTotalSupply                                                                                                                                                                                                              │
│         );                                                                                                                                                                                                                                   │
│                                                                                                                                                                                                                                              │
│         balanceState.lastClaimTime = blockTime;                                                                                                                                                                                              │
│         balanceState.lastClaimIntegralSupply = integralTotalSupply;                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         if (incentivesToClaim > 0) TokenHandler.transferIncentive(account, incentivesToClaim);                                                                                                                                               │
│                                                                                                                                                                                                                                              │
│         return incentivesToClaim;                                                                                                                                                                                                            │
│     }                                                                                                                                                                                                                                        │
│     function calculateIncentivesToClaim(                                                                                                                                                                                                     │
│         address tokenAddress,                                                                                                                                                                                                                │
│         uint256 nTokenBalance,                                                                                                                                                                                                               │
│         uint256 lastClaimTime,                                                                                                                                                                                                               │
│         uint256 lastClaimIntegralSupply,                                                                                                                                                                                                     │
│         uint256 blockTime                                                                                                                                                                                                                    │
│     ) external view returns (uint256) {                                                                                                                                                                                                      │
│         // prettier-ignore                                                                                                                                                                                                                   │
│         (                                                                                                                                                                                                                                    │
│             /* */,                                                                                                                                                                                                                           │
│             uint256 integralTotalSupply,                                                                                                                                                                                                     │
│             /* */                                                                                                                                                                                                                            │
│         ) = nTokenHandler.calculateIntegralTotalSupply(tokenAddress, blockTime);                                                                                                                                                             │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             Incentives.calculateIncentivesToClaim(                                                                                                                                                                                           │
│                 tokenAddress,                                                                                                                                                                                                                │
│                 nTokenBalance,                                                                                                                                                                                                               │
│                 lastClaimTime,                                                                                                                                                                                                               │
│                 lastClaimIntegralSupply,                                                                                                                                                                                                     │
│                 blockTime,                                                                                                                                                                                                                   │
│                 integralTotalSupply                                                                                                                                                                                                          │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ──────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                                                            │
│ Code:                                                                                                                                                                                                                                        │
│     function setSettlementRate(                                                                                                                                                                                                              │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint128 rate,                                                                                                                                                                                                                        │
│         uint8 underlyingDecimalPlaces                                                                                                                                                                                                        │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 blockTime = block.timestamp;                                                                                                                                                                                                 │
│         bytes32 slot =                                                                                                                                                                                                                       │
│             keccak256(                                                                                                                                                                                                                       │
│                 abi.encode(                                                                                                                                                                                                                  │
│                     currencyId,                                                                                                                                                                                                              │
│                     keccak256(abi.encode(maturity, Constants.SETTLEMENT_RATE_STORAGE_OFFSET))                                                                                                                                                │
│                 )                                                                                                                                                                                                                            │
│             );                                                                                                                                                                                                                               │
│         bytes32 data =                                                                                                                                                                                                                       │
│             (bytes32(blockTime) |                                                                                                                                                                                                            │
│                 (bytes32(uint256(rate)) << 40) |                                                                                                                                                                                             │
│                 (bytes32(uint256(underlyingDecimalPlaces)) << 168));                                                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         assembly {                                                                                                                                                                                                                           │
│             sstore(slot, data)                                                                                                                                                                                                               │
│         }                                                                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"nToken.cashGroup":"This variable holds the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation. It is used to calculate the cash value of the portfolio and the      │
│ present value of the assets."}, "VariableB":{"totalAssetPV":"This variable holds the calculated value/price of LP token. It is the total present value denominated in asset terms."}}                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:16] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/nTokenHandler.sol, current function: getNTokenAssetPV, current vul:           tasks.py:260
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{}, "VariableB":{}}                                                                                                                                                                                                             │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:17] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/CashGroup.sol, current function: loadMarket, current vul:             tasks.py:260
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"factors.markets":"This array holds the market reserves/AMMprice/exchangeRate. It is populated by the loadMarket function and used in the getCashClaims and removeLiquidity functions.", "asset.notional":"This variable       │
│ represents the balanceOf/totalSupply/amount/liquidity of the custom token."}, "VariableB":{"tokensToRemove":"This variable holds the calculated value/price of LP token. It is calculated as a proportional amount of liquidity tokens to    │
│ cover the amount remaining."}}                                                                                                                                                                                                               │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:20] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/CashGroup.sol, current function: loadMarket, current vul:             tasks.py:359
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"factors.markets":"This array holds the market reserves/AMMprice/exchangeRate. It is populated by the loadMarket function which likely fetches the current state of the market, including reserves and pricing information."}, │
│ "VariableB":{"w.assetCash":"This variable holds the calculated value/price of LP token. It is updated after removing liquidity or getting cash claims."}}                                                                                    │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:23] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/CashGroup.sol, current function: loadMarket, current vul:             tasks.py:359
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"rateOracle":"This variable holds the address of the rate oracle which can be used to get the exchange rate or market reserves."}, "VariableB":{"rate":"This variable holds the calculated exchange rate value."}}             │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:24] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/AssetRate.sol, current function: _getAssetRateView, current vul:      tasks.py:260
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"settlementRate":"This variable holds the market reserves/AMMprice/exchangeRate or the custom token balanceOf/totalSupply/amount/liquidity calculation."}, "VariableB":{"AssetRateParameters":"This variable holds the         │
│ calculated value/price of LP token."}}                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:27] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/AssetRate.sol, current function: _getAssetRateView, current vul:      tasks.py:359
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"rateOracle":"This variable holds the address of the rate oracle which can be used to fetch the market reserves/AMMprice/exchangeRate or the custom token balanceOf/totalSupply/amount/liquidity calculation."},               │
│ "VariableB":{"rate":"This variable holds the calculated value/price of LP token."}}                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:30] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/AssetRate.sol, current function: _getAssetRateStateful, current vul:  tasks.py:260
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{}, "VariableB":{}}                                                                                                                                                                                                             │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:31] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/AssetRate.sol, current function: _getAssetRateStateful, current vul:  tasks.py:359
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"settlementRate":"This variable holds the market reserves/AMMprice/exchangeRate or the custom token balanceOf/totalSupply/amount/liquidity calculation."}, "VariableB":{"storedRate":"This variable holds the calculated       │
│ value/price of LP token."}}                                                                                                                                                                                                                  │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:33] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/markets/AssetRate.sol, current function: _getAssetRateStateful, current vul:  tasks.py:359
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"market.totalAssetCash, market.totalfCash, market.totalLiquidity":"These variables hold the market reserves/AMMprice/exchangeRate or the custom token balanceOf/totalSupply/amount/liquidity calculation."},                   │
│ "VariableB":{"assetCash, fCash":"These variables hold the calculated value/price of LP token."}}                                                                                                                                             │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:35] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/valuation/AssetHandler.sol, current function: getHaircutCashClaims, current   tasks.py:260
                             vul: price-manipulation                                                                                                                                                                                            
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"liquidityToken":"This variable holds the liquidity token from the assets array. It is used to calculate the cash claims and present value of the liquidity token."}, "VariableB":{"pv":"This variable holds the present value │
│ of the liquidity token. It is calculated using the fCashClaim, maturity, blockTime, and oracleRate."}}                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:38] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/valuation/AssetHandler.sol, current function: getHaircutCashClaims, current   tasks.py:359
                             vul: price-manipulation                                                                                                                                                                                            
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"cashGroup":"Holds the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation"}, "VariableB":{"presentValueAsset":"Holds the calculated value/price of LP token"}}       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:40] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/valuation/AssetHandler.sol, current function: getNetCashGroupValue, current   tasks.py:260
                             vul: price-manipulation                                                                                                                                                                                            
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"nTokenAssetPV":"This variable holds the present value of the nToken's assets. It is calculated by the getNTokenAssetPV function.","tokenBalance":"This variable represents the balance of the                                 │
│ token.","nToken.totalSupply":"This variable represents the total supply of the nToken."}, "VariableB":{"nTokenHaircutAssetPV":"This variable holds the calculated value of LP token after applying the haircut percentage."}}                │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:43] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/valuation/FreeCollateral.sol, current function: _getNTokenHaircutAssetPV,     tasks.py:260
                             current vul: price-manipulation                                                                                                                                                                                    
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"factors.portfolio":"This variable holds the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation."}, "VariableB":{"netPortfolioValue":"This variable holds the        │
│ calculated value/price of LP token."}}                                                                                                                                                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:45] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/valuation/FreeCollateral.sol, current function: _getNTokenHaircutAssetPV,     tasks.py:359
                             current vul: price-manipulation                                                                                                                                                                                    
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"cashBalance":"This variable holds the balance of the account in the specified currency."}, "VariableB":{"nTokenHaircutAssetValue":"This variable holds the calculated value of LP token."}}                                   │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:46] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/valuation/FreeCollateral.sol, current function: _getNTokenHaircutAssetPV,     tasks.py:359
                             current vul: price-manipulation                                                                                                                                                                                    
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── Current Step ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to update/accrue interest/exchange rate? Answer only ZERO or ONE statement, cover the code with backquotes.                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         address account,                                                                                                                                                                                                                     │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         int256 notional = getifCashNotional(account, currencyId, maturity);                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         // In this case the asset has matured and the total value is just the notional amount                                                                                                                                                │
│         if (maturity <= blockTime) return notional;                                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                             │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             return                                                                                                                                                                                                                           │
│                 AssetHandler.getRiskAdjustedPresentValue(                                                                                                                                                                                    │
│                     cashGroup,                                                                                                                                                                                                               │
│                     notional,                                                                                                                                                                                                                │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetHandler.getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ The first statement to update/accrue interest/exchange rate in the given code is `uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);`.                                                                                 │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── Current Step ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to calculate/assign/distribute the balance/share/stake/fee/loan/reward? Answer only ZERO or ONE statement, cover the code with backquotes.                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getPresentValue(                                                                                                                                                                                                                │
│         address account,                                                                                                                                                                                                                     │
│         uint256 currencyId,                                                                                                                                                                                                                  │
│         uint256 maturity,                                                                                                                                                                                                                    │
│         uint256 blockTime,                                                                                                                                                                                                                   │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         bool riskAdjusted                                                                                                                                                                                                                    │
│     ) internal view returns (int256) {                                                                                                                                                                                                       │
│         int256 notional = getifCashNotional(account, currencyId, maturity);                                                                                                                                                                  │
│                                                                                                                                                                                                                                              │
│         // In this case the asset has matured and the total value is just the notional amount                                                                                                                                                │
│         if (maturity <= blockTime) return notional;                                                                                                                                                                                          │
│                                                                                                                                                                                                                                              │
│         uint256 oracleRate = cashGroup.calculateOracleRate(maturity, blockTime);                                                                                                                                                             │
│         if (riskAdjusted) {                                                                                                                                                                                                                  │
│             return                                                                                                                                                                                                                           │
│                 AssetHandler.getRiskAdjustedPresentValue(                                                                                                                                                                                    │
│                     cashGroup,                                                                                                                                                                                                               │
│                     notional,                                                                                                                                                                                                                │
│                     maturity,                                                                                                                                                                                                                │
│                     blockTime,                                                                                                                                                                                                               │
│                     oracleRate                                                                                                                                                                                                               │
│                 );                                                                                                                                                                                                                           │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         return AssetHandler.getPresentValue(notional, maturity, blockTime, oracleRate);                                                                                                                                                      │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ The first statement to calculate/assign/distribute the balance/share/stake/fee/loan/reward in the given code is `int256 notional = getifCashNotional(account, currencyId, maturity);`.                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:50] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/internal/portfolio/BitmapAssetsHandler.sol, current function: getPresentValue, current tasks.py:260
                             vul: wrong-order-interest                                                                                                                                                                                          
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── Current Step ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to update/accrue interest/exchange rate? Answer only ZERO or ONE statement, cover the code with backquotes.                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function exchange(                                                                                                                                                                                                                       │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountIn                                                                                                                                                                                                                     │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountOut = (amountIn * exchangeRate) / 1e18;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ `uint256 amountOut = (amountIn * exchangeRate) / 1e18;`                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── Current Step ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to calculate/assign/distribute the balance/share/stake/fee/loan/reward? Answer only ZERO or ONE statement, cover the code with backquotes.                  │
│ Code:                                                                                                                                                                                                                                        │
│     function exchange(                                                                                                                                                                                                                       │
│         address assetIn,                                                                                                                                                                                                                     │
│         address assetOut,                                                                                                                                                                                                                    │
│         uint256 amountIn                                                                                                                                                                                                                     │
│     ) external {                                                                                                                                                                                                                             │
│         uint256 amountOut = (amountIn * exchangeRate) / 1e18;                                                                                                                                                                                │
│         if (IERC20(assetIn).balanceOf(msg.sender) < amountIn) {                                                                                                                                                                              │
│             revert("Insufficient balance of assetIn");                                                                                                                                                                                       │
│         }                                                                                                                                                                                                                                    │
│                                                                                                                                                                                                                                              │
│         IERC20(assetIn).transferFrom(msg.sender, address(this), amountIn);                                                                                                                                                                   │
│         IERC20(assetOut).transfer(msg.sender, amountOut);                                                                                                                                                                                    │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ `uint256 amountOut = (amountIn * exchangeRate) / 1e18;`                                                                                                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:52] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/mocks/MockExchange.sol, current function: exchange, current vul: wrong-order-interest  tasks.py:260
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"AssetHandler.getLiquidityTokenValue":"This function calculates the value of liquidity tokens, which likely involves market reserves, AMM price, exchange rate, token balance, total supply, amount, or liquidity              │
│ calculation."}, "VariableB":{"assetValue":"This variable holds the calculated value of the liquidity token."}}                                                                                                                               │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:53] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/mocks/MockAssetHandler.sol, current function: getLiquidityTokenValueRiskAdjusted,      tasks.py:260
                             current vul: price-manipulation                                                                                                                                                                                    
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"cashGroup":"Holds the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation"}, "VariableB":{"assetValue":"Holds the calculated value/price of LP token"}}              │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:55] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/mocks/MockAssetHandler.sol, current function: getLiquidityTokenValue, current vul:     tasks.py:260
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"cashGroup":"Holds the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation"}, "VariableB":{"presentValueAsset":"Holds the calculated value/price of LP token"}}       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:38:57] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/mocks/MockAssetHandler.sol, current function: getLiquidityTokenValue, current vul:     tasks.py:359
                             price-manipulation                                                                                                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                                                    
                                 falcon_instance, function2_text)                                                                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── Current Step ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to update/accrue interest/exchange rate? Answer only ZERO or ONE statement, cover the code with backquotes.                                                 │
│ Code:                                                                                                                                                                                                                                        │
│     function getfCashAmountGivenCashAmount(                                                                                                                                                                                                  │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 netCashToAccount,                                                                                                                                                                                                             │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 maxfCashDelta                                                                                                                                                                                                                │
│     ) external pure returns (int256) {                                                                                                                                                                                                       │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             Market.getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                   │
│         // Rate scalar can never be zero so this signifies a failure and we return zero                                                                                                                                                      │
│         if (rateScalar == 0) revert();                                                                                                                                                                                                       │
│         int256 fee = Market.getExchangeRateFromImpliedRate(cashGroup.getTotalFee(), timeToMaturity);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             Market.getfCashGivenCashAmount(                                                                                                                                                                                                  │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fee,                                                                                                                                                                                                                         │
│                 maxfCashDelta                                                                                                                                                                                                                │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ The first statement to update/accrue interest/exchange rate in the given code is:                                                                                                                                                            │
│ ```                                                                                                                                                                                                                                          │
│ (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                         │
│             Market.getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                   │
│ ```                                                                                                                                                                                                                                          │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────── Current Step ────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to calculate/assign/distribute the balance/share/stake/fee/loan/reward? Answer only ZERO or ONE statement, cover the code with backquotes.                  │
│ Code:                                                                                                                                                                                                                                        │
│     function getfCashAmountGivenCashAmount(                                                                                                                                                                                                  │
│         MarketParameters memory market,                                                                                                                                                                                                      │
│         CashGroupParameters memory cashGroup,                                                                                                                                                                                                │
│         int256 netCashToAccount,                                                                                                                                                                                                             │
│         uint256 marketIndex,                                                                                                                                                                                                                 │
│         uint256 timeToMaturity,                                                                                                                                                                                                              │
│         uint256 maxfCashDelta                                                                                                                                                                                                                │
│     ) external pure returns (int256) {                                                                                                                                                                                                       │
│         (int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) =                                                                                                                                                                 │
│             Market.getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);                                                                                                                                                   │
│         // Rate scalar can never be zero so this signifies a failure and we return zero                                                                                                                                                      │
│         if (rateScalar == 0) revert();                                                                                                                                                                                                       │
│         int256 fee = Market.getExchangeRateFromImpliedRate(cashGroup.getTotalFee(), timeToMaturity);                                                                                                                                         │
│                                                                                                                                                                                                                                              │
│         return                                                                                                                                                                                                                               │
│             Market.getfCashGivenCashAmount(                                                                                                                                                                                                  │
│                 market.totalfCash,                                                                                                                                                                                                           │
│                 netCashToAccount,                                                                                                                                                                                                            │
│                 totalCashUnderlying,                                                                                                                                                                                                         │
│                 rateScalar,                                                                                                                                                                                                                  │
│                 rateAnchor,                                                                                                                                                                                                                  │
│                 fee,                                                                                                                                                                                                                         │
│                 maxfCashDelta                                                                                                                                                                                                                │
│             );                                                                                                                                                                                                                               │
│     }                                                                                                                                                                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Response ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ `(int256 rateScalar, int256 totalCashUnderlying, int256 rateAnchor) = Market.getExchangeRateFactors(market, cashGroup, timeToMaturity, marketIndex);`                                                                                        │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 16:39:01] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                                                            tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/eval_data/2021-08-notional-main/contracts/mocks/MockMarket.sol, current function: getfCashAmountGivenCashAmount, current vul:    tasks.py:260
                             wrong-order-interest                                                                                                                                                                                               
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                                              tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                                                    
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                                               
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                                                   
                                                                                                                                                                                                                                                
                      Scan Results                       
┏━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃ Type ┃ Description ┃ Affected Files ┃ Analysis Report ┃
┡━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
└──────┴─────────────┴────────────────┴─────────────────┘
                   Summary                    
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ Key                  ┃ Value               ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│ Files                │ 68                  │
│ Contracts            │ 73                  │
│ Functions            │ 274                 │
│ Lines of Code        │ 11725               │
│ Used Time            │ 190.98226022720337  │
│ Estimated Cost (USD) │ 0.15356650000000002 │
└──────────────────────┴─────────────────────┘
