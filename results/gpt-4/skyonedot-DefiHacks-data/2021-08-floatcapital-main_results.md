

  .oooooo.    ooooooooo.   ooooooooooooo  .oooooo..o                                 
 d8P'  `Y8b   `888   `Y88. 8'   888   `8 d8P'    `Y8                                 
888            888   .d88'      888      Y88bo.       .ooooo.   .oooo.   ooo. .oo.   
888            888ooo88P'       888       `"Y8888o.  d88' `"Y8 `P  )88b  `888P"Y88b  
888     ooooo  888              888           `"Y88b 888        .oP"888   888   888  
`88.    .88'   888              888      oo     .d8P 888   .o8 d8(  888   888   888  
 `Y8bood8P'   o888o            o888o     8""88888P'  `Y8bod8P' `Y888""8o o888o o888o                                                        


                                                                   

[20:16:09] Loaded 10 rules                                                                                                                                                                             tasks.py:119
[12/08/24 20:16:09] INFO     CryticCompile: 'npx hardhat clean' running (wd: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main)         subprocess.py:41
                    ERROR    CryticCompile: 'npx' returned non-zero exit code 1                                                                                                                    subprocess.py:60
                    ERROR    CryticCompile: An unexpected error occurred:                                                                                                                          subprocess.py:68
                             stderr: Error: Cannot find module '@nomicfoundation/hardhat-toolbox'                                                                                                                  
                             stderr: Require stack:                                                                                                                                                                
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js                                              
                             stderr: -                                                                                                                                                                             
                             /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loading                 
                             .js                                                                                                                                                                                   
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js                       
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js                 
                             stderr:     at Function._resolveFilename (node:internal/modules/cjs/loader:1249:15)                                                                                                   
                             stderr:     at Function._load (node:internal/modules/cjs/loader:1075:27)                                                                                                              
                             stderr:     at TracingChannel.traceSync (node:diagnostics_channel:322:14)                                                                                                             
                             stderr:     at wrapModuleLoad (node:internal/modules/cjs/loader:219:24)                                                                                                               
                             stderr:     at Module.require (node:internal/modules/cjs/loader:1340:12)                                                                                                              
                             stderr:     at require (node:internal/modules/helpers:138:16)                                                                                                                         
                             stderr:     at Object.<anonymous>                                                                                                                                                     
                             (/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js:1:1)                                                  
                             stderr:     at Module._compile (node:internal/modules/cjs/loader:1565:14)                                                                                                             
                             stderr:     at Object..js (node:internal/modules/cjs/loader:1708:10)                                                                                                                  
                             stderr:     at Module.load (node:internal/modules/cjs/loader:1318:32) {                                                                                                               
                             stderr:   code: 'MODULE_NOT_FOUND',                                                                                                                                                   
                             stderr:   requireStack: [                                                                                                                                                             
                             stderr:     '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js',                                         
                             stderr:                                                                                                                                                                               
                             '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loadin                 
                             g.js',                                                                                                                                                                                
                             stderr:     '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js',                  
                             stderr:                                                                                                                                                                               
                             '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js'                         
                             stderr:   ]                                                                                                                                                                           
                             stderr: }                                                                                                                                                                             
                    INFO     CryticCompile: 'npx hardhat clean --global' running (wd:                                                                                                              subprocess.py:41
                             /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main)                                                                         
[12/08/24 20:16:10] ERROR    CryticCompile: 'npx' returned non-zero exit code 1                                                                                                                    subprocess.py:60
                    ERROR    CryticCompile: An unexpected error occurred:                                                                                                                          subprocess.py:68
                             stderr: Error: Cannot find module '@nomicfoundation/hardhat-toolbox'                                                                                                                  
                             stderr: Require stack:                                                                                                                                                                
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js                                              
                             stderr: -                                                                                                                                                                             
                             /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loading                 
                             .js                                                                                                                                                                                   
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js                       
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js                 
                             stderr:     at Function._resolveFilename (node:internal/modules/cjs/loader:1249:15)                                                                                                   
                             stderr:     at Function._load (node:internal/modules/cjs/loader:1075:27)                                                                                                              
                             stderr:     at TracingChannel.traceSync (node:diagnostics_channel:322:14)                                                                                                             
                             stderr:     at wrapModuleLoad (node:internal/modules/cjs/loader:219:24)                                                                                                               
                             stderr:     at Module.require (node:internal/modules/cjs/loader:1340:12)                                                                                                              
                             stderr:     at require (node:internal/modules/helpers:138:16)                                                                                                                         
                             stderr:     at Object.<anonymous>                                                                                                                                                     
                             (/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js:1:1)                                                  
                             stderr:     at Module._compile (node:internal/modules/cjs/loader:1565:14)                                                                                                             
                             stderr:     at Object..js (node:internal/modules/cjs/loader:1708:10)                                                                                                                  
                             stderr:     at Module.load (node:internal/modules/cjs/loader:1318:32) {                                                                                                               
                             stderr:   code: 'MODULE_NOT_FOUND',                                                                                                                                                   
                             stderr:   requireStack: [                                                                                                                                                             
                             stderr:     '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js',                                         
                             stderr:                                                                                                                                                                               
                             '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loadin                 
                             g.js',                                                                                                                                                                                
                             stderr:     '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js',                  
                             stderr:                                                                                                                                                                               
                             '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js'                         
                             stderr:   ]                                                                                                                                                                           
                             stderr: }                                                                                                                                                                             
                    INFO     CryticCompile: Problem executing hardhat: An unexpected error occurred:                                                                                                 hardhat.py:327
                             Error: Cannot find module '@nomicfoundation/hardhat-toolbox'                                                                                                                          
                             Require stack:                                                                                                                                                                        
                             - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js                                                      
                             -                                                                                                                                                                                     
                             /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loading.j               
                             s                                                                                                                                                                                     
                             - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js                               
                             - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js                         
                                 at Function._resolveFilename (node:internal/modules/cjs/loader:1249:15)                                                                                                           
                                 at Function._load (node:internal/modules/cjs/loader:1075:27)                                                                                                                      
                                 at TracingChannel.traceSync (node:diagnostics_channel:322:14)                                                                                                                     
                                 at wrapModuleLoad (node:internal/modules/cjs/loader:219:24)                                                                                                                       
                                 at Module.require (node:internal/modules/cjs/loader:1340:12)                                                                                                                      
                                 at require (node:internal/modules/helpers:138:16)                                                                                                                                 
                                 at Object.<anonymous> (/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js:1:1)                        
                                 at Module._compile (node:internal/modules/cjs/loader:1565:14)                                                                                                                     
                                 at Object..js (node:internal/modules/cjs/loader:1708:10)                                                                                                                          
                                 at Module.load (node:internal/modules/cjs/loader:1318:32) {                                                                                                                       
                               code: 'MODULE_NOT_FOUND',                                                                                                                                                           
                               requireStack: [                                                                                                                                                                     
                                 '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js',                                                 
                                 '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-load               
                             ing.js',                                                                                                                                                                              
                                 '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js',                          
                                 '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js'                     
                               ]                                                                                                                                                                                   
                             }                                                                                                                                                                                     
                                                                                                                                                                                                                   
                    INFO     CryticCompile: 'npx hardhat compile --force' running (wd:                                                                                                             subprocess.py:41
                             /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main)                                                                         
[12/08/24 20:16:11] ERROR    CryticCompile: 'npx' returned non-zero exit code 1                                                                                                                    subprocess.py:60
                    ERROR    CryticCompile: An unexpected error occurred:                                                                                                                          subprocess.py:68
                             stderr: Error: Cannot find module '@nomicfoundation/hardhat-toolbox'                                                                                                                  
                             stderr: Require stack:                                                                                                                                                                
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js                                              
                             stderr: -                                                                                                                                                                             
                             /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loading                 
                             .js                                                                                                                                                                                   
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js                       
                             stderr: - /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js                 
                             stderr:     at Function._resolveFilename (node:internal/modules/cjs/loader:1249:15)                                                                                                   
                             stderr:     at Function._load (node:internal/modules/cjs/loader:1075:27)                                                                                                              
                             stderr:     at TracingChannel.traceSync (node:diagnostics_channel:322:14)                                                                                                             
                             stderr:     at wrapModuleLoad (node:internal/modules/cjs/loader:219:24)                                                                                                               
                             stderr:     at Module.require (node:internal/modules/cjs/loader:1340:12)                                                                                                              
                             stderr:     at require (node:internal/modules/helpers:138:16)                                                                                                                         
                             stderr:     at Object.<anonymous>                                                                                                                                                     
                             (/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js:1:1)                                                  
                             stderr:     at Module._compile (node:internal/modules/cjs/loader:1565:14)                                                                                                             
                             stderr:     at Object..js (node:internal/modules/cjs/loader:1708:10)                                                                                                                  
                             stderr:     at Module.load (node:internal/modules/cjs/loader:1318:32) {                                                                                                               
                             stderr:   code: 'MODULE_NOT_FOUND',                                                                                                                                                   
                             stderr:   requireStack: [                                                                                                                                                             
                             stderr:     '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/hardhat.config.js',                                         
                             stderr:                                                                                                                                                                               
                             '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/core/config/config-loadin                 
                             g.js',                                                                                                                                                                                
                             stderr:     '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/cli.js',                  
                             stderr:                                                                                                                                                                               
                             '/home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/node_modules/hardhat/internal/cli/bootstrap.js'                         
                             stderr:   ]                                                                                                                                                                           
                             stderr: }                                                                                                                                                                             
[20:16:11] Traceback (most recent call last):                                                                                                                                                          tasks.py:126
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/falcon/falcon.py", line 90, in __init__                                                                     
               crytic_compile = CryticCompile(target, **kwargs)                                                                                                                                                    
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/crytic_compile.py", line 131, in __init__                                                    
               self._compile(**kwargs)                                                                                                                                                                             
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/crytic_compile.py", line 553, in _compile                                                    
               self._platform.compile(self, **kwargs)                                                                                                                                                              
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/platform/hardhat.py", line 183, in compile                                                   
               hardhat_like_parsing(crytic_compile, self._target, build_directory, hardhat_working_dir)                                                                                                            
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/crytic_compile/platform/hardhat.py", line 52, in hardhat_like_parsing                                       
               raise InvalidCompilation(txt)                                                                                                                                                                       
           crytic_compile.platform.exceptions.InvalidCompilation: Compilation failed. Can you run build command?                                                                                                   
           /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/artifacts/build-info is not a directory.                                                   
                                                                                                                                                                                                                   
           During handling of the above exception, another exception occurred:                                                                                                                                     
                                                                                                                                                                                                                   
           Traceback (most recent call last):                                                                                                                                                                      
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 124, in simple_cli                                                                                                         
               falcon_instance = compile_project(source_dir)                                                                                                                                                       
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 103, in compile_project                                                                                                    
               return falcon.Falcon(abs_path)                                                                                                                                                                      
             File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/.venv/lib/python3.10/site-packages/falcon/falcon.py", line 94, in __init__                                                                     
               raise FalconError(f"Invalid compilation: \n{str(e)}")                                                                                                                                               
           falcon.exceptions.FalconError: Invalid compilation:                                                                                                                                                     
           Compilation failed. Can you run build command?                                                                                                                                                          
           /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/artifacts/build-info is not a directory.                                                   
                                                                                                                                                                                                                   
           Compile failed.                                                                                                                                                                             tasks.py:127
           Since the compilation is failed, some static analysis tool may not be enabled, which may cause lower precision and recall.                                                                  tasks.py:128
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve transfering token from an address different from message sender                                                                                                                              │
│ Code:                                                                                                                                                                                                           │
│   function transferFrom(                                                                                                                                                                                        │
│     address sender,                                                                                                                                                                                             │
│     address recipient,                                                                                                                                                                                          │
│     uint256 amount                                                                                                                                                                                              │
│   ) public override returns (bool) {                                                                                                                                                                            │
│     if (recipient == longShort && msg.sender == longShort) {                                                                                                                                                    │
│       super._transfer(sender, recipient, amount);                                                                                                                                                               │
│       return true;                                                                                                                                                                                              │
│     } else {                                                                                                                                                                                                    │
│       return super.transferFrom(sender, recipient, amount);                                                                                                                                                     │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                    │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve transfering token from an address different from message sender and there is no check of allowance/approval from the address owner                                                           │
│ Code:                                                                                                                                                                                                           │
│   function transferFrom(                                                                                                                                                                                        │
│     address sender,                                                                                                                                                                                             │
│     address recipient,                                                                                                                                                                                          │
│     uint256 amount                                                                                                                                                                                              │
│   ) public override returns (bool) {                                                                                                                                                                            │
│     if (recipient == longShort && msg.sender == longShort) {                                                                                                                                                    │
│       super._transfer(sender, recipient, amount);                                                                                                                                                               │
│       return true;                                                                                                                                                                                              │
│     } else {                                                                                                                                                                                                    │
│       return super.transferFrom(sender, recipient, amount);                                                                                                                                                     │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: involve transfering token from an address different from message sender                                                                                                                              │
│ Code:                                                                                                                                                                                                           │
│   function transferPaymentTokensToUser(address user, uint256 amount) external override longShortOnly {                                                                                                          │
│     try paymentToken.transfer(user, amount) returns (bool transferSuccess) {                                                                                                                                    │
│       if (transferSuccess) {                                                                                                                                                                                    │
│         // If the transfer is successful return early, otherwise try pay the user out with the amountReservedInCaseOfInsufficientAaveLiquidity                                                                  │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│     } catch {}                                                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     amountReservedInCaseOfInsufficientAaveLiquidity -= amount;                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     // If this reverts (ie aave unable to make payout), then the whole transaction will revent. User will have to wait until sufficient liquidity available.                                                    │
│     lendingPool.withdraw(address(paymentToken), amount, user);                                                                                                                                                  │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                    │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                │
│ Code:                                                                                                                                                                                                           │
│   function distributeYieldForTreasuryAndReturnMarketAllocation(                                                                                                                                                 │
│     uint256 totalValueRealizedForMarket,                                                                                                                                                                        │
│     uint256 treasuryYieldPercent_e18                                                                                                                                                                            │
│   ) external override longShortOnly returns (uint256) {                                                                                                                                                         │
│     uint256 totalHeld = aToken.balanceOf(address(this));                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│     uint256 totalRealized = totalValueRealizedForMarket +                                                                                                                                                       │
│       totalReservedForTreasury +                                                                                                                                                                                │
│       amountReservedInCaseOfInsufficientAaveLiquidity;                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     if (totalRealized == totalHeld) {                                                                                                                                                                           │
│       return 0;                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // will revert in case totalRealized > totalHeld which should be never.                                                                                                                                     │
│     uint256 unrealizedYield = totalHeld - totalRealized;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│     uint256 amountForTreasury = (unrealizedYield * treasuryYieldPercent_e18) / 1e18;                                                                                                                            │
│     uint256 amountForMarketIncentives = unrealizedYield - amountForTreasury;                                                                                                                                    │
│                                                                                                                                                                                                                 │
│     totalReservedForTreasury += amountForTreasury;                                                                                                                                                              │
│                                                                                                                                                                                                                 │
│     emit YieldDistributed(unrealizedYield, treasuryYieldPercent_e18);                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     return amountForMarketIncentives;                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                          │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                    │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                │
│ Code:                                                                                                                                                                                                           │
│   function _claimAndDistributeYieldThenRebalanceMarket(                                                                                                                                                         │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     int256 newAssetPrice,                                                                                                                                                                                       │
│     int256 oldAssetPrice                                                                                                                                                                                        │
│   ) internal virtual returns (uint256 longValue, uint256 shortValue) {                                                                                                                                          │
│     // Claiming and distributing the yield                                                                                                                                                                      │
│     longValue = marketSideValueInPaymentToken;                                                                                                                                                                  │
│     shortValue = marketSideValueInPaymentToken;                                                                                                                                                                 │
│     uint256 totalValueLockedInMarket = longValue + shortValue;                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     (bool isLongSideUnderbalanced, uint256 treasuryYieldPercent_e18) = _getYieldSplit(                                                                                                                          │
│       marketIndex,                                                                                                                                                                                              │
│       longValue,                                                                                                                                                                                                │
│       shortValue,                                                                                                                                                                                               │
│       totalValueLockedInMarket                                                                                                                                                                                  │
│     );                                                                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     uint256 marketAmount = IYieldManager(yieldManagers)                                                                                                                                                         │
│     .distributeYieldForTreasuryAndReturnMarketAllocation(totalValueLockedInMarket, treasuryYieldPercent_e18);                                                                                                   │
│                                                                                                                                                                                                                 │
│     if (marketAmount > 0) {                                                                                                                                                                                     │
│       if (isLongSideUnderbalanced) {                                                                                                                                                                            │
│         longValue += marketAmount;                                                                                                                                                                              │
│       } else {                                                                                                                                                                                                  │
│         shortValue += marketAmount;                                                                                                                                                                             │
│       }                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Adjusting value of long and short pool based on price movement                                                                                                                                           │
│     // The side/position with less liquidity has 100% percent exposure to the price movement.                                                                                                                   │
│     // The side/position with more liquidity will have exposure < 100% to the price movement.                                                                                                                   │
│     // I.e. Imagine $100 in longValue and $50 shortValue                                                                                                                                                        │
│     // long side would have $50/$100 = 50% exposure to price movements based on the liquidity imbalance.                                                                                                        │
│     // min(longValue, shortValue) = $50 , therefore if the price change was -10% then                                                                                                                           │
│     // $50 * 10% = $5 gained for short side and conversely $5 lost for long side.                                                                                                                               │
│     int256 underbalancedSideValue = int256(_getMin(longValue, shortValue));                                                                                                                                     │
│                                                                                                                                                                                                                 │
│     // See this equation in latex: https://gateway.pinata.cloud/ipfs/QmPeJ3SZdn1GfxqCD4GDYyWTJGPMSHkjPJaxrzk2qTTPSE                                                                                             │
│     // Interact with this equation: https://www.desmos.com/calculator/t8gr6j5vsq                                                                                                                                │
│     int256 valueChange = ((newAssetPrice - oldAssetPrice) * underbalancedSideValue) / oldAssetPrice;                                                                                                            │
│                                                                                                                                                                                                                 │
│     if (valueChange > 0) {                                                                                                                                                                                      │
│       longValue += uint256(valueChange);                                                                                                                                                                        │
│       shortValue -= uint256(valueChange);                                                                                                                                                                       │
│     } else {                                                                                                                                                                                                    │
│       longValue -= uint256(-valueChange);                                                                                                                                                                       │
│       shortValue += uint256(-valueChange);                                                                                                                                                                      │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function distributeYieldForTreasuryAndReturnMarketAllocation(                                                                                                                                                 │
│     uint256 totalValueRealizedForMarket,                                                                                                                                                                        │
│     uint256 treasuryYieldPercent_e18                                                                                                                                                                            │
│   ) external override longShortOnly returns (uint256) {                                                                                                                                                         │
│     uint256 totalHeld = aToken.balanceOf(address(this));                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│     uint256 totalRealized = totalValueRealizedForMarket +                                                                                                                                                       │
│       totalReservedForTreasury +                                                                                                                                                                                │
│       amountReservedInCaseOfInsufficientAaveLiquidity;                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     if (totalRealized == totalHeld) {                                                                                                                                                                           │
│       return 0;                                                                                                                                                                                                 │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // will revert in case totalRealized > totalHeld which should be never.                                                                                                                                     │
│     uint256 unrealizedYield = totalHeld - totalRealized;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│     uint256 amountForTreasury = (unrealizedYield * treasuryYieldPercent_e18) / 1e18;                                                                                                                            │
│     uint256 amountForMarketIncentives = unrealizedYield - amountForTreasury;                                                                                                                                    │
│                                                                                                                                                                                                                 │
│     totalReservedForTreasury += amountForTreasury;                                                                                                                                                              │
│                                                                                                                                                                                                                 │
│     emit YieldDistributed(unrealizedYield, treasuryYieldPercent_e18);                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     return amountForMarketIncentives;                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No", "2": "No"}                                                                                                                                                                                          │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                               │
│ Code:                                                                                                                                                                                                           │
│   function _getYieldSplit(                                                                                                                                                                                      │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 longValue,                                                                                                                                                                                          │
│     uint256 shortValue,                                                                                                                                                                                         │
│     uint256 totalValueLockedInMarket                                                                                                                                                                            │
│   ) internal view virtual returns (bool isLongSideUnderbalanced, uint256 treasuryYieldPercent_e18) {                                                                                                            │
│     isLongSideUnderbalanced = longValue < shortValue;                                                                                                                                                           │
│     uint256 imbalance;                                                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     if (isLongSideUnderbalanced) {                                                                                                                                                                              │
│       imbalance = shortValue - longValue;                                                                                                                                                                       │
│     } else {                                                                                                                                                                                                    │
│       imbalance = longValue - shortValue;                                                                                                                                                                       │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // marketTreasurySplitGradient_e18 may be adjusted to ensure yield is given                                                                                                                                 │
│     // to the market at a desired rate e.g. if a market tends to become imbalanced                                                                                                                              │
│     // frequently then the gradient can be increased to funnel yield to the market                                                                                                                              │
│     // quicker.                                                                                                                                                                                                 │
│     // See this equation in latex: https://gateway.pinata.cloud/ipfs/QmXsW4cHtxpJ5BFwRcMSUw7s5G11Qkte13NTEfPLTKEx4x                                                                                             │
│     // Interact with this equation: https://www.desmos.com/calculator/pnl43tfv5b                                                                                                                                │
│     uint256 marketPercentCalculated_e18 = (imbalance * marketTreasurySplitGradient_e18) /                                                                                                                       │
│       totalValueLockedInMarket;                                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     uint256 marketPercent_e18 = _getMin(marketPercentCalculated_e18, 1e18);                                                                                                                                     │
│                                                                                                                                                                                                                 │
│     treasuryYieldPercent_e18 = 1e18 - marketPercent_e18;                                                                                                                                                        │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                     │
│ Code:                                                                                                                                                                                                           │
│   function _claimAndDistributeYieldThenRebalanceMarket(                                                                                                                                                         │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     int256 newAssetPrice,                                                                                                                                                                                       │
│     int256 oldAssetPrice                                                                                                                                                                                        │
│   ) internal virtual returns (uint256 longValue, uint256 shortValue) {                                                                                                                                          │
│     // Claiming and distributing the yield                                                                                                                                                                      │
│     longValue = marketSideValueInPaymentToken;                                                                                                                                                                  │
│     shortValue = marketSideValueInPaymentToken;                                                                                                                                                                 │
│     uint256 totalValueLockedInMarket = longValue + shortValue;                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     (bool isLongSideUnderbalanced, uint256 treasuryYieldPercent_e18) = _getYieldSplit(                                                                                                                          │
│       marketIndex,                                                                                                                                                                                              │
│       longValue,                                                                                                                                                                                                │
│       shortValue,                                                                                                                                                                                               │
│       totalValueLockedInMarket                                                                                                                                                                                  │
│     );                                                                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     uint256 marketAmount = IYieldManager(yieldManagers)                                                                                                                                                         │
│     .distributeYieldForTreasuryAndReturnMarketAllocation(totalValueLockedInMarket, treasuryYieldPercent_e18);                                                                                                   │
│                                                                                                                                                                                                                 │
│     if (marketAmount > 0) {                                                                                                                                                                                     │
│       if (isLongSideUnderbalanced) {                                                                                                                                                                            │
│         longValue += marketAmount;                                                                                                                                                                              │
│       } else {                                                                                                                                                                                                  │
│         shortValue += marketAmount;                                                                                                                                                                             │
│       }                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Adjusting value of long and short pool based on price movement                                                                                                                                           │
│     // The side/position with less liquidity has 100% percent exposure to the price movement.                                                                                                                   │
│     // The side/position with more liquidity will have exposure < 100% to the price movement.                                                                                                                   │
│     // I.e. Imagine $100 in longValue and $50 shortValue                                                                                                                                                        │
│     // long side would have $50/$100 = 50% exposure to price movements based on the liquidity imbalance.                                                                                                        │
│     // min(longValue, shortValue) = $50 , therefore if the price change was -10% then                                                                                                                           │
│     // $50 * 10% = $5 gained for short side and conversely $5 lost for long side.                                                                                                                               │
│     int256 underbalancedSideValue = int256(_getMin(longValue, shortValue));                                                                                                                                     │
│                                                                                                                                                                                                                 │
│     // See this equation in latex: https://gateway.pinata.cloud/ipfs/QmPeJ3SZdn1GfxqCD4GDYyWTJGPMSHkjPJaxrzk2qTTPSE                                                                                             │
│     // Interact with this equation: https://www.desmos.com/calculator/t8gr6j5vsq                                                                                                                                │
│     int256 valueChange = ((newAssetPrice - oldAssetPrice) * underbalancedSideValue) / oldAssetPrice;                                                                                                            │
│                                                                                                                                                                                                                 │
│     if (valueChange > 0) {                                                                                                                                                                                      │
│       longValue += uint256(valueChange);                                                                                                                                                                        │
│       shortValue -= uint256(valueChange);                                                                                                                                                                       │
│     } else {                                                                                                                                                                                                    │
│       longValue -= uint256(-valueChange);                                                                                                                                                                       │
│       shortValue += uint256(-valueChange);                                                                                                                                                                      │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share                                                                                                                                                     │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _claimAndDistributeYieldThenRebalanceMarket(                                                                                                                                                         │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     int256 newAssetPrice,                                                                                                                                                                                       │
│     int256 oldAssetPrice                                                                                                                                                                                        │
│   ) internal virtual returns (uint256 longValue, uint256 shortValue) {                                                                                                                                          │
│     // Claiming and distributing the yield                                                                                                                                                                      │
│     longValue = marketSideValueInPaymentToken;                                                                                                                                                                  │
│     shortValue = marketSideValueInPaymentToken;                                                                                                                                                                 │
│     uint256 totalValueLockedInMarket = longValue + shortValue;                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     (bool isLongSideUnderbalanced, uint256 treasuryYieldPercent_e18) = _getYieldSplit(                                                                                                                          │
│       marketIndex,                                                                                                                                                                                              │
│       longValue,                                                                                                                                                                                                │
│       shortValue,                                                                                                                                                                                               │
│       totalValueLockedInMarket                                                                                                                                                                                  │
│     );                                                                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     uint256 marketAmount = IYieldManager(yieldManagers)                                                                                                                                                         │
│     .distributeYieldForTreasuryAndReturnMarketAllocation(totalValueLockedInMarket, treasuryYieldPercent_e18);                                                                                                   │
│                                                                                                                                                                                                                 │
│     if (marketAmount > 0) {                                                                                                                                                                                     │
│       if (isLongSideUnderbalanced) {                                                                                                                                                                            │
│         longValue += marketAmount;                                                                                                                                                                              │
│       } else {                                                                                                                                                                                                  │
│         shortValue += marketAmount;                                                                                                                                                                             │
│       }                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Adjusting value of long and short pool based on price movement                                                                                                                                           │
│     // The side/position with less liquidity has 100% percent exposure to the price movement.                                                                                                                   │
│     // The side/position with more liquidity will have exposure < 100% to the price movement.                                                                                                                   │
│     // I.e. Imagine $100 in longValue and $50 shortValue                                                                                                                                                        │
│     // long side would have $50/$100 = 50% exposure to price movements based on the liquidity imbalance.                                                                                                        │
│     // min(longValue, shortValue) = $50 , therefore if the price change was -10% then                                                                                                                           │
│     // $50 * 10% = $5 gained for short side and conversely $5 lost for long side.                                                                                                                               │
│     int256 underbalancedSideValue = int256(_getMin(longValue, shortValue));                                                                                                                                     │
│                                                                                                                                                                                                                 │
│     // See this equation in latex: https://gateway.pinata.cloud/ipfs/QmPeJ3SZdn1GfxqCD4GDYyWTJGPMSHkjPJaxrzk2qTTPSE                                                                                             │
│     // Interact with this equation: https://www.desmos.com/calculator/t8gr6j5vsq                                                                                                                                │
│     int256 valueChange = ((newAssetPrice - oldAssetPrice) * underbalancedSideValue) / oldAssetPrice;                                                                                                            │
│                                                                                                                                                                                                                 │
│     if (valueChange > 0) {                                                                                                                                                                                      │
│       longValue += uint256(valueChange);                                                                                                                                                                        │
│       shortValue -= uint256(valueChange);                                                                                                                                                                       │
│     } else {                                                                                                                                                                                                    │
│       longValue -= uint256(-valueChange);                                                                                                                                                                       │
│       shortValue += uint256(-valueChange);                                                                                                                                                                      │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                    │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                               │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _claimAndDistributeYieldThenRebalanceMarket(                                                                                                                                                         │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     int256 newAssetPrice,                                                                                                                                                                                       │
│     int256 oldAssetPrice                                                                                                                                                                                        │
│   ) internal virtual returns (uint256 longValue, uint256 shortValue) {                                                                                                                                          │
│     // Claiming and distributing the yield                                                                                                                                                                      │
│     longValue = marketSideValueInPaymentToken;                                                                                                                                                                  │
│     shortValue = marketSideValueInPaymentToken;                                                                                                                                                                 │
│     uint256 totalValueLockedInMarket = longValue + shortValue;                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     (bool isLongSideUnderbalanced, uint256 treasuryYieldPercent_e18) = _getYieldSplit(                                                                                                                          │
│       marketIndex,                                                                                                                                                                                              │
│       longValue,                                                                                                                                                                                                │
│       shortValue,                                                                                                                                                                                               │
│       totalValueLockedInMarket                                                                                                                                                                                  │
│     );                                                                                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     uint256 marketAmount = IYieldManager(yieldManagers)                                                                                                                                                         │
│     .distributeYieldForTreasuryAndReturnMarketAllocation(totalValueLockedInMarket, treasuryYieldPercent_e18);                                                                                                   │
│                                                                                                                                                                                                                 │
│     if (marketAmount > 0) {                                                                                                                                                                                     │
│       if (isLongSideUnderbalanced) {                                                                                                                                                                            │
│         longValue += marketAmount;                                                                                                                                                                              │
│       } else {                                                                                                                                                                                                  │
│         shortValue += marketAmount;                                                                                                                                                                             │
│       }                                                                                                                                                                                                         │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Adjusting value of long and short pool based on price movement                                                                                                                                           │
│     // The side/position with less liquidity has 100% percent exposure to the price movement.                                                                                                                   │
│     // The side/position with more liquidity will have exposure < 100% to the price movement.                                                                                                                   │
│     // I.e. Imagine $100 in longValue and $50 shortValue                                                                                                                                                        │
│     // long side would have $50/$100 = 50% exposure to price movements based on the liquidity imbalance.                                                                                                        │
│     // min(longValue, shortValue) = $50 , therefore if the price change was -10% then                                                                                                                           │
│     // $50 * 10% = $5 gained for short side and conversely $5 lost for long side.                                                                                                                               │
│     int256 underbalancedSideValue = int256(_getMin(longValue, shortValue));                                                                                                                                     │
│                                                                                                                                                                                                                 │
│     // See this equation in latex: https://gateway.pinata.cloud/ipfs/QmPeJ3SZdn1GfxqCD4GDYyWTJGPMSHkjPJaxrzk2qTTPSE                                                                                             │
│     // Interact with this equation: https://www.desmos.com/calculator/t8gr6j5vsq                                                                                                                                │
│     int256 valueChange = ((newAssetPrice - oldAssetPrice) * underbalancedSideValue) / oldAssetPrice;                                                                                                            │
│                                                                                                                                                                                                                 │
│     if (valueChange > 0) {                                                                                                                                                                                      │
│       longValue += uint256(valueChange);                                                                                                                                                                        │
│       shortValue -= uint256(valueChange);                                                                                                                                                                       │
│     } else {                                                                                                                                                                                                    │
│       longValue -= uint256(-valueChange);                                                                                                                                                                       │
│       shortValue += uint256(-valueChange);                                                                                                                                                                      │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                    │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "Yes"}                                                                                                                                                                                        │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation          │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                               │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                    │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                │
│ Code:                                                                                                                                                                                                           │
│   function updateSystemStateMulti(uint32[] calldata marketIndexes) external override {                                                                                                                          │
│     for (uint256 i = 0; i < marketIndexes.length; i++) {                                                                                                                                                        │
│       _updateSystemStateInternal(marketIndexes);                                                                                                                                                                │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "Yes"}                                                                                                                                                                                        │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation          │
│ Code:                                                                                                                                                                                                           │
│   function updateSystemStateMulti(uint32[] calldata marketIndexes) external override {                                                                                                                          │
│     for (uint256 i = 0; i < marketIndexes.length; i++) {                                                                                                                                                        │
│       _updateSystemStateInternal(marketIndexes);                                                                                                                                                                │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                               │
│ Code:                                                                                                                                                                                                           │
│   function updateSystemStateMulti(uint32[] calldata marketIndexes) external override {                                                                                                                          │
│     for (uint256 i = 0; i < marketIndexes.length; i++) {                                                                                                                                                        │
│       _updateSystemStateInternal(marketIndexes);                                                                                                                                                                │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                    │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                │
│ Code:                                                                                                                                                                                                           │
│   function _batchConfirmOutstandingPendingActions(                                                                                                                                                              │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                           │
│     uint256 syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                           │
│   )                                                                                                                                                                                                             │
│     internal                                                                                                                                                                                                    │
│     virtual                                                                                                                                                                                                     │
│     returns (int256 long_changeInMarketValue_inPaymentToken, int256 short_changeInMarketValue_inPaymentToken)                                                                                                   │
│   {                                                                                                                                                                                                             │
│     int256 changeInSupply_syntheticToken_long;                                                                                                                                                                  │
│     int256 changeInSupply_syntheticToken_short;                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     // NOTE: the only reason we are re-uising amountForCurrentAction_workingVariable for all actions (redeemLong, redeemShort, mintLong, mintShort, shiftFromLong, shiftFromShort) is to reduce stack usage     │
│     uint256 amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                        │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits LONG                                                                                                                                                                             │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                 │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long = int256(                                                                                                                                                              │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                              │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits SHORT                                                                                                                                                                            │
│     amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                                │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short = int256(                                                                                                                                                             │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                             │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from LONG to SHORT                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide;                                                                                                           │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToShort = int256(                                                                                                                                                   │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       long_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToShort;                                                                                                                        │
│       short_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToShort;                                                                                                                       │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│       changeInSupply_syntheticToken_short += int256(                                                                                                                                                            │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                             │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from SHORT to LONG                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide[                                                                                                           │
│       false                                                                                                                                                                                                     │
│     ];                                                                                                                                                                                                          │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToLong = int256(                                                                                                                                                    │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       short_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToLong;                                                                                                                        │
│       long_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToLong;                                                                                                                         │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│       changeInSupply_syntheticToken_long += int256(                                                                                                                                                             │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           syntheticTokenPrice_inPaymentTokens_long                                                                                                                                                              │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems LONG                                                                                                                                                                              │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                        │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems SHORT                                                                                                                                                                             │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                       │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Batch settle payment tokens                                                                                                                                                                              │
│     _handleTotalPaymentTokenValueChangeForMarketWithYieldManager(                                                                                                                                               │
│       marketIndex,                                                                                                                                                                                              │
│       long_changeInMarketValue_inPaymentToken + short_changeInMarketValue_inPaymentToken                                                                                                                        │
│     );                                                                                                                                                                                                          │
│     // Batch settle synthetic tokens                                                                                                                                                                            │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, true, changeInSupply_syntheticToken_long);                                                                                                           │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, false, changeInSupply_syntheticToken_short);                                                                                                         │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "Yes"}                                                                                                                                                                                        │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation          │
│ Code:                                                                                                                                                                                                           │
│   function _batchConfirmOutstandingPendingActions(                                                                                                                                                              │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                           │
│     uint256 syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                           │
│   )                                                                                                                                                                                                             │
│     internal                                                                                                                                                                                                    │
│     virtual                                                                                                                                                                                                     │
│     returns (int256 long_changeInMarketValue_inPaymentToken, int256 short_changeInMarketValue_inPaymentToken)                                                                                                   │
│   {                                                                                                                                                                                                             │
│     int256 changeInSupply_syntheticToken_long;                                                                                                                                                                  │
│     int256 changeInSupply_syntheticToken_short;                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     // NOTE: the only reason we are re-uising amountForCurrentAction_workingVariable for all actions (redeemLong, redeemShort, mintLong, mintShort, shiftFromLong, shiftFromShort) is to reduce stack usage     │
│     uint256 amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                        │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits LONG                                                                                                                                                                             │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                 │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long = int256(                                                                                                                                                              │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                              │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits SHORT                                                                                                                                                                            │
│     amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                                │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short = int256(                                                                                                                                                             │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                             │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from LONG to SHORT                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide;                                                                                                           │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToShort = int256(                                                                                                                                                   │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       long_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToShort;                                                                                                                        │
│       short_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToShort;                                                                                                                       │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│       changeInSupply_syntheticToken_short += int256(                                                                                                                                                            │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                             │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from SHORT to LONG                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide[                                                                                                           │
│       false                                                                                                                                                                                                     │
│     ];                                                                                                                                                                                                          │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToLong = int256(                                                                                                                                                    │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       short_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToLong;                                                                                                                        │
│       long_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToLong;                                                                                                                         │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│       changeInSupply_syntheticToken_long += int256(                                                                                                                                                             │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           syntheticTokenPrice_inPaymentTokens_long                                                                                                                                                              │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems LONG                                                                                                                                                                              │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                        │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems SHORT                                                                                                                                                                             │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                       │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Batch settle payment tokens                                                                                                                                                                              │
│     _handleTotalPaymentTokenValueChangeForMarketWithYieldManager(                                                                                                                                               │
│       marketIndex,                                                                                                                                                                                              │
│       long_changeInMarketValue_inPaymentToken + short_changeInMarketValue_inPaymentToken                                                                                                                        │
│     );                                                                                                                                                                                                          │
│     // Batch settle synthetic tokens                                                                                                                                                                            │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, true, changeInSupply_syntheticToken_long);                                                                                                           │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, false, changeInSupply_syntheticToken_short);                                                                                                         │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                               │
│ Code:                                                                                                                                                                                                           │
│   function _batchConfirmOutstandingPendingActions(                                                                                                                                                              │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                           │
│     uint256 syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                           │
│   )                                                                                                                                                                                                             │
│     internal                                                                                                                                                                                                    │
│     virtual                                                                                                                                                                                                     │
│     returns (int256 long_changeInMarketValue_inPaymentToken, int256 short_changeInMarketValue_inPaymentToken)                                                                                                   │
│   {                                                                                                                                                                                                             │
│     int256 changeInSupply_syntheticToken_long;                                                                                                                                                                  │
│     int256 changeInSupply_syntheticToken_short;                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     // NOTE: the only reason we are re-uising amountForCurrentAction_workingVariable for all actions (redeemLong, redeemShort, mintLong, mintShort, shiftFromLong, shiftFromShort) is to reduce stack usage     │
│     uint256 amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                        │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits LONG                                                                                                                                                                             │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                 │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long = int256(                                                                                                                                                              │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                              │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits SHORT                                                                                                                                                                            │
│     amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                                │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short = int256(                                                                                                                                                             │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                             │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from LONG to SHORT                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide;                                                                                                           │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToShort = int256(                                                                                                                                                   │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       long_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToShort;                                                                                                                        │
│       short_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToShort;                                                                                                                       │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│       changeInSupply_syntheticToken_short += int256(                                                                                                                                                            │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                             │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from SHORT to LONG                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide[                                                                                                           │
│       false                                                                                                                                                                                                     │
│     ];                                                                                                                                                                                                          │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToLong = int256(                                                                                                                                                    │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       short_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToLong;                                                                                                                        │
│       long_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToLong;                                                                                                                         │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│       changeInSupply_syntheticToken_long += int256(                                                                                                                                                             │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           syntheticTokenPrice_inPaymentTokens_long                                                                                                                                                              │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems LONG                                                                                                                                                                              │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                        │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems SHORT                                                                                                                                                                             │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                       │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Batch settle payment tokens                                                                                                                                                                              │
│     _handleTotalPaymentTokenValueChangeForMarketWithYieldManager(                                                                                                                                               │
│       marketIndex,                                                                                                                                                                                              │
│       long_changeInMarketValue_inPaymentToken + short_changeInMarketValue_inPaymentToken                                                                                                                        │
│     );                                                                                                                                                                                                          │
│     // Batch settle synthetic tokens                                                                                                                                                                            │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, true, changeInSupply_syntheticToken_long);                                                                                                           │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, false, changeInSupply_syntheticToken_short);                                                                                                         │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price                                                                                                                                    │
│ deposit/mint/add the liquidity pool/amount/share                                                                                                                                                                │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _batchConfirmOutstandingPendingActions(                                                                                                                                                              │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                           │
│     uint256 syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                           │
│   )                                                                                                                                                                                                             │
│     internal                                                                                                                                                                                                    │
│     virtual                                                                                                                                                                                                     │
│     returns (int256 long_changeInMarketValue_inPaymentToken, int256 short_changeInMarketValue_inPaymentToken)                                                                                                   │
│   {                                                                                                                                                                                                             │
│     int256 changeInSupply_syntheticToken_long;                                                                                                                                                                  │
│     int256 changeInSupply_syntheticToken_short;                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     // NOTE: the only reason we are re-uising amountForCurrentAction_workingVariable for all actions (redeemLong, redeemShort, mintLong, mintShort, shiftFromLong, shiftFromShort) is to reduce stack usage     │
│     uint256 amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                        │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits LONG                                                                                                                                                                             │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                 │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long = int256(                                                                                                                                                              │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                              │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits SHORT                                                                                                                                                                            │
│     amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                                │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short = int256(                                                                                                                                                             │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                             │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from LONG to SHORT                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide;                                                                                                           │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToShort = int256(                                                                                                                                                   │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       long_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToShort;                                                                                                                        │
│       short_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToShort;                                                                                                                       │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│       changeInSupply_syntheticToken_short += int256(                                                                                                                                                            │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                             │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from SHORT to LONG                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide[                                                                                                           │
│       false                                                                                                                                                                                                     │
│     ];                                                                                                                                                                                                          │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToLong = int256(                                                                                                                                                    │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       short_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToLong;                                                                                                                        │
│       long_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToLong;                                                                                                                         │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│       changeInSupply_syntheticToken_long += int256(                                                                                                                                                             │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           syntheticTokenPrice_inPaymentTokens_long                                                                                                                                                              │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems LONG                                                                                                                                                                              │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                        │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems SHORT                                                                                                                                                                             │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                       │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Batch settle payment tokens                                                                                                                                                                              │
│     _handleTotalPaymentTokenValueChangeForMarketWithYieldManager(                                                                                                                                               │
│       marketIndex,                                                                                                                                                                                              │
│       long_changeInMarketValue_inPaymentToken + short_changeInMarketValue_inPaymentToken                                                                                                                        │
│     );                                                                                                                                                                                                          │
│     // Batch settle synthetic tokens                                                                                                                                                                            │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, true, changeInSupply_syntheticToken_long);                                                                                                           │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, false, changeInSupply_syntheticToken_short);                                                                                                         │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes", "2": "Yes"}                                                                                                                                                                                        │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have code statements that get or calculate LP token's value/price based on the market reserves/AMMprice/exchangeRate OR the custom token balanceOf/totalSupply/amount/liquidity calculation          │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _batchConfirmOutstandingPendingActions(                                                                                                                                                              │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                           │
│     uint256 syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                           │
│   )                                                                                                                                                                                                             │
│     internal                                                                                                                                                                                                    │
│     virtual                                                                                                                                                                                                     │
│     returns (int256 long_changeInMarketValue_inPaymentToken, int256 short_changeInMarketValue_inPaymentToken)                                                                                                   │
│   {                                                                                                                                                                                                             │
│     int256 changeInSupply_syntheticToken_long;                                                                                                                                                                  │
│     int256 changeInSupply_syntheticToken_short;                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     // NOTE: the only reason we are re-uising amountForCurrentAction_workingVariable for all actions (redeemLong, redeemShort, mintLong, mintShort, shiftFromLong, shiftFromShort) is to reduce stack usage     │
│     uint256 amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                        │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits LONG                                                                                                                                                                             │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                 │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long = int256(                                                                                                                                                              │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                              │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits SHORT                                                                                                                                                                            │
│     amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                                │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short = int256(                                                                                                                                                             │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                             │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from LONG to SHORT                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide;                                                                                                           │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToShort = int256(                                                                                                                                                   │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       long_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToShort;                                                                                                                        │
│       short_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToShort;                                                                                                                       │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│       changeInSupply_syntheticToken_short += int256(                                                                                                                                                            │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                             │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from SHORT to LONG                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide[                                                                                                           │
│       false                                                                                                                                                                                                     │
│     ];                                                                                                                                                                                                          │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToLong = int256(                                                                                                                                                    │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       short_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToLong;                                                                                                                        │
│       long_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToLong;                                                                                                                         │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│       changeInSupply_syntheticToken_long += int256(                                                                                                                                                             │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           syntheticTokenPrice_inPaymentTokens_long                                                                                                                                                              │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems LONG                                                                                                                                                                              │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                        │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems SHORT                                                                                                                                                                             │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                       │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Batch settle payment tokens                                                                                                                                                                              │
│     _handleTotalPaymentTokenValueChangeForMarketWithYieldManager(                                                                                                                                               │
│       marketIndex,                                                                                                                                                                                              │
│       long_changeInMarketValue_inPaymentToken + short_changeInMarketValue_inPaymentToken                                                                                                                        │
│     );                                                                                                                                                                                                          │
│     // Batch settle synthetic tokens                                                                                                                                                                            │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, true, changeInSupply_syntheticToken_long);                                                                                                           │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, false, changeInSupply_syntheticToken_short);                                                                                                         │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: deposit/mint/add the liquidity pool/amount/share and set the total share to the number of first deposit when the supply/liquidity is 0                                                               │
│ Code:                                                                                                                                                                                                           │
│   function _updateSystemStateInternal(uint32 marketIndex) internal virtual requireMarketExists(marketIndex) {                                                                                                   │
│     // If a negative int is return this should fail.                                                                                                                                                            │
│     int256 newAssetPrice = IOracleManager(oracleManagers).updatePrice();                                                                                                                                        │
│     int256 oldAssetPrice = int256(assetPrice);                                                                                                                                                                  │
│                                                                                                                                                                                                                 │
│     bool assetPriceHasChanged = oldAssetPrice != newAssetPrice;                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     if (assetPriceHasChanged || msg.sender == staker) {                                                                                                                                                         │
│       uint256 syntheticTokenPrice_inPaymentTokens_long = syntheticToken_priceSnapshot[                                                                                                                          │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       uint256 syntheticTokenPrice_inPaymentTokens_short = syntheticToken_priceSnapshot[                                                                                                                         │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ];                                                                                                                                                                                                        │
│       // if there is a price change and the 'staker' contract has pending updates, push the stakers price snapshot index to the staker                                                                          │
│       // (so the staker can handle its internal accounting)                                                                                                                                                     │
│       if (                                                                                                                                                                                                      │
│         userNextPrice_currentUpdateIndex == marketUpdateIndex + 1 &&                                                                                                                                            │
│         assetPriceHasChanged                                                                                                                                                                                    │
│       ) {                                                                                                                                                                                                       │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           // This variable could allow users to do any next price actions in the future (not just synthetic side shifts)                                                                                        │
│           userNextPrice_currentUpdateIndex                                                                                                                                                                      │
│         );                                                                                                                                                                                                      │
│       } else {                                                                                                                                                                                                  │
│         IStaker(staker).pushUpdatedMarketPricesToUpdateFloatIssuanceCalculations(                                                                                                                               │
│           marketIndex,                                                                                                                                                                                          │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           marketSideValueInPaymentToken,                                                                                                                                                                        │
│           0                                                                                                                                                                                                     │
│         );                                                                                                                                                                                                      │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       // function will return here if the staker called this simply for the                                                                                                                                     │
│       // purpose of adding a state point required in staker.sol for our rewards calculation                                                                                                                     │
│       if (!assetPriceHasChanged) {                                                                                                                                                                              │
│         return;                                                                                                                                                                                                 │
│       }                                                                                                                                                                                                         │
│                                                                                                                                                                                                                 │
│       (uint256 newLongPoolValue, uint256 newShortPoolValue) = _claimAndDistributeYieldThenRebalanceMarket(                                                                                                      │
│         marketIndex,                                                                                                                                                                                            │
│         newAssetPrice,                                                                                                                                                                                          │
│         oldAssetPrice                                                                                                                                                                                           │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       syntheticTokenPrice_inPaymentTokens_long = _getSyntheticTokenPrice(                                                                                                                                       │
│         newLongPoolValue,                                                                                                                                                                                       │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│       syntheticTokenPrice_inPaymentTokens_short = _getSyntheticTokenPrice(                                                                                                                                      │
│         newShortPoolValue,                                                                                                                                                                                      │
│         ISyntheticToken(syntheticTokens).totalSupply()                                                                                                                                                          │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       assetPrice = uint256(newAssetPrice);                                                                                                                                                                      │
│       marketUpdateIndex += 1;                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_long;                                                                                                                                                             │
│                                                                                                                                                                                                                 │
│       syntheticToken_priceSnapshot[                                                                                                                                                                             │
│         marketUpdateIndex                                                                                                                                                                                       │
│       ] = syntheticTokenPrice_inPaymentTokens_short;                                                                                                                                                            │
│                                                                                                                                                                                                                 │
│       (                                                                                                                                                                                                         │
│         int256 long_changeInMarketValue_inPaymentToken,                                                                                                                                                         │
│         int256 short_changeInMarketValue_inPaymentToken                                                                                                                                                         │
│       ) = _batchConfirmOutstandingPendingActions(                                                                                                                                                               │
│         marketIndex,                                                                                                                                                                                            │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       newLongPoolValue = uint256(int256(newLongPoolValue) + long_changeInMarketValue_inPaymentToken);                                                                                                           │
│       newShortPoolValue = uint256(int256(newShortPoolValue) + short_changeInMarketValue_inPaymentToken);                                                                                                        │
│       marketSideValueInPaymentToken = newLongPoolValue;                                                                                                                                                         │
│       marketSideValueInPaymentToken = newShortPoolValue;                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       emit SystemStateUpdated(                                                                                                                                                                                  │
│         marketIndex,                                                                                                                                                                                            │
│         marketUpdateIndex,                                                                                                                                                                                      │
│         newAssetPrice,                                                                                                                                                                                          │
│         newLongPoolValue,                                                                                                                                                                                       │
│         newShortPoolValue,                                                                                                                                                                                      │
│         syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                               │
│         syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                               │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
│   function _batchConfirmOutstandingPendingActions(                                                                                                                                                              │
│     uint32 marketIndex,                                                                                                                                                                                         │
│     uint256 syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                           │
│     uint256 syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                           │
│   )                                                                                                                                                                                                             │
│     internal                                                                                                                                                                                                    │
│     virtual                                                                                                                                                                                                     │
│     returns (int256 long_changeInMarketValue_inPaymentToken, int256 short_changeInMarketValue_inPaymentToken)                                                                                                   │
│   {                                                                                                                                                                                                             │
│     int256 changeInSupply_syntheticToken_long;                                                                                                                                                                  │
│     int256 changeInSupply_syntheticToken_short;                                                                                                                                                                 │
│                                                                                                                                                                                                                 │
│     // NOTE: the only reason we are re-uising amountForCurrentAction_workingVariable for all actions (redeemLong, redeemShort, mintLong, mintShort, shiftFromLong, shiftFromShort) is to reduce stack usage     │
│     uint256 amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                        │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits LONG                                                                                                                                                                             │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                 │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long = int256(                                                                                                                                                              │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                              │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched deposits SHORT                                                                                                                                                                            │
│     amountForCurrentAction_workingVariable = batched_amountPaymentToken_deposit;                                                                                                                                │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken = int256(amountForCurrentAction_workingVariable);                                                                                                                │
│                                                                                                                                                                                                                 │
│       batched_amountPaymentToken_deposit = 0;                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short = int256(                                                                                                                                                             │
│         _getAmountSyntheticToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                             │
│       );                                                                                                                                                                                                        │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from LONG to SHORT                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide;                                                                                                           │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToShort = int256(                                                                                                                                                   │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       long_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToShort;                                                                                                                        │
│       short_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToShort;                                                                                                                       │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│       changeInSupply_syntheticToken_short += int256(                                                                                                                                                            │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_long,                                                                                                                                                             │
│           syntheticTokenPrice_inPaymentTokens_short                                                                                                                                                             │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle shift tokens from SHORT to LONG                                                                                                                                                                   │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_toShiftAwayFrom_marketSide[                                                                                                           │
│       false                                                                                                                                                                                                     │
│     ];                                                                                                                                                                                                          │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       int256 paymentTokenValueChangeForShiftToLong = int256(                                                                                                                                                    │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       short_changeInMarketValue_inPaymentToken -= paymentTokenValueChangeForShiftToLong;                                                                                                                        │
│       long_changeInMarketValue_inPaymentToken += paymentTokenValueChangeForShiftToLong;                                                                                                                         │
│                                                                                                                                                                                                                 │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│       changeInSupply_syntheticToken_long += int256(                                                                                                                                                             │
│         _getEquivalentAmountSyntheticTokensOnTargetSide(                                                                                                                                                        │
│           amountForCurrentAction_workingVariable,                                                                                                                                                               │
│           syntheticTokenPrice_inPaymentTokens_short,                                                                                                                                                            │
│           syntheticTokenPrice_inPaymentTokens_long                                                                                                                                                              │
│         )                                                                                                                                                                                                       │
│       );                                                                                                                                                                                                        │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_toShiftAwayFrom_marketSide = 0;                                                                                                                                              │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems LONG                                                                                                                                                                              │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       long_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                        │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_long)                                                                                                │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_long -= int256(amountForCurrentAction_workingVariable);                                                                                                                     │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Handle batched redeems SHORT                                                                                                                                                                             │
│     amountForCurrentAction_workingVariable = batched_amountSyntheticToken_redeem;                                                                                                                               │
│     if (amountForCurrentAction_workingVariable > 0) {                                                                                                                                                           │
│       short_changeInMarketValue_inPaymentToken -= int256(                                                                                                                                                       │
│         _getAmountPaymentToken(amountForCurrentAction_workingVariable, syntheticTokenPrice_inPaymentTokens_short)                                                                                               │
│       );                                                                                                                                                                                                        │
│       changeInSupply_syntheticToken_short -= int256(amountForCurrentAction_workingVariable);                                                                                                                    │
│                                                                                                                                                                                                                 │
│       batched_amountSyntheticToken_redeem = 0;                                                                                                                                                                  │
│     }                                                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     // Batch settle payment tokens                                                                                                                                                                              │
│     _handleTotalPaymentTokenValueChangeForMarketWithYieldManager(                                                                                                                                               │
│       marketIndex,                                                                                                                                                                                              │
│       long_changeInMarketValue_inPaymentToken + short_changeInMarketValue_inPaymentToken                                                                                                                        │
│     );                                                                                                                                                                                                          │
│     // Batch settle synthetic tokens                                                                                                                                                                            │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, true, changeInSupply_syntheticToken_long);                                                                                                           │
│     _handleChangeInSyntheticTokensTotalSupply(marketIndex, false, changeInSupply_syntheticToken_short);                                                                                                         │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ No                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                               │
│ Code:                                                                                                                                                                                                           │
│   function _getAssetPrices()                                                                                                                                                                                    │
│     internal                                                                                                                                                                                                    │
│     view                                                                                                                                                                                                        │
│     returns (                                                                                                                                                                                                   │
│       uint256,                                                                                                                                                                                                  │
│       uint256,                                                                                                                                                                                                  │
│       uint256                                                                                                                                                                                                   │
│     )                                                                                                                                                                                                           │
│   {                                                                                                                                                                                                             │
│     string[] memory baseSymbols = new string[](3);                                                                                                                                                              │
│     baseSymbols[0] = "TRX"; // tron                                                                                                                                                                             │
│     baseSymbols[1] = "EOS"; // eos                                                                                                                                                                              │
│     baseSymbols[2] = "XRP"; // ripple                                                                                                                                                                           │
│                                                                                                                                                                                                                 │
│     string[] memory quoteSymbols = new string[](3);                                                                                                                                                             │
│     quoteSymbols[0] = "BUSD";                                                                                                                                                                                   │
│     quoteSymbols[1] = "BUSD";                                                                                                                                                                                   │
│     quoteSymbols[2] = "BUSD";                                                                                                                                                                                   │
│                                                                                                                                                                                                                 │
│     IBandOracle.ReferenceData[] memory data = oracle.getReferenceDataBulk(baseSymbols, quoteSymbols);                                                                                                           │
│                                                                                                                                                                                                                 │
│     return (data[0].rate, data[1].rate, data[2].rate);                                                                                                                                                          │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                               │
│ Code:                                                                                                                                                                                                           │
│   function settle() public {                                                                                                                                                                                    │
│     uint256 totalYieldRate = yieldRate * (block.timestamp - lastSettled);                                                                                                                                       │
│     uint256 totalYield = (totalHeld * totalYieldRate) / TEN_TO_THE_18;                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     lastSettled = block.timestamp;                                                                                                                                                                              │
│     totalHeld = totalHeld + totalYield;                                                                                                                                                                         │
│     if (totalYield > 0) {                                                                                                                                                                                       │
│       token.mint(address(this), totalYield);                                                                                                                                                                    │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "Yes"}                                                                                                                                                                                                    │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────── Single Choice Scenario ─────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate, and have inside code statements that calculate/assign/distribute the balance/share/stake/fee/loan/reward                      │
│ Code:                                                                                                                                                                                                           │
│   function settle() public {                                                                                                                                                                                    │
│     uint256 totalYieldRate = yieldRate * (block.timestamp - lastSettled);                                                                                                                                       │
│     uint256 totalYield = (totalHeld * totalYieldRate) / TEN_TO_THE_18;                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     lastSettled = block.timestamp;                                                                                                                                                                              │
│     totalHeld = totalHeld + totalYield;                                                                                                                                                                         │
│     if (totalYield > 0) {                                                                                                                                                                                       │
│       token.mint(address(this), totalYield);                                                                                                                                                                    │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Yes                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────── Multiple Choice Scenarios ───────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: have inside code statements that update/accrue interest/exchange rate,                                                                                                                               │
│ Code:                                                                                                                                                                                                           │
│   function getReferenceData(string memory _base, string memory _quote)                                                                                                                                          │
│     external                                                                                                                                                                                                    │
│     view                                                                                                                                                                                                        │
│     override                                                                                                                                                                                                    │
│     returns (IBandOracle.ReferenceData memory ref)                                                                                                                                                              │
│   {                                                                                                                                                                                                             │
│     ref.lastUpdatedBase = block.timestamp;                                                                                                                                                                      │
│     ref.lastUpdatedQuote = block.timestamp;                                                                                                                                                                     │
│     ref.rate = pairRates[_base][_quote];                                                                                                                                                                        │
│     require(ref.rate > 0);                                                                                                                                                                                      │
│                                                                                                                                                                                                                 │
│     return ref;                                                                                                                                                                                                 │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"1": "No"}                                                                                                                                                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"newAssetPrice":"This variable holds the updated price of the asset from the oracle manager. It is used to check if the asset price has changed and to update the system state                    │
│ accordingly.","oldAssetPrice":"This variable holds the old price of the asset. It is used to check if the asset price has changed and to update the system state                                                │
│ accordingly.","syntheticTokenPrice_inPaymentTokens_long":"This variable holds the price of the synthetic token in payment tokens for the long position.","syntheticTokenPrice_inPaymentTokens_short":"This      │
│ variable holds the price of the synthetic token in payment tokens for the short position.","newLongPoolValue":"This variable holds the new value of the long pool after claiming and distributing yield and     │
│ rebalancing the market.","newShortPoolValue":"This variable holds the new value of the short pool after claiming and distributing yield and rebalancing the market."},                                          │
│ "VariableB":{"syntheticTokenPrice_inPaymentTokens_long":"This variable holds the calculated price of the LP token for the long position."}}                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 20:16:44] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                               tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/contracts/LongShort.sol, current        tasks.py:260
                             function: _updateSystemStateInternal, current vul: price-manipulation                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                 tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                       
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                  
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                      
                                                                                                                                                                                                                   
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"Variable name":"None","Description":"No variable or function in the provided code holds the market reserves/AMMprice/exchangeRate or the custom token balanceOf/totalSupply/amount/liquidity     │
│ calculation."}, "VariableB":{"Variable name":"None","Description":"No variable in the provided code holds the calculated value/price of LP token."}}                                                            │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 20:16:46] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                               tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/contracts/LongShort.sol, current        tasks.py:359
                             function: _updateSystemStateInternal, current vul: price-manipulation                                                                                                                 
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                 tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 310, in simple_cli                                                                                       
                                 raise Exception(                                                                                                                                                                  
                             Exception: The description of variable did not pass the validation                                                                                                                    
                                                                                                                                                                                                                   
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"syntheticTokenPrice_inPaymentTokens_long":"This variable holds the price of the synthetic token in payment tokens for long positions", "syntheticTokenPrice_inPaymentTokens_short":"This         │
│ variable holds the price of the synthetic token in payment tokens for short positions", "batched_amountPaymentToken_deposit":"This variable holds the batched deposit amount of payment tokens",                │
│ "batched_amountSyntheticToken_toShiftAwayFrom_marketSide":"This variable holds the batched amount of synthetic tokens to shift away from the market side", "batched_amountSyntheticToken_redeem":"This variable │
│ holds the batched amount of synthetic tokens to redeem"}, "VariableB":{"changeInSupply_syntheticToken_long":"This variable holds the calculated value of LP token for long positions",                          │
│ "changeInSupply_syntheticToken_short":"This variable holds the calculated value of LP token for short positions"}}                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 20:16:52] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                               tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/contracts/LongShort.sol, current        tasks.py:260
                             function: _batchConfirmOutstandingPendingActions, current vul: price-manipulation                                                                                                     
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                 tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                       
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                  
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                      
                                                                                                                                                                                                                   
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ {"VariableA":{"newAssetPrice":"This variable holds the updated price of the asset from the Oracle Manager. It is used to check if the asset price has changed and to calculate the new long and short pool      │
│ values.","oldAssetPrice":"This variable holds the old price of the asset. It is used to check if the asset price has changed and to calculate the new long and short pool                                       │
│ values.","syntheticTokenPrice_inPaymentTokens_long":"This variable holds the price of the synthetic token in payment tokens for the long side. It is updated after the market is                                │
│ rebalanced.","syntheticTokenPrice_inPaymentTokens_short":"This variable holds the price of the synthetic token in payment tokens for the short side. It is updated after the market is                          │
│ rebalanced.","newLongPoolValue":"This variable holds the new value of the long pool after yield is claimed, distributed, and the market is rebalanced.","newShortPoolValue":"This variable holds the new value  │
│ of the short pool after yield is claimed, distributed, and the market is rebalanced."}, "VariableB":{"syntheticTokenPrice_inPaymentTokens_long":"This variable holds the calculated price of the LP token for   │
│ the long side after the market is rebalanced.","syntheticTokenPrice_inPaymentTokens_short":"This variable holds the calculated price of the LP token for the short side after the market is rebalanced."}}      │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 20:17:09] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                               tasks.py:357
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/contracts/LongShort.sol, current        tasks.py:359
                             function: _batchConfirmOutstandingPendingActions, current vul: price-manipulation                                                                                                     
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                 tasks.py:361
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 355, in simple_cli                                                                                       
                                 falcon_instance, function2_text)                                                                                                                                                  
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                      
                                                                                                                                                                                                                   
╭───────────────────────────────────────────────────────────────────────────────────────────────── Current Step ──────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to update/accrue interest/exchange rate? Answer only ZERO or ONE statement, cover the code with backquotes.                    │
│ Code:                                                                                                                                                                                                           │
│   function settle() public {                                                                                                                                                                                    │
│     uint256 totalYieldRate = yieldRate * (block.timestamp - lastSettled);                                                                                                                                       │
│     uint256 totalYield = (totalHeld * totalYieldRate) / TEN_TO_THE_18;                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     lastSettled = block.timestamp;                                                                                                                                                                              │
│     totalHeld = totalHeld + totalYield;                                                                                                                                                                         │
│     if (totalYield > 0) {                                                                                                                                                                                       │
│       token.mint(address(this), totalYield);                                                                                                                                                                    │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ `uint256 totalYieldRate = yieldRate * (block.timestamp - lastSettled);`                                                                                                                                         │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────── Current Step ──────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Knowledge: In the given code, which inside code statement is the first statement to calculate/assign/distribute the balance/share/stake/fee/loan/reward? Answer only ZERO or ONE statement, cover the code with │
│ backquotes.                                                                                                                                                                                                     │
│ Code:                                                                                                                                                                                                           │
│   function settle() public {                                                                                                                                                                                    │
│     uint256 totalYieldRate = yieldRate * (block.timestamp - lastSettled);                                                                                                                                       │
│     uint256 totalYield = (totalHeld * totalYieldRate) / TEN_TO_THE_18;                                                                                                                                          │
│                                                                                                                                                                                                                 │
│     lastSettled = block.timestamp;                                                                                                                                                                              │
│     totalHeld = totalHeld + totalYield;                                                                                                                                                                         │
│     if (totalYield > 0) {                                                                                                                                                                                       │
│       token.mint(address(this), totalYield);                                                                                                                                                                    │
│     }                                                                                                                                                                                                           │
│   }                                                                                                                                                                                                             │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────────────────────────────────────────── Response ────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ `uint256 totalYieldRate = yieldRate * (block.timestamp - lastSettled);`                                                                                                                                         │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
[12/08/24 20:17:11] ERROR    tasks: Static analysis failed: Invalid args                                                                                                                               tasks.py:258
                    ERROR    tasks: Current File: /home/owen/Documents/GitHub/GPTScan-Bigger-Model/datasets/code-423n4-Web3Bugs-data/2021-08-floatcapital-main/contracts/mocks/YieldManagerMock.sol,   tasks.py:260
                             current function: settle, current vul: wrong-order-interest                                                                                                                           
                    ERROR    tasks: Traceback (most recent call last):                                                                                                                                 tasks.py:262
                               File "/home/owen/Documents/GitHub/GPTScan-Bigger-Model/src/tasks.py", line 254, in simple_cli                                                                                       
                                 res_1 = static_check.run_static_check(checker, args, function1, falcon_instance,                                                                                                  
                             UnboundLocalError: local variable 'falcon_instance' referenced before assignment                                                                                                      
                                                                                                                                                                                                                   
                      Scan Results                       
┏━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃ Type ┃ Description ┃ Affected Files ┃ Analysis Report ┃
┡━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
└──────┴─────────────┴────────────────┴─────────────────┘
                  Summary                   
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Key                  ┃ Value             ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ Files                │ 39                │
│ Contracts            │ 39                │
│ Functions            │ 69                │
│ Lines of Code        │ 5960              │
│ Used Time            │ 62.41939377784729 │
│ Estimated Cost (USD) │ 0.043812          │
└──────────────────────┴───────────────────┘
